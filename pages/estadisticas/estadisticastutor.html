<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas Tutor</title>
    <link rel="stylesheet" href="../../css/estadisticaTutor.css">
    <link rel="stylesheet" href="../../css/navbar.css">
</head>

<body>
    <header class="header">
        <div class="left-section">
            <h1 class="logo">SICALI</h1>
        </div>
        <div class="user-info">
            <div class="text-info">
                <div class="role">Tutor</div>
                <div class="name" id="userName">Cargando...</div>
            </div>
            <div class="avatar"><img src="../../img/nina.png" alt=""></div>
        </div>
    </header>
    
    <main class="content" id="content" style="width: 100%; margin-left: 0; padding: 20px;">
        <section class="statistics-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1 class="statistics-title" style="margin: 0;">Estad√≠sticas</h1>
                <button onclick="window.location.href='../bienvenidas/bienvenida Tutor.html'" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500;">
                    ‚Üê Volver
                </button>
            </div>
            <div class="filters">
                <div class="estudiante-info">
                    <div class="info-block">
                        <label>Estudiante</label>
                        <p id="estudianteNombre">Cargando...</p>
                    </div>

                    <div class="info-block">
                        <label>Grupo</label>
                        <p id="estudianteGrupo">-</p>
                    </div>
                </div>
                <div class="filter-group">
                    <label>Asignatura</label>
                    <div class="periodo-select">
                        <select id="asignaturaSelect">
                            <option value="" selected>Todas las asignaturas</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart">
                    <div class="y-axis">
                        <span class="y-label">10</span>
                        <span class="y-label">8</span>
                        <span class="y-label">6</span>
                        <span class="y-label">4</span>
                        <span class="y-label">2</span>
                        <span class="y-label">0</span>
                    </div>
                    <div class="grid-lines">
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                    </div>
                    
                    <div class="bars" id="chart-bars">
                        <div class="no-data">Cargando estad√≠sticas...</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="../../scripts/loadDependencies.js"></script>
    <script>
        // ==========================================
        // CONSTANTES Y UTILIDADES
        // ==========================================
        const CALIFICACION_MIN = 0;
        const CALIFICACION_MAX = 10;
        const CHART_MAX_HEIGHT = 200; // Altura m√°xima en p√≠xeles para la barra
        const SERVICE_TIMEOUT = 10000;  // Aumentado a 10 segundos para asegurar carga

        // Esperar a que los servicios est√©n disponibles
        function waitForServices(services, timeout = SERVICE_TIMEOUT) {
            return new Promise((resolve, reject) => {
                let resolved = false;
                
                const onDependenciesLoaded = () => {
                    if (resolved) return;
                    // Dar 100ms m√°s para que los servicios se ejecuten completamente
                    setTimeout(() => {
                        const allAvailable = services.every(service => typeof window[service] !== 'undefined');
                        if (allAvailable) {
                            if (!resolved) {
                                resolved = true;
                                window.removeEventListener('dependenciesLoaded', onDependenciesLoaded);
                                resolve();
                            }
                        }
                    }, 100);
                };
                
                window.addEventListener('dependenciesLoaded', onDependenciesLoaded);
                
                // Fallback: verificar manualmente con timeout
                const startTime = Date.now();
                const check = setInterval(() => {
                    if (resolved) {
                        clearInterval(check);
                        return;
                    }
                    
                    try {
                        const allAvailable = services.every(service => {
                            try {
                                return typeof eval(service) !== 'undefined';
                            } catch (e) {
                                return typeof window[service] !== 'undefined';
                            }
                        });
                        
                        if (allAvailable) {
                            resolved = true;
                            clearInterval(check);
                            window.removeEventListener('dependenciesLoaded', onDependenciesLoaded);
                            resolve();
                        } else if (Date.now() - startTime > timeout) {
                            resolved = true;
                            clearInterval(check);
                            window.removeEventListener('dependenciesLoaded', onDependenciesLoaded);
                            
                            const missing = services.filter(s => typeof window[s] === 'undefined');
                            console.error('‚ùå Servicios no disponibles:', missing);
                            console.log('‚úÖ Servicios disponibles:', Object.keys(window).filter(k => typeof window[k] === 'object' && window[k] && window[k].constructor.name.includes('Service')));
                            
                            reject(new Error('Timeout esperando servicios: ' + missing.join(', ')));
                        }
                    } catch (err) {
                        if (Date.now() - startTime > timeout && !resolved) {
                            resolved = true;
                            clearInterval(check);
                            window.removeEventListener('dependenciesLoaded', onDependenciesLoaded);
                            reject(err);
                        }
                    }
                }, 50);
            });
        }

        // Validar calificaci√≥n
        function validarCalificacion(valor) {
            if (valor === null || valor === undefined) return null;
            const num = parseFloat(valor);
            if (isNaN(num)) return null;
            return Math.max(CALIFICACION_MIN, Math.min(CALIFICACION_MAX, num));
        }

        // Calcular promedio seguro
        function calcularPromedio(valores) {
            const validos = valores.filter(v => v !== null && v !== undefined && !isNaN(v));
            if (validos.length === 0) return 0;
            const suma = validos.reduce((acc, val) => acc + val, 0);
            return suma / validos.length;
        }

        // Extraer ID de estudiante
        const getEstudianteId = (obj) => obj.idEstudiante || obj.estudiante?.id_usuario;

        // ==========================================
        // PROTECCI√ìN DE RUTAS
        // ==========================================
        (function() {
            function waitForRouteGuard(roles) {
                if (typeof RouteGuard !== 'undefined') {
                    RouteGuard.protect(roles);
                } else {
                    setTimeout(() => waitForRouteGuard(roles), 50);
                }
            }
            waitForRouteGuard([tutor, 'admin']);
        })();

        // ==========================================
        // CARGAR NOMBRE DEL TUTOR
        // ==========================================
        (function() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userName = document.getElementById('userName');
                
                if (currentUser.nombre && currentUser.ape_p) {
                    const fullName = `${currentUser.nombre} ${currentUser.ape_p} ${currentUser.ape_m || ''}`.trim();
                    userName.textContent = fullName;
                } else {
                    userName.textContent = 'Usuario';
                }
            } catch (error) {
                console.error('Error al cargar datos del usuario:', error);
                document.getElementById('userName').textContent = 'Usuario';
            }
        })();

        // ==========================================
        // CARGAR GR√ÅFICA DE CALIFICACIONES
        // ==========================================
        async function cargarGrafica(idEstudiante, idAsignatura = null) {
            try {
                console.log('=== INICIANDO cargarGrafica ===');
                console.log('Estudiante ID:', idEstudiante);
                console.log('Asignatura ID:', idAsignatura);
                console.log('calificacionesService disponible:', typeof calificacionesService !== 'undefined');
                console.log('httpClient disponible:', typeof httpClient !== 'undefined');

                let calificaciones = [];
                let asignaturas = [];

                // Obtener calificaciones del estudiante usando calificacionesService
                if (typeof calificacionesService !== 'undefined') {
                    try {
                        console.log('Llamando calificacionesService.getAll()...');
                        const allCalificaciones = await calificacionesService.getAll();
                        console.log('Respuesta de calificacionesService:', {
                            tipo: typeof allCalificaciones,
                            esArray: Array.isArray(allCalificaciones),
                            cantidad: Array.isArray(allCalificaciones) ? allCalificaciones.length : 'N/A',
                            datos: allCalificaciones
                        });
                        
                        calificaciones = allCalificaciones.filter(cal => 
                            Number(cal.idEstudiante) === Number(idEstudiante)
                        );
                        
                        console.log('Calificaciones filtradas:', {
                            cantidad: calificaciones.length,
                            datos: calificaciones
                        });
                    } catch (error) {
                        console.error('Error en calificacionesService.getAll():', error);
                    }
                } else {
                    console.warn('‚ö†Ô∏è calificacionesService NO est√° definido');
                }

                // Obtener asignaturas desde las calificaciones normalizadas
                // (ya incluyen nombreAsignatura desde el backend)
                if (calificaciones.length > 0) {
                    const asignaturasMap = {};
                    calificaciones.forEach(cal => {
                        if (cal.idAsignatura && cal.nombreAsignatura) {
                            if (!asignaturasMap[cal.idAsignatura]) {
                                asignaturasMap[cal.idAsignatura] = {
                                    idAsignatura: cal.idAsignatura,
                                    nombre: cal.nombreAsignatura
                                };
                            }
                        }
                    });
                    asignaturas = Object.values(asignaturasMap);
                    console.log('Asignaturas extra√≠das desde calificaciones:', asignaturas.length);
                }

                // Filtrar por asignatura si se especifica
                if (idAsignatura) {
                    calificaciones = calificaciones.filter(cal => 
                        Number(cal.idAsignatura) === Number(idAsignatura)
                    );
                    console.log('Calificaciones filtradas por asignatura:', calificaciones.length);
                }

                if (calificaciones.length === 0) {
                    console.warn('‚ùå Sin calificaciones registradas');
                    mostrarMensaje('No hay calificaciones registradas para este estudiante', 'info');
                    return;
                }

                console.log('‚úÖ Cargando gr√°fica con', calificaciones.length, 'calificaciones');

                // Calcular promedios por periodo y convertir a porcentaje
                const promediosPorPeriodo = {
                    1: { suma: 0, count: 0, porcentaje: 0 },
                    2: { suma: 0, count: 0, porcentaje: 0 },
                    3: { suma: 0, count: 0, porcentaje: 0 },
                    4: { suma: 0, count: 0, porcentaje: 0 }
                };

                calificaciones.forEach(calif => {
                    [1, 2, 3, 4].forEach(periodo => {
                        const valor = validarCalificacion(calif[`calificacion${periodo}`]);
                        if (valor !== null) {
                            promediosPorPeriodo[periodo].suma += valor;
                            promediosPorPeriodo[periodo].count++;
                        }
                    });
                });

                // Calcular promedios y porcentajes
                [1, 2, 3, 4].forEach(periodo => {
                    if (promediosPorPeriodo[periodo].count > 0) {
                        const promedio = promediosPorPeriodo[periodo].suma / promediosPorPeriodo[periodo].count;
                        // Convertir a porcentaje (escala 0-10 -> 0-100%)
                        promediosPorPeriodo[periodo].promedio = promedio;
                        promediosPorPeriodo[periodo].porcentaje = (promedio / 10) * 100;
                    }
                });

                // Cargar asignaturas en el select si no hay filtro
                if (!idAsignatura && asignaturas.length > 0) {
                    const select = document.getElementById('asignaturaSelect');
                    // Limpiar opciones previas (mantener "Todas")
                    const opcionesTodas = select.querySelector('option[value=""]');
                    select.innerHTML = '';
                    if (opcionesTodas) select.appendChild(opcionesTodas);

                    // Agregar solo asignaturas con calificaciones
                    const idsAsignaturasConCalificaciones = new Set(
                        calificaciones.map(cal => cal.idAsignatura)
                    );

                    asignaturas.forEach(asig => {
                        if (idsAsignaturasConCalificaciones.has(asig.idAsignatura)) {
                            const option = document.createElement('option');
                            option.value = asig.idAsignatura;
                            option.textContent = asig.nombre;
                            select.appendChild(option);
                        }
                    });

                    // Event listener para cambio de asignatura
                    select.addEventListener('change', (e) => {
                        const newIdAsignatura = e.target.value ? parseInt(e.target.value) : null;
                        cargarGrafica(idEstudiante, newIdAsignatura);
                    }, { once: true });
                }

                // Renderizar gr√°fica
                renderizarGrafica(promediosPorPeriodo);

            } catch (error) {
                console.error('Error cargando gr√°fica:', error);
                mostrarMensaje('Error al cargar datos de la gr√°fica: ' + error.message, 'error');
            }
        }

        // ==========================================
        // RENDERIZAR GR√ÅFICA
        // ==========================================
        function renderizarGrafica(promediosPorPeriodo) {
            const barsContainer = document.getElementById('chart-bars');
            barsContainer.innerHTML = '';

            const colores = ['color-1', 'color-2', 'color-3', 'color-4'];
            const labels = ['Periodo 1', 'Periodo 2', 'Periodo 3', 'Periodo 4'];

            let sumaTotal = 0;
            let countTotal = 0;

            [1, 2, 3, 4].forEach((periodo, index) => {
                const data = promediosPorPeriodo[periodo];
                
                if (data.count > 0) {
                    // Usar porcentaje calculado
                    const porcentaje = data.porcentaje || 0;
                    const promedio = data.promedio || 0;
                    
                    // Calcular altura: escala de 0-100% a 0-200px
                    const altura = (porcentaje / 100) * CHART_MAX_HEIGHT;

                    sumaTotal += porcentaje;
                    countTotal++;

                    const barGroup = document.createElement('div');
                    barGroup.className = 'bar-group';
                    
                    barGroup.innerHTML = `
                        <div class="bar ${colores[index]}" style="height: ${altura}px;" title="Promedio: ${promedio.toFixed(1)}/10 (${porcentaje.toFixed(0)}%)"></div>
                        <div class="bar-label">${labels[index]}<br><small>${porcentaje.toFixed(0)}%</small></div>
                    `;
                    
                    barsContainer.appendChild(barGroup);
                } else {
                    const barGroup = document.createElement('div');
                    barGroup.className = 'bar-group';
                    barGroup.innerHTML = `
                        <div class="bar" style="height: 0px; background: #ddd;"></div>
                        <div class="bar-label">${labels[index]}<br><small>-</small></div>
                    `;
                    barsContainer.appendChild(barGroup);
                }
            });

            // Mostrar promedio general si hay datos
            if (countTotal > 0) {
                const promedioFinalPorcentaje = (sumaTotal / countTotal).toFixed(0);
                console.log('Promedio final:', promedioFinalPorcentaje + '%');
            }

            console.log('Gr√°fica renderizada correctamente');
        }

        // ==========================================
        // CARGAR ASIGNATURAS EN SELECT
        // ==========================================
        async function cargarAsignaturas(idEstudiante) {
            try {
                const response = await httpClient.get(API_CONFIG.ENDPOINTS.ASIGNATURAS.LIST);
                
                // Manejar respuesta con estructura { success, data }
                let asignaturas = [];
                if (response && response.success) {
                    asignaturas = Array.isArray(response.data) ? response.data : [];
                } else if (Array.isArray(response)) {
                    asignaturas = response;
                } else if (Array.isArray(response.data)) {
                    asignaturas = response.data;
                } else if (response.data?.data && Array.isArray(response.data.data)) {
                    asignaturas = response.data.data;
                }

                const select = document.getElementById('asignaturaSelect');
                
                asignaturas.forEach(asig => {
                    const option = document.createElement('option');
                    option.value = asig.idAsignatura;
                    option.textContent = asig.nombre;
                    select.appendChild(option);
                });

                // Event listener para cambio de asignatura
                select.addEventListener('change', (e) => {
                    const idAsignatura = e.target.value ? parseInt(e.target.value) : null;
                    cargarGrafica(idEstudiante, idAsignatura);
                });

            } catch (error) {
                console.warn('‚ö†Ô∏è No se pudieron cargar asignaturas:', error);
            }
        }

        // ==========================================
        // MOSTRAR MENSAJES
        // ==========================================
        function mostrarMensaje(mensaje, tipo = 'info') {
            const colores = {
                info: { bg: '#e3f2fd', color: '#1565c0' },
                error: { bg: '#ffebee', color: '#c62828' },
                warning: { bg: '#fff3e0', color: '#ef6c00' }
            };

            const estilo = colores[tipo] || colores.info;

            document.getElementById('chart-bars').innerHTML = `
                <div class="no-data" style="text-align: center; padding: 40px; background: ${estilo.bg}; color: ${estilo.color}; border-radius: 8px;">
                    ${mensaje}
                </div>
            `;
        }

        // ==========================================
        // CARGAR ESTAD√çSTICAS DEL TUTOR
        // ==========================================
        async function loadEstadisticasTutor() {
            try {
                console.log('Cargando estad√≠sticas...');
                
                // Verificar si se seleccion√≥ un estudiante espec√≠fico
                const estudianteIdSeleccionado = localStorage.getItem('selectedEstudianteId');
                const estudianteNombreSeleccionado = localStorage.getItem('selectedEstudianteNombre');
                
                let estudianteId = null;

                if (estudianteIdSeleccionado) {
                    // Mostrar estudiante seleccionado
                    console.log('Estudiante seleccionado:', estudianteNombreSeleccionado);
                    
                    if (estudianteNombreSeleccionado) {
                        document.getElementById('estudianteNombre').textContent = estudianteNombreSeleccionado;
                    }
                    
                    estudianteId = estudianteIdSeleccionado;
                    
                    // Intentar cargar informaci√≥n adicional
                    try {
                        if (typeof usuariosService !== 'undefined') {
                            const estudiante = await usuariosService.getById(estudianteIdSeleccionado);
                            const nombreCompleto = estudianteNombreSeleccionado || 
                                `${estudiante.nombre} ${estudiante.ape_p} ${estudiante.ape_m || ''}`.trim();
                            document.getElementById('estudianteNombre').textContent = nombreCompleto;
                        }
                        
                        if (typeof estudianteGrupoService !== 'undefined') {
                            await cargarGrupoEstudiante(estudianteIdSeleccionado);
                        }
                    } catch (err) {
                        console.warn('Error cargando info adicional:', err);
                    }
                    
                    // Limpiar selecci√≥n
                    localStorage.removeItem('selectedEstudianteId');
                    localStorage.removeItem('selectedEstudianteNombre');
                    
                } else {
                    // Mostrar datos de ejemplo
                    document.getElementById('estudianteNombre').textContent = 'Estudiante de Ejemplo';
                    document.getElementById('estudianteGrupo').textContent = '1A - Grado 1';
                    mostrarMensaje('Selecciona un estudiante desde la pantalla principal', 'info');
                    return;
                }

                // Cargar gr√°fica de calificaciones
                await cargarGrafica(estudianteId);

                console.log('Estad√≠sticas cargadas correctamente');

            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
                document.getElementById('estudianteNombre').textContent = 'Error al cargar';
                mostrarMensaje('Error al cargar estad√≠sticas: ' + error.message, 'error');
            }
        }

        // ==========================================
        // CARGAR GRUPO DEL ESTUDIANTE
        // ==========================================
        async function cargarGrupoEstudiante(idEstudiante) {
            try {
                const todasInscripciones = await estudianteGrupoService.getAll();
                const inscripciones = todasInscripciones.filter(insc => {
                    const idEst = getEstudianteId(insc);
                    return Number(idEst) === Number(idEstudiante);
                });

                if (inscripciones.length > 0) {
                    const grupo = inscripciones[0].grupo;
                    if (grupo) {
                        document.getElementById('estudianteGrupo').textContent = 
                            `${grupo.nombre || 'Sin nombre'} - Grado ${grupo.grado || '-'}`;
                    } else {
                        document.getElementById('estudianteGrupo').textContent = 'Sin grupo';
                    }
                } else {
                    document.getElementById('estudianteGrupo').textContent = 'Sin grupo';
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error cargando grupo:', error);
                document.getElementById('estudianteGrupo').textContent = 'Error';
            }
        }

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        let initializationStarted = false;
        
        async function initializeApp() {
            if (initializationStarted) {
                console.log('‚ö†Ô∏è Inicializaci√≥n ya en progreso');
                return;
            }
            
            initializationStarted = true;
            
            try {
                console.log('üîÑ Inicializando aplicaci√≥n de estad√≠sticas...');
                
                // Esperar a que los servicios necesarios est√©n disponibles
                console.log('‚è≥ Esperando servicios...');
                await waitForServices(['calificacionesService', 'httpClient', 'API_CONFIG', 'usuariosService', 'estudianteGrupoService']);
                
                console.log('‚úÖ Servicios cargados correctamente');
                console.log('calificacionesService disponible:', typeof calificacionesService !== 'undefined');
                console.log('httpClient disponible:', typeof httpClient !== 'undefined');
                console.log('API_CONFIG disponible:', typeof API_CONFIG !== 'undefined');
                
                await loadEstadisticasTutor();
                
                console.log('‚úÖ Aplicaci√≥n de estad√≠sticas inicializada');
                
            } catch (error) {
                console.error('‚ùå Error en la inicializaci√≥n:', error);
                mostrarMensaje('Error al inicializar la aplicaci√≥n. Por favor, recarga la p√°gina.', 'error');
            }
        }
        
        // Esperar a dependenciesLoaded para iniciar
        window.addEventListener('dependenciesLoaded', async () => {
            console.log('üì¢ Evento dependenciesLoaded disparado');
            await initializeApp();
        });
        
        // Fallback: iniciar en DOMContentLoaded si dependenciesLoaded no se ha disparado
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded disparado');
            // Dar 200ms para que dependenciesLoaded se dispare
            setTimeout(async () => {
                if (!initializationStarted) {
                    console.log('‚ö†Ô∏è dependenciesLoaded no se dispar√≥, iniciando con fallback...');
                    await initializeApp();
                }
            }, 200);
        });
    </script>
    <script src="../../scripts/utils/logoutModal.js"></script>
</body>
</html>