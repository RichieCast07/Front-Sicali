<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadística Docente</title>
    <link rel="stylesheet" href="../../css/estadisticadocente.css">
    <link rel="stylesheet" href="../../css/navbar.css">
</head>

<body>
    <header class="header">
        <div class="left-section">
            <h1 class="logo">SICALI</h1>
        </div>
        <div class="user-info">
            <div class="text-info">
                <div class="role">Docente</div>
                <div class="name" id="userName">Cargando...</div>
            </div>
            <div class="avatar" id="userAvatar">
                <img src="../../img/nino.png" alt="">
            </div>
        </div>
    </header>

    <nav class="sidebar" id="sidebar">
        <ul class="menu-list">
            <li>
                <a href="../estudiantesdocente/estudiante.html">
                    <span class="icon"><img class="icon" src="../../icons/estudiante.svg" alt=""></span>
                    <span class="text">Estudiantes</span>
                </a>
            </li>
            <li>
                <a href="../tutordocente/tutor.html">
                    <span class="icon"><img class="icon" src="../../icons/tutor.svg" alt=""></span>
                    <span class="text">Tutor</span>
                </a>
            </li>
            <li>
                <a href="../asistencia/asistencia.html">
                    <span class="icon"><img class="icon" src="../../icons/asistencia.svg" alt=""></span>
                    <span class="text">Asistencias</span>
                </a>
            </li>
            <li>
                <a href="../calificaciones/calificaciones.html">
                    <span class="icon"><img class="icon" src="../../icons/calificaciones.svg" alt=""></span>
                    <span class="text">Calificaciones</span>
                </a>
            </li>
            <li class="active">
                <span class="icon"><img class="icon" src="../../icons/estadisticas.svg" alt=""></span>
                <span class="text">Estadísticas</span>
            </li>
        </ul>
    </nav>

    <main class="content" id="content">
        <section class="statistics-container">
            <h1 class="statistics-title">Estadísticas</h1>
            <div class="filters">
                <div class="estudiante-info">
                    <div class="info-block">
                        <label>Grupo:</label>
                        <p id="grupoNombre">Cargando...</p>
                    </div>

                    <div class="info-block">
                        <label>Total De Estudiantes</label>
                        <p id="totalEstudiantes">0</p>
                    </div>
                </div>
                <div class="filter-group">
                    <label>Periodo</label>
                    <div class="periodo-select">
                        <select>
                            <option value="" selected>seleccionar</option>
                            <option>Primero</option>
                            <option>Segundo</option>
                            <option>Tercero</option>
                        </select>
                        <img src="../../icons/seleccionar.svg" alt="Desplegar" class="icono-select">
                    </div>
                </div>
            </div>
        
            <div class="chart-container">
                <div class="chart">
                    <div class="y-axis">
                        <span class="y-label">10</span>
                        <span class="y-label">8</span>
                        <span class="y-label">6</span>
                        <span class="y-label">4</span>
                        <span class="y-label">2</span>
                        <span class="y-label">0</span>
                    </div>
                    <div class="grid-lines">
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                        <div class="grid-line"></div>
                    </div>
                    
                    <div class="bars" id="chart-bars">
                        <div class="no-data" style="text-align: center; padding: 40px; color: #999;">
                            Cargando estadísticas...
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="../../scripts/loadDependencies.js"></script>
    
    <script>
        // Proteger esta página para docentes y directores
        (function() {
            function waitForRouteGuard(roles) {
                if (typeof RouteGuard !== 'undefined') {
                    RouteGuard.protect(roles);
                } else {
                    setTimeout(function() { waitForRouteGuard(roles); }, 50);
                }
            }
            waitForRouteGuard([docente, 'admin']);
        })();

        // Cargar información del docente logueado
        (function() {
          try {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const userName = document.getElementById('userName');
            
            if (currentUser.nombre && currentUser.ape_p) {
              const fullName = `${currentUser.nombre} ${currentUser.ape_p} ${currentUser.ape_m || ''}`.trim();
              userName.textContent = fullName;
            } else {
              userName.textContent = 'Usuario';
            }
          } catch (error) {
            console.error('Error al cargar datos del usuario:', error);
            document.getElementById('userName').textContent = 'Usuario';
          }
        })();

        // Cargar estadísticas del grupo
        async function loadEstadisticas() {
          try {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            if (!currentUser.id_usuario) {
              throw new Error('No se encontró información del docente');
            }

            console.log('Cargando estadísticas para docente:', currentUser.id_usuario);

            // Obtener todos los grupos y filtrar por docente
            let grupos = [];
            if (typeof gruposService !== 'undefined') {
              try {
                const todosGrupos = await gruposService.getAll();
                grupos = todosGrupos.filter(g => {
                  const docenteId = g.idDocente?.id_usuario || g.idDocente;
                  return Number(docenteId) === Number(currentUser.id_usuario);
                });
              } catch (error) {
                console.warn('No se pudieron cargar grupos:', error.message);
              }
            }
            
            console.log('Grupos del docente:', grupos.length);
            
            if (!grupos || grupos.length === 0) {
              document.getElementById('grupoNombre').textContent = 'Sin grupos asignados';
              document.getElementById('totalEstudiantes').textContent = '0';
              document.getElementById('chart-bars').innerHTML = '<div class="no-data" style="text-align: center; padding: 40px; color: #999;">No tienes grupos asignados</div>';
              return;
            }

            // Usar el primer grupo
            const grupo = grupos[0];
            document.getElementById('grupoNombre').textContent = `${grupo.nombre} - Grado ${grupo.grado}`;
            
            // Obtener estudiantes del grupo
            let totalEstudiantes = 0;
            if (typeof estudianteGrupoService !== 'undefined') {
              try {
                const todasInscripciones = await estudianteGrupoService.getAll();
                const inscripciones = todasInscripciones.filter(insc => {
                  const grupoId = insc.idGrupo || insc.grupo?.idGrupo;
                  return Number(grupoId) === Number(grupo.idGrupo);
                });
                totalEstudiantes = inscripciones.length;
              } catch (error) {
                console.warn('No se pudieron cargar inscripciones:', error.message);
              }
            }
            
            document.getElementById('totalEstudiantes').textContent = totalEstudiantes;
            
            console.log('Total estudiantes:', totalEstudiantes);
            
            // Cargar gráfica de calificaciones
            await cargarGrafica(grupo.idGrupo);
            
          } catch (error) {
            console.error('Error cargando estadísticas:', error);
            document.getElementById('grupoNombre').textContent = 'Error al cargar';
            document.getElementById('chart-bars').innerHTML = '<div class="no-data" style="text-align: center; padding: 40px; color: #f44;">Error al cargar datos</div>';
          }
        }

        async function cargarGrafica(idGrupo) {
            try {
                console.log('Cargando gráfica para grupo:', idGrupo);
                
                // Obtener calificaciones del grupo usando calificacionesService
                let calificaciones = [];
                if (typeof calificacionesService !== 'undefined') {
                    try {
                        const allCalificaciones = await calificacionesService.getAll();
                        calificaciones = allCalificaciones.filter(cal => 
                            Number(cal.idGrupo) === Number(idGrupo)
                        );
                    } catch (error) {
                        console.warn('No se pudieron cargar calificaciones:', error.message);
                    }
                }

                console.log('Calificaciones cargadas:', calificaciones.length);

                if (calificaciones.length === 0) {
                    document.getElementById('chart-bars').innerHTML = '<div class="no-data" style="text-align: center; padding: 40px; color: #999;">No hay calificaciones registradas</div>';
                    return;
                }

                // Calcular promedio por asignatura con porcentaje
                const promediosPorAsignatura = {};
                
                calificaciones.forEach(calif => {
                    const idAsig = calif.idAsignatura;
                    if (!promediosPorAsignatura[idAsig]) {
                        promediosPorAsignatura[idAsig] = {
                            suma: 0,
                            count: 0,
                            nombre: calif.nombreAsignatura || 'Asignatura ' + idAsig
                        };
                    }
                    
                    // Calcular promedio de las 4 calificaciones
                    const califs = [calif.calificacion1, calif.calificacion2, calif.calificacion3, calif.calificacion4]
                        .filter(c => c !== null && c !== undefined)
                        .map(Number);
                    
                    if (califs.length > 0) {
                        const promedio = califs.reduce((a, b) => a + b, 0) / califs.length;
                        promediosPorAsignatura[idAsig].suma += promedio;
                        promediosPorAsignatura[idAsig].count++;
                    }
                });

                // Calcular porcentajes
                Object.keys(promediosPorAsignatura).forEach(idAsig => {
                    const data = promediosPorAsignatura[idAsig];
                    if (data.count > 0) {
                        const promedio = data.suma / data.count;
                        data.promedio = promedio;
                        data.porcentaje = (promedio / 10) * 100;
                    }
                });

                // Generar barras
                const barsContainer = document.getElementById('chart-bars');
                barsContainer.innerHTML = '';

                const colores = ['color-1', 'color-2', 'color-3', 'color-4', 'color-5', 'color-6'];
                let colorIndex = 0;

                Object.keys(promediosPorAsignatura).forEach(idAsig => {
                    const data = promediosPorAsignatura[idAsig];
                    const altura = (data.porcentaje / 100) * 200; // Escala de 0-100% a 0-200px

                    const barGroup = document.createElement('div');
                    barGroup.className = 'bar-group';
                    barGroup.innerHTML = `
                        <div class="bar ${colores[colorIndex % colores.length]}" style="height: ${altura}px;" title="Promedio: ${data.promedio?.toFixed(1)}/10 (${data.porcentaje?.toFixed(0)}%)"></div>
                        <div class="bar-label">${data.nombre}<br><small>${data.porcentaje?.toFixed(0)}%</small></div>
                    `;
                    barsContainer.appendChild(barGroup);
                    colorIndex++;
                });

                console.log('Gráfica renderizada');

            } catch (error) {
                console.error('Error cargando gráfica:', error);
                document.getElementById('chart-bars').innerHTML = '<div class="no-data" style="text-align: center; padding: 40px; color: #f44;">Error al cargar datos</div>';
            }
        }

        // Inicializar página
        window.addEventListener('DOMContentLoaded', () => {
          const checkServices = setInterval(() => {
            if (typeof gruposService !== 'undefined' && 
                typeof estudianteGrupoService !== 'undefined' &&
                typeof calificacionesService !== 'undefined') {
              clearInterval(checkServices);
              loadEstadisticas();
            }
          }, 100);
        });
    </script>
    <script src="../../scripts/utils/logoutModal.js"></script>
</body>
</html>