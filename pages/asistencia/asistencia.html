<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencias</title>
    <link rel="stylesheet" href="../../css/navbar.css">
    <link rel="stylesheet" href="../../css/asistencias.css">
    <link rel="stylesheet" href="../../css/modalactualizar.css">
    <style>
        /* Estilos adicionales para checkboxes */
        .asistencia-cell {
            text-align: center;
            padding: 5px;
        }
        
        .check-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            flex-wrap: nowrap;
        }
        
        .check {
            width: 16px;
            height: 16px;
            cursor: pointer;
            margin: 0;
            flex-shrink: 0;
        }
        
        .check.green:checked {
            accent-color: #10b981;
        }
        
        .check.red:checked {
            accent-color: #ef4444;
        }
        
        .check.blue:checked {
            accent-color: #3b82f6;
        }
        
        .estudiante-row:hover {
            background: #f9fafb;
        }
        
        .loading-row {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        /* Leyenda de estados */
        .leyenda-estados {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .leyenda-estados strong {
            color: #495057;
            font-size: 14px;
        }
        
        .leyenda-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #495057;
        }
        
        .leyenda-box {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #d1d5db;
            position: relative;
        }
        
        .leyenda-box.green {
            background-color: #10b981;
            border-color: #10b981;
        }
        
        .leyenda-box.red {
            background-color: #ef4444;
            border-color: #ef4444;
        }
        
        .leyenda-box.blue {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        
        .leyenda-box::after {
            content: '‚úì';
            color: white;
            font-size: 12px;
            font-weight: bold;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="left-section">
            <h1 class="logo">SICALI</h1>
        </div>
        <div class="user-info">
            <div class="text-info">
                <div class="role">Docente</div>
                <div class="name" id="nombre-docente">Cargando...</div>
            </div>
            <div class="avatar" id="userAvatar">
                <img src="../../img/nino.png" alt="">
            </div>
        </div>
    </header>

    <nav class="sidebar" id="sidebar">
        <ul class="menu-list">
            <li>
                <a href="../estudiantesdocente/estudiante.html">
                    <span class="icon"><img class="icon" src="../../icons/estudiante.svg" alt=""></span>
                    <span class="text">Estudiantes</span>
                </a>
            </li>
            <li>
                <a href="../tutordocente/tutor.html">
                    <span class="icon"><img class="icon" src="../../icons/tutor.svg" alt=""></span>
                    <span class="text">Tutor</span>
                </a>
            </li>
            <li class="active">
                <span class="icon"><img class="icon" src="../../icons/asistencia.svg" alt=""></span>
                <span class="text">Asistencias</span>
            </li>
            <li>
                <a href="../calificaciones/calificaciones.html">
                    <span class="icon"><img class="icon" src="../../icons/calificaciones.svg" alt=""></span>
                    <span class="text">Calificaciones</span>
                </a>
            </li>
            <li>
                <a href="../estadisticas/estadisticasdocente.html">
                    <span class="icon"><img class="icon" src="../../icons/estadisticas.svg" alt=""></span>
                    <span class="text">Estad√≠sticas</span>
                </a>
            </li>
        </ul>
    </nav>

    <main class="content" id="content">
        <section class="asistencias-section">
            <h1 class="titulo">Asistencia</h1>
            <h2 class="grupo" id="nombre-grupo">Cargando grupo...</h2>
            
            <div class="container">
                <div class="acciones-superiores">
                    <div class="select-section">
                        <div class="buscador-con-icono">
                            <img src="../../icons/buscador.svg" alt="Icono de buscador" class="icono-input" />
                            <input type="text" placeholder="Buscar estudiante" id="buscarEstudiante" onkeyup="filtrarEstudiantes()" />
                        </div>

                        <label class="fecha">Semana del:</label>
                        <input type="date" id="fecha" class="fecha-input">
                        <button class="btn-editar" onclick="cargarSemana()" style="padding: 8px 16px; margin-left: 10px;">
                            üîÑ Cargar
                        </button>
                    </div>
                    <div class="agregar">
                        <button class="btn-editar" onclick="validarYGuardar()">
                            <img src="../../icons/guardar.svg" alt="Guardar" class="icono-agregar"/>
                            Guardar Asistencias
                        </button>
                    </div>
                </div>
            </div>

            <div class="container">
                <!-- Leyenda de estados -->
                <div class="leyenda-estados">
                    <strong>Leyenda:</strong>
                    <div class="leyenda-item">
                        <div class="leyenda-box green"></div>
                        <span>Asistencia</span>
                    </div>
                    <div class="leyenda-item">
                        <div class="leyenda-box red"></div>
                        <span>Falta</span>
                    </div>
                    <div class="leyenda-item">
                        <div class="leyenda-box blue"></div>
                        <span>Permiso</span>
                    </div>
                </div>
                
                <table class="tabla-asistencias">
                    <thead>
                        <tr>
                            <th rowspan="2">#</th>
                            <th rowspan="2">Nombre Completo</th>
                            <th id="dia-1">Lun<br><small>--/--</small></th>
                            <th id="dia-2">Mar<br><small>--/--</small></th>
                            <th id="dia-3">Mi√©<br><small>--/--</small></th>
                            <th id="dia-4">Jue<br><small>--/--</small></th>
                            <th id="dia-5">Vie<br><small>--/--</small></th>
                        </tr>
                    </thead>
                    <tbody id="tbody-asistencias">
                        <tr>
                            <td colspan="7" class="loading-row">
                                Cargando estudiantes...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Modal de confirmaci√≥n -->
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal">
                <img src="../../icons/info.svg" alt="info" class="modal-icon">
                <h3>¬øGuardar Asistencias?</h3>
                <p id="modal-mensaje">Se guardar√°n las asistencias de esta semana</p>
                <div class="modal-buttons">
                    <button class="confirm" onclick="guardarAsistencias()">Guardar</button>
                    <button class="cancel" onclick="closeModal()">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal de √©xito -->
        <div id="success-modal-overlay" class="modal-overlay">
            <div class="modal">
                <img src="../../icons/success.svg" alt="success" class="modal-icon">
                <h3>Guardado Correctamente</h3>
                <p>Las asistencias se guardaron exitosamente</p>
                <div class="modal-buttons">
                    <button class="confirm" onclick="closeSuccessModal()">Aceptar</button>
                </div>
            </div>
        </div>
    </main>

    <!-- ============================================ -->
    <!-- SCRIPTS DEL SISTEMA                          -->
    <!-- ============================================ -->
    <script src="../../scripts/loadDependencies.js"></script>

    <!-- ============================================ -->
    <!-- C√ìDIGO DE LA P√ÅGINA                          -->
    <!-- ============================================ -->
    <script>
        // Proteger esta p√°gina para docentes y admins
        (function() {
            function waitForRouteGuard(roles) {
                if (typeof RouteGuard !== 'undefined') {
                    RouteGuard.protect(roles);
                } else {
                    setTimeout(function() { waitForRouteGuard(roles); }, 50);
                }
            }
            waitForRouteGuard(['docente', 'admin']);
        })();

        // Variables globales
        let idGrupo = null;
        let estudiantes = [];
        let fechasSemanales = [];
        let asistenciasActuales = {};
        let todosLosEstudiantes = [];

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        function inicializar() {
            // Cargar nombre del docente
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (currentUser.nombre && currentUser.ape_p) {
                    const fullName = `${currentUser.nombre} ${currentUser.ape_p} ${currentUser.ape_m || ''}`.trim();
                    document.getElementById('nombre-docente').textContent = fullName;
                } else {
                    document.getElementById('nombre-docente').textContent = 'Usuario';
                }
            } catch (error) {
                console.error('Error al cargar datos del usuario:', error);
                document.getElementById('nombre-docente').textContent = 'Usuario';
            }

            // Obtener ID del grupo desde URL o localStorage (opcional)
            const urlParams = new URLSearchParams(window.location.search);
            idGrupo = urlParams.get('grupo') || localStorage.getItem('grupoActual') || null;

            // Establecer fecha actual
            const fechaInput = document.getElementById('fecha');
            if (fechaInput && typeof DateUtils !== 'undefined') {
                fechaInput.value = DateUtils.getCurrentDate();
            } else if (fechaInput) {
                // Fallback manual si DateUtils no est√° disponible
                const hoy = new Date();
                const year = hoy.getFullYear();
                const month = String(hoy.getMonth() + 1).padStart(2, '0');
                const day = String(hoy.getDate()).padStart(2, '0');
                fechaInput.value = `${year}-${month}-${day}`;
            }

            // Verificar que los servicios est√©n cargados antes de continuar
            if (typeof gruposService === 'undefined' || typeof estudianteGrupoService === 'undefined') {
                console.warn('‚è≥ Esperando a que los servicios se carguen...');
                setTimeout(inicializar, 100); // Reintentar en 100ms
                return;
            }

            // Cargar datos iniciales (cargar√° el grupo del docente)
            cargarDatosIniciales();
        }

        // Esperar a que las dependencias se carguen
        window.addEventListener('dependenciesLoaded', inicializar);
        
        // Fallback por si el evento ya se dispar√≥
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof DateUtils !== 'undefined') {
                inicializar();
            }
        });

        // ==========================================
        // CARGAR DATOS INICIALES
        // ==========================================
        async function cargarDatosIniciales() {
            try {
                console.log('üìö Cargando datos iniciales...');
                
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                
                if (!currentUser.id_usuario) {
                    throw new Error('No se encontr√≥ informaci√≥n del docente');
                }

                console.log('üë§ Docente ID:', currentUser.id_usuario);

                // Obtener grupos del docente
                const todosGrupos = await gruposService.getAll();
                const gruposDocente = todosGrupos.filter(g => {
                    const docenteId = g.idDocente?.id_usuario || g.idDocente;
                    return Number(docenteId) === Number(currentUser.id_usuario);
                });

                console.log('üìñ Grupos del docente:', gruposDocente.length);

                if (gruposDocente.length === 0) {
                    throw new Error('No tienes grupos asignados');
                }

                // Usar el primer grupo (o el especificado en URL)
                const grupo = idGrupo 
                    ? gruposDocente.find(g => Number(g.idGrupo) === Number(idGrupo)) || gruposDocente[0]
                    : gruposDocente[0];
                
                idGrupo = grupo.idGrupo;
                localStorage.setItem('grupoActual', idGrupo);

                document.getElementById('nombre-grupo').textContent = 
                    `Grupo: ${grupo.nombre} - Grado ${grupo.grado}`;

                console.log('‚úÖ Grupo cargado:', grupo.nombre);

                // Cargar estudiantes del grupo
                const todasInscripciones = await estudianteGrupoService.getAll();
                const inscripcionesGrupo = todasInscripciones.filter(insc => {
                    const grupoId = insc.idGrupo || insc.grupo?.idGrupo;
                    return Number(grupoId) === Number(idGrupo);
                });

                console.log('‚úÖ Inscripciones encontradas:', inscripcionesGrupo.length);

                // Filtrar inscripciones con estudiante v√°lido y ordenar
                todosLosEstudiantes = inscripcionesGrupo
                    .filter(insc => insc.estudiante !== null && insc.estudiante !== undefined)
                    .sort((a, b) => {
                        const est1 = a.estudiante;
                        const est2 = b.estudiante;
                        const nombreA = `${est1.ape_p} ${est1.ape_m} ${est1.nombre}`.toLowerCase();
                        const nombreB = `${est2.ape_p} ${est2.ape_m} ${est2.nombre}`.toLowerCase();
                        return nombreA.localeCompare(nombreB);
                    });

                console.log('‚úÖ Estudiantes del grupo:', todosLosEstudiantes.length);

                // Cargar semana actual
                await cargarSemana();
                
                // Actualizar badge de pendientes
                actualizarBadgePendientes();

            } catch (error) {
                console.error('‚ùå Error al cargar datos:', error);
                if (typeof UIUtils !== 'undefined') {
                    UIUtils.showError('Error: ' + error.message);
                } else {
                    alert('Error: ' + error.message);
                }
                
                // Mostrar mensaje en la tabla
                const tbody = document.getElementById('tbody-asistencias');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="loading-row">
                                ‚ùå ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // ==========================================
        // CARGAR SEMANA DE ASISTENCIAS
        // ==========================================
        async function cargarSemana() {
            try {
                if (typeof UIUtils !== 'undefined') {
                    UIUtils.showLoader('Cargando semana...');
                }

                const fechaBase = document.getElementById('fecha').value;
                
                // Calcular fechas de la semana (Lunes a Viernes)
                fechasSemanales = calcularFechasSemana(fechaBase);

                // Actualizar encabezados de la tabla
                actualizarEncabezadosFechas();

                // Cargar asistencias existentes de esta semana
                await cargarAsistenciasExistentes();

                // Mostrar estudiantes en la tabla
                mostrarEstudiantes(todosLosEstudiantes);

                if (typeof UIUtils !== 'undefined') {
                    UIUtils.hideLoader();
                }

            } catch (error) {
                if (typeof UIUtils !== 'undefined') {
                    UIUtils.hideLoader();
                    UIUtils.showError('Error al cargar semana: ' + error.message);
                } else {
                    alert('Error al cargar semana: ' + error.message);
                }
                console.error(error);
            }
        }

        // ==========================================
        // CALCULAR FECHAS DE LA SEMANA
        // ==========================================
        function calcularFechasSemana(fechaStr) {
            const fecha = new Date(fechaStr + 'T00:00:00');
            const dia = fecha.getDay();
            
            // Ajustar al lunes de esa semana
            const diff = dia === 0 ? -6 : 1 - dia;
            const lunes = new Date(fecha);
            lunes.setDate(fecha.getDate() + diff);

            // Generar array de 5 d√≠as (Lunes a Viernes)
            const fechas = [];
            for (let i = 0; i < 5; i++) {
                const dia = new Date(lunes);
                dia.setDate(lunes.getDate() + i);
                fechas.push(dia.toISOString().split('T')[0]);
            }

            return fechas;
        }

        // ==========================================
        // ACTUALIZAR ENCABEZADOS CON FECHAS
        // ==========================================
        function actualizarEncabezadosFechas() {
            const dias = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie'];
            
            fechasSemanales.forEach((fecha, index) => {
                const [a√±o, mes, dia] = fecha.split('-');
                const th = document.getElementById(`dia-${index + 1}`);
                if (th) {
                    th.innerHTML = `${dias[index]}<br><small>${dia}/${mes}</small>`;
                }
            });
        }

        // ==========================================
        // CARGAR ASISTENCIAS EXISTENTES
        // ==========================================
        async function cargarAsistenciasExistentes() {
            asistenciasActuales = {};

            try {
                if (typeof asistenciaService === 'undefined') {
                    console.warn('‚ö†Ô∏è asistenciaService no disponible a√∫n');
                    return;
                }

                const todasAsistencias = await asistenciaService.getByGrupo(idGrupo);

                if (todasAsistencias && todasAsistencias.length > 0) {
                    console.log('üìã Asistencias del backend:', todasAsistencias.length);

                    todasAsistencias.forEach(asist => {
                        const idEst = asist.estudiante?.id_usuario || asist.idEstudiante;
                        if (fechasSemanales.includes(asist.fecha)) {
                            const key = `${idEst}_${asist.fecha}`;
                            asistenciasActuales[key] = {
                                idAsistencia: asist.idAsistencia,
                                estado: asist.estado
                            };
                        }
                    });

                    console.log('‚úÖ Asistencias cargadas del backend:', Object.keys(asistenciasActuales).length);
                } else {
                    console.log('üìã No hay asistencias en el backend para este grupo');
                }

            } catch (error) {
                console.warn('‚ö†Ô∏è No se pudieron cargar asistencias del backend:', error.message);
            }

            // Cargar asistencias locales como respaldo
            try {
                const asistenciasLocales = JSON.parse(localStorage.getItem('asistencias_pendientes') || '[]');
                
                if (asistenciasLocales.length > 0) {
                    asistenciasLocales.forEach(asist => {
                        if (Number(asist.idGrupo) === Number(idGrupo) && fechasSemanales.includes(asist.fecha)) {
                            const key = `${asist.idEstudiante}_${asist.fecha}`;
                            if (!asistenciasActuales[key]) {
                                asistenciasActuales[key] = {
                                    idAsistencia: null,
                                    estado: asist.estado
                                };
                            }
                        }
                    });

                    console.log('üì¶ Asistencias locales cargadas');
                }

            } catch (error) {
                console.warn('Error al cargar asistencias locales:', error);
            }
        }

        // ==========================================
        // MOSTRAR ESTUDIANTES EN LA TABLA
        // ==========================================
        function mostrarEstudiantes(estudiantesGrupo) {
            const tbody = document.getElementById('tbody-asistencias');

            if (estudiantesGrupo.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="loading-row">
                            No hay estudiantes en este grupo
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = estudiantesGrupo.map((eg, index) => {
                const est = eg.estudiante;
                const nombreCompleto = `${est.nombre} ${est.ape_p} ${est.ape_m}`;

                return `
                    <tr class="estudiante-row" data-estudiante="${est.id_usuario}">
                        <td>${index + 1}</td>
                        <td>${nombreCompleto}</td>
                        ${generarCeldasAsistencia(est.id_usuario)}
                    </tr>
                `;
            }).join('');

            configurarCheckboxes();
        }

        // ==========================================
        // GENERAR CELDAS DE ASISTENCIA (5 D√çAS)
        // ==========================================
        function generarCeldasAsistencia(idEstudiante) {
            return fechasSemanales.map((fecha, diaIndex) => {
                const key = `${idEstudiante}_${fecha}`;
                const estadoData = asistenciasActuales[key];
                const estadoActual = estadoData?.estado || '';
                
                const asistioChecked = estadoActual === 'Asistencia' ? 'checked' : '';
                const faltoChecked = estadoActual === 'Falta' ? 'checked' : '';
                const permisoChecked = estadoActual === 'Permiso' ? 'checked' : '';

                return `
                    <td class="asistencia-cell">
                        <div class="check-container">
                            <input type="checkbox" 
                                   class="check green" 
                                   data-estudiante="${idEstudiante}"
                                   data-fecha="${fecha}"
                                   data-tipo="asistio"
                                   title="Asistencia"
                                   ${asistioChecked}>
                            <input type="checkbox" 
                                   class="check red"
                                   data-estudiante="${idEstudiante}"
                                   data-fecha="${fecha}"
                                   data-tipo="falto"
                                   title="Falta"
                                   ${faltoChecked}>
                            <input type="checkbox" 
                                   class="check blue"
                                   data-estudiante="${idEstudiante}"
                                   data-fecha="${fecha}"
                                   data-tipo="permiso"
                                   title="Permiso"
                                   ${permisoChecked}>
                        </div>
                    </td>
                `;
            }).join('');
        }

        // ==========================================
        // CONFIGURAR CHECKBOXES (EXCLUSIVOS)
        // ==========================================
        function configurarCheckboxes() {
            const checkboxes = document.querySelectorAll('.check');
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        const estudiante = this.dataset.estudiante;
                        const fecha = this.dataset.fecha;

                        const todosCheckboxes = document.querySelectorAll(
                            `.check[data-estudiante="${estudiante}"][data-fecha="${fecha}"]`
                        );
                        
                        todosCheckboxes.forEach(cb => {
                            if (cb !== this) {
                                cb.checked = false;
                            }
                        });
                    }
                });
            });
        }

        // ==========================================
        // FILTRAR ESTUDIANTES (B√öSQUEDA)
        // ==========================================
        function filtrarEstudiantes() {
            const busqueda = document.getElementById('buscarEstudiante').value.toLowerCase();
            
            if (!busqueda) {
                mostrarEstudiantes(todosLosEstudiantes);
                return;
            }

            const filtrados = todosLosEstudiantes.filter(eg => {
                const est = eg.estudiante;
                const nombreCompleto = `${est.nombre} ${est.ape_p} ${est.ape_m}`.toLowerCase();
                return nombreCompleto.includes(busqueda);
            });

            mostrarEstudiantes(filtrados);
        }

        // ==========================================
        // VALIDAR Y MOSTRAR MODAL
        // ==========================================
        function validarYGuardar() {
            const checkboxesMarcados = document.querySelectorAll('.check:checked');
            const totalCeldas = todosLosEstudiantes.length * 5;
            const porcentaje = ((checkboxesMarcados.length / totalCeldas) * 100).toFixed(0);

            document.getElementById('modal-mensaje').textContent = 
                `Se guardar√°n ${checkboxesMarcados.length} registros de asistencia (${porcentaje}% de la semana)`;

            showModal();
        }

        // ==========================================
        // GUARDAR ASISTENCIAS
        // ==========================================
        async function guardarAsistencias() {
            closeModal();

            try {
                if (typeof UIUtils !== 'undefined') {
                    UIUtils.showLoader('Guardando asistencias...');
                }

                const checkboxes = document.querySelectorAll('.check:checked');
                let guardadas = 0;
                let actualizadas = 0;
                let errores = 0;
                const asistenciasLocales = [];

                console.log('üíæ Guardando asistencias...', {
                    totalCheckboxes: checkboxes.length,
                    idGrupo: idGrupo,
                    fechasSemanales: fechasSemanales
                });

                for (const checkbox of checkboxes) {
                    const idEstudiante = parseInt(checkbox.dataset.estudiante);
                    const fecha = checkbox.dataset.fecha;
                    const tipo = checkbox.dataset.tipo;
                    
                    let estado;
                    if (tipo === 'asistio') estado = 'Asistencia';
                    else if (tipo === 'falto') estado = 'Falta';
                    else if (tipo === 'permiso') estado = 'Permiso';
                    else estado = 'Asistencia';

                    const key = `${idEstudiante}_${fecha}`;
                    const asistenciaExistente = asistenciasActuales[key];

                    const datos = {
                        idEstudiante: idEstudiante,
                        idGrupo: parseInt(idGrupo),
                        fecha: fecha,
                        estado: estado
                    };

                    try {
                        if (asistenciaExistente?.idAsistencia) {
                            const resultado = await asistenciaService.update(asistenciaExistente.idAsistencia, datos);
                            console.log('‚úÖ Asistencia actualizada:', resultado);
                            actualizadas++;
                        } else {
                            try {
                                const resultado = await asistenciaService.create(datos);
                                console.log('‚úÖ Asistencia creada:', resultado);
                                
                                if (resultado && resultado.idAsistencia) {
                                    asistenciasActuales[key] = {
                                        idAsistencia: resultado.idAsistencia,
                                        estado: estado
                                    };
                                }
                                
                                guardadas++;
                            } catch (createError) {
                                if (createError.message && (
                                    createError.message.includes('Duplicate entry') || 
                                    createError.message.includes('unique_asistencia')
                                )) {
                                    console.log('‚ö†Ô∏è Asistencia duplicada detectada');
                                    actualizadas++;
                                } else {
                                    throw createError;
                                }
                            }
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error al guardar asistencia:', error.message);
                        
                        asistenciasLocales.push({
                            ...datos,
                            idAsistencia: `local_${Date.now()}_${idEstudiante}_${fecha}`,
                            timestamp: new Date().toISOString()
                        });
                        errores++;
                    }
                }

                if (asistenciasLocales.length > 0) {
                    const asistenciasExistentes = JSON.parse(localStorage.getItem('asistencias_pendientes') || '[]');
                    const todasAsistencias = [...asistenciasExistentes, ...asistenciasLocales];
                    localStorage.setItem('asistencias_pendientes', JSON.stringify(todasAsistencias));
                    console.log('üíæ Asistencias guardadas localmente:', asistenciasLocales.length);
                }

                if (typeof UIUtils !== 'undefined') {
                    UIUtils.hideLoader();
                }

                const totalOperaciones = guardadas + actualizadas;
                
                if (totalOperaciones > 0) {
                    try {
                        const asistenciasExistentes = JSON.parse(localStorage.getItem('asistencias_pendientes') || '[]');
                        const asistenciasRestantes = asistenciasExistentes.filter(a => Number(a.idGrupo) !== Number(idGrupo));
                        localStorage.setItem('asistencias_pendientes', JSON.stringify(asistenciasRestantes));
                        console.log('üßπ Limpiadas asistencias locales del grupo', idGrupo);
                    } catch (e) {
                        console.warn('Error al limpiar localStorage:', e);
                    }
                }
                
                if (totalOperaciones > 0 && errores === 0) {
                    showSuccessModal();
                    if (typeof UIUtils !== 'undefined') {
                        UIUtils.showSuccess(`‚úÖ ${guardadas} creadas, ${actualizadas} actualizadas`);
                    }
                } else if (asistenciasLocales.length > 0 && totalOperaciones === 0) {
                    showSuccessModal();
                    if (typeof UIUtils !== 'undefined') {
                        UIUtils.showWarning(`‚ö†Ô∏è ${asistenciasLocales.length} guardadas localmente`);
                    } else {
                        alert(`${asistenciasLocales.length} asistencias guardadas localmente`);
                    }
                } else if (totalOperaciones > 0 && errores > 0) {
                    showSuccessModal();
                    if (typeof UIUtils !== 'undefined') {
                        UIUtils.showWarning(`‚úÖ ${totalOperaciones} en servidor, ‚ö†Ô∏è ${asistenciasLocales.length} localmente`);
                    }
                } else {
                    if (typeof UIUtils !== 'undefined') {
                        UIUtils.showWarning('No se guardaron asistencias nuevas');
                    } else {
                        alert('No se guardaron asistencias nuevas');
                    }
                }

                await cargarSemana();
                actualizarBadgePendientes();

            } catch (error) {
                if (typeof UIUtils !== 'undefined') {
                    UIUtils.hideLoader();
                    UIUtils.showError('Error al guardar: ' + error.message);
                } else {
                    alert('Error al guardar: ' + error.message);
                }
                console.error(error);
            }
        }

        // ==========================================
        // ACTUALIZAR BADGE DE ASISTENCIAS PENDIENTES
        // ==========================================
        function actualizarBadgePendientes() {
            try {
                const asistenciasLocales = JSON.parse(localStorage.getItem('asistencias_pendientes') || '[]');
                const badge = document.getElementById('badgePendientes');
                
                if (!badge) {
                    console.warn('‚ö†Ô∏è Elemento badgePendientes no encontrado en el DOM');
                    return;
                }
                
                if (asistenciasLocales.length > 0) {
                    badge.textContent = asistenciasLocales.length;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.warn('Error al actualizar badge:', error);
            }
        }

        // ==========================================
        // FUNCIONES DE MODALES
        // ==========================================
        function showModal() {
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function showSuccessModal() {
            document.getElementById('success-modal-overlay').style.display = 'flex';
        }

        function closeSuccessModal() {
            document.getElementById('success-modal-overlay').style.display = 'none';
        }
    </script>

    <script src="../../scripts/utils/logoutModal.js"></script>
</body>
</html>