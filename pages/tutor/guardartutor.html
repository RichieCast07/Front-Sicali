<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar estudiantes</title>
    <link rel="stylesheet" href="../../css/Editar estudiante.css">
    <link rel="stylesheet" href="../../css/navbar.css">
    <link rel="stylesheet" href="../../css/modalactualizar.css">
</head>

<body>
    <header class="header">
        <div class="left-section">
            <h1 class="logo">SICALI</h1>
        </div>
        <div class="user-info">
            <div class="text-info">
                <div class="role" id="userRole">Cargando...</div>
                <div class="name" id="userName">Cargando...</div>
            </div>
            <div class="avatar"><img src="../../img/nino.png" alt=""></div>
        </div>
    </header>
    
    <script>
        (function() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userName = document.getElementById('userName');
                const userRole = document.getElementById('userRole');
                
                if (currentUser.nombre && currentUser.ape_p) {
                    const fullName = `${currentUser.nombre} ${currentUser.ape_p} ${currentUser.ape_m || ''}`.trim();
                    userName.textContent = fullName;
                } else {
                    userName.textContent = 'Usuario';
                }

                if (currentUser.rol) {
                    const rolCapitalizado = currentUser.rol.charAt(0).toUpperCase() + currentUser.rol.slice(1);
                    userRole.textContent = rolCapitalizado;
                } else {
                    userRole.textContent = 'Usuario';
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                document.getElementById('userName').textContent = 'Usuario';
                document.getElementById('userRole').textContent = 'Usuario';
            }
        })();
    </script>
    
    <script>
      (function() {
        function waitForRouteGuard(roles) {
          if (typeof RouteGuard !== 'undefined') {
            RouteGuard.protect(roles);
          } else {
            setTimeout(function() { waitForRouteGuard(roles); }, 50);
          }
        }
        waitForRouteGuard([docente, 'admin']);
      })();
    </script>

    <nav class="sidebar" id="sidebar">
       <ul class="menu-list">
            <li><a href="../docentes/docente.html"><img class="icon" src="../../icons/docente.svg" alt=""><span class="text">Docentes</span></a></li>
            <li><a href="../tutor/tutor.html"><span class="icon"> <img class="icon" src="../../icons/tutor.svg" alt=""></span><span class="text">Tutor</span></a></li>
            <li><a href="../estudiantes/estudiante.html"><img class="icon" src="../../icons/estudiante.svg" alt=""><span class="text">Estudiantes</span></a></li>
            <li><a href="../grupos/grupos.html"><img class="icon" src="../../icons/grupos.svg" alt=""><span class="text">Grupos</span></a></li>
            <li><a href="../asignaturas/asignatura.html"><img class="icon" src="../../icons/asignatura.svg" alt=""><span class="text">Asignaturas</span></a></li>
            <li><a href="../estadisticas/Estadisticadirector.html"><img class="icon" src="../../icons/estadisticas.svg" alt=""><span class="text">Estad√≠sticas</span></a></li>
        </ul>
    </nav>

    <main class="content" id="content">
    <button type="button" class="back-link" aria-label="Volver atr√°s">
        <span class="icon"><img src="../../icons/atrass.svg" alt="Flecha atr√°s" /> </span>
        <span class="text">Atr√°s</span>
    </button>

    <section class="editar-estudiante">
  <h2>Tutor</h2>

  <div class="form-contenedor">
    <div class="form-columna">
      
<div class="form-group">
        <label>Nombre:</label>
        <input type="text" id="nombre">
      </div>

      <div class="form-group">
        <label>Apellido Paterno:</label>
        <input type="text" id="ape_p">
      </div>

      <div class="form-group">
        <label>Apellido Materno:</label>
        <input type="text" id="ape_m">
      </div>
      
    </div>

    <div class="form-columna">
     

      

      <div class="form-group">
        <label>Sexo</label>
        <select id="sexo">
          <option>Seleccionar</option>
          <option value="M">Masculino</option>
          <option value="F">Femenino</option>
        </select>
      </div>

      <div class="form-group">
        <label>Fecha de Nacimiento</label>
        <input type="date" id="fechaNacimiento">
      </div>
      <div class="form-group">
            <label>Usuario:</label>
            <input type="text" id="usuario">
          </div>
          <div class="form-group" style="position: relative;">
          <label>Contrase√±a:</label>
          <input type="password" id="password">
          <button type="button" onclick="togglePassword()" style="position: absolute; right: 10px; top: 32px;">
            <span class="iconpasswor"><img src="../../icons/visualizar password.svg" alt="Flecha atr√°s" /></span>
          </button>
         </div>
    </div>
  </div>

  <div class="boton-agregar">
    <button type="button" onclick="showModal()">
      <img src="../../icons/guardar.svg" class="btn-icon" alt="Guardar">
      Guardar
    </button>
  </div>
</section>

<div id="modal-overlay" class="modal-overlay">
    <div class="modal">
        <img src="../../icons/info.svg" alt="info" class="modal-icon">
        <h3>¬øDesea Actualizarlo?</h3>
        <p>Los datos actuales ser√°n reemplazados por la nueva informaci√≥n</p>
        <div class="modal-buttons">
            <button class="confirm" onclick="confirmSave()">Guardar</button>
            <button class="cancel" onclick="closeModal()">Cancelar</button>
        </div>
    </div>
</div>

<div id="success-modal-overlay" class="modal-overlay"> 
    <div class="modal">
        <img src="../../icons/success.svg" alt="info" class="modal-icon">
        <h3>Actualizado Correctamente</h3>
        <p>Se actualizo la informaci√≥n existente</p>
        <div class="modal-buttons">
            <button class="confirm" onclick="closeSuccessModal()">Aceptar</button>
        </div>
    </div>
</div>

<script src="../../scripts/loadDependencies.js"></script>
<script>
    let tutorId = null;
    let tutorRol = null;

    // Load tutor data from API based on sessionStorage or URL params
    async function loadTutorData() {
        try {
            // Get ID from sessionStorage first (from editartutor click), then from URL params
            let id = sessionStorage.getItem('tutorIdToEdit');
            
            if (!id) {
                const params = new URLSearchParams(window.location.search);
                id = params.get('id');
            }
            
            console.log('üìç sessionStorage tutorIdToEdit:', sessionStorage.getItem('tutorIdToEdit'));
            console.log('üìå ID final a usar:', id);
            
            if (!id) {
                console.error('‚ùå No tutor ID provided');
                alert('No se proporcion√≥ ID de tutor');
                window.history.back();
                return;
            }

            tutorId = Number(id);

            // Wait for service to be available
            let retries = 0;
            while (typeof usuariosService === 'undefined' && retries < 50) {
                await new Promise(r => setTimeout(r, 100));
                retries++;
            }

            if (typeof usuariosService === 'undefined') {
                throw new Error('usuariosService not available');
            }

            console.log('‚úÖ Loading tutor with ID:', tutorId);
            const tutor = await usuariosService.getById(tutorId);
            
            if (!tutor) {
                alert('Tutor no encontrado');
                window.history.back();
                return;
            }

            // Verify it's a tutor
            if (tutor.rol !== 'tutor') {
                console.warn('‚ö†Ô∏è Usuario encontrado pero no es tutor, rol:', tutor.rol);
                alert('El usuario no tiene rol de tutor');
                window.history.back();
                return;
            }

            // Store the role
            tutorRol = tutor.rol;
            console.log('‚úÖ Usuario es tutor, datos:', tutor);

            // Populate form fields from API data
            document.getElementById('nombre').value = tutor.nombre || '';
            document.getElementById('ape_p').value = tutor.ape_p || '';
            document.getElementById('ape_m').value = tutor.ape_m || '';
            document.getElementById('sexo').value = tutor.sexo || '';
            document.getElementById('fechaNacimiento').value = tutor.fecha_nacimiento || '';
            document.getElementById('usuario').value = tutor.usuario || '';
            document.getElementById('password').value = tutor.password || '';

            // Clear sessionStorage after loading
            sessionStorage.removeItem('tutorIdToEdit');

            console.log('‚úÖ Tutor data loaded successfully:', tutor);
        } catch (error) {
            console.error('‚ùå Error loading tutor:', error);
            alert('Error cargando datos del tutor: ' + error.message);
            window.history.back();
        }
    }

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadTutorData();
    });

    function showModal() {
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
    }

    function closeSuccessModal() {
        document.getElementById('success-modal-overlay').style.display = 'none';
        window.location.href = 'tutor.html';
    }

    async function confirmSave() {
        try {
            closeModal();

            if (!tutorId) {
                alert('Error: ID de tutor no disponible');
                return;
            }

            const nombre = document.getElementById('nombre').value?.trim();
            const ape_p = document.getElementById('ape_p').value?.trim();
            const ape_m = document.getElementById('ape_m').value?.trim();
            const sexo = document.getElementById('sexo').value;
            const fecha_nacimiento = document.getElementById('fechaNacimiento').value;
            const usuario = document.getElementById('usuario').value?.trim();
            const password = document.getElementById('password').value;

            // Validate required fields
            if (!nombre) {
                alert('Nombre es obligatorio');
                return;
            }
            if (!ape_p) {
                alert('Apellido paterno es obligatorio');
                return;
            }

            const tutorData = {
                nombre: nombre || '',
                ape_p: ape_p || '',
                ape_m: ape_m || '',
                sexo: sexo || '',
                fecha_nacimiento: fecha_nacimiento || '',
                usuario: usuario || '',
                password: password || '',
                rol: tutorRol || 'tutor',
                estado: 'Activo'
            };

            console.log('üîç Datos a enviar:', tutorData);
            console.log('üîç tutorId:', tutorId);

            // Wait for service to be available
            let retries = 0;
            while (typeof usuariosService === 'undefined' && retries < 50) {
                await new Promise(r => setTimeout(r, 100));
                retries++;
            }

            if (typeof usuariosService === 'undefined') {
                throw new Error('usuariosService not available');
            }

            console.log('‚úÖ Enviando actualizaci√≥n para tutor ID:', tutorId);
            console.log('üì¶ Payload completo:', JSON.stringify(tutorData, null, 2));
            const result = await usuariosService.update(tutorId, tutorData);
            
            console.log('‚úÖ Tutor updated successfully:', result);
            document.getElementById('success-modal-overlay').style.display = 'flex';
        } catch (error) {
            console.error('‚ùå Error updating tutor:', error);
            console.error('Error completo:', JSON.stringify(error, null, 2));
            
            let errorMsg = 'Error actualizando tutor';
            if (error.message) {
                errorMsg += ': ' + error.message;
            }
            if (error.data && typeof error.data === 'object') {
                console.error('Detalles del error del backend:', error.data);
                if (error.data.error) {
                    errorMsg += ' - ' + error.data.error;
                } else if (error.data.message) {
                    errorMsg += ' - ' + error.data.message;
                }
            }
            
            alert(errorMsg);
            closeModal();
        }
    }

    document.querySelector(".back-link").addEventListener("click", function () {
        window.history.back();
    });

    function togglePassword() {
        const passwordInput = document.getElementById('password');
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
        } else {
            passwordInput.type = 'password';
        }
    }
</script>
</main>
</body>
</html>











