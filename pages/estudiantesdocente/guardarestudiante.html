<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar estudiantes</title>
    <link rel="stylesheet" href="../../css/Editar estudiante.css">
    <link rel="stylesheet" href="../../css/navbar.css">
    <link rel="stylesheet" href="../../css/modalactualizar.css">
</head>

<body>
    <header class="header">
        <div class="left-section">
            <h1 class="logo">SICALI</h1>
        </div>
        <div class="user-info">
            <div class="text-info">
                <div class="role">Docente</div>
                <div class="name">Jorge Luis Omalley Pinacho</div>
            </div>
            <div class="avatar"><img src="../../img/nino.png" alt=""></div>
        </div>
    </header>
    
    <nav class="sidebar" id="sidebar">
        <ul class="menu-list">
            <li><a href="../docentes/docente.html"><img class="icon" src="../../icons/docente.svg" alt=""><span class="text">Docentes</span></a></li>
            <li class="active"><a href="estudiante.html"><img class="icon" src="../../icons/estudiante.svg" alt=""><span class="text">Estudiantes</span></a></li>
            <li><a href="../grupos/grupos.html"><img class="icon" src="../../icons/grupos.svg" alt=""><span class="text">Grupos</span></a></li>
            <li><a href="../asignaturas/asignatura.html"><img class="icon" src="../../icons/asignatura.svg" alt=""><span class="text">Asignaturas</span></a></li>
            <li><a href="../estadisticas/Estadisticadirector.html"><img class="icon" src="../../icons/estadisticas.svg" alt=""><span class="text">Estad√≠sticas</span></a></li>
        </ul>
    </nav>

    <main class="content" id="content">
    <button type="button" class="back-link" aria-label="Volver atr√°s">
        <span class="icon"><img src="../../icons/atrass.svg" alt="Flecha atr√°s" /> </span>
        <span class="text">Atr√°s</span>
    </button>

    <section class="editar-estudiante">
  <h2>Estudiante</h2>

  <div class="form-contenedor">
    <div class="form-columna">
      <h3>Estudiante</h3>

      <div class="form-group">
        <label>Nombre:</label>
        <input type="text" value="Antonio">
      </div>

      <div class="form-group">
        <label>Apellido Paterno:</label>
        <input type="text" value="Giron">
      </div>

      <div class="form-group">
        <label>Apellido Materno:</label>
        <input type="text" value="Lopez">
      </div>

      <div class="form-group">
        <label>Grupo:</label>
        <select id="grupoSelect">
          <option value="">Cargando grupos...</option>
        </select>
      </div>

      <div class="form-group">
        <label>Curp:</label>
        <input type="text" value="GILA040702MSCLDRA9">
      </div>

      <div class="form-group">
        <label>Sexo</label>
        <select>
          <option>Seleccionar</option>
          <option>Femenino</option>
          <option>Masculino</option>
        </select>
      </div>

      <div class="form-group">
        <label>Fecha de Nacimiento</label>
        <input type="date">
      </div>
    </div>

    <div class="form-columna">
      <h3>Tutor</h3>

      <div class="form-group">
        <label>Nombre:</label>
        <input type="text" value="Antonio">
      </div>

      <div class="form-group">
        <label>Apellido Paterno:</label>
        <input type="text" value="Giron">
      </div>

      <div class="form-group">
        <label>Apellido Materno:</label>
        <input type="text" value="Garcia">
      </div>

      <div class="form-group">
        <label>Parentesco:</label>
        <input type="text" value="PADRE">
      </div>

      <div class="form-group">
        <label>Sexo</label>
        <select>
          <option>Seleccionar</option>
          <option>Femenino</option>
          <option>Masculino</option>
        </select>
      </div>

      <div class="form-group">
        <label>Fecha de Nacimiento</label>
        <input type="date">
      </div>
    </div>
  </div>

  <div class="boton-agregar">
    <button type="button" onclick="showModal()">
      <img src="../../icons/guardar.svg" class="btn-icon" alt="Guardar">
      Guardar
    </button>
  </div>
</section>

<div id="modal-overlay" class="modal-overlay">
    <div class="modal">
        <img src="../../icons/info.svg" alt="info" class="modal-icon">
        <h3>¬øDesea Actualizarlo?</h3>
        <p>Los datos actuales ser√°n reemplazados por la nueva informaci√≥n</p>
        <div class="modal-buttons">
            <button class="confirm" onclick="confirmSave()">Guardar</button>
            <button class="cancel" onclick="closeModal()">Cancelar</button>
        </div>
    </div>
</div>

<div id="success-modal-overlay" class="modal-overlay"> 
    <div class="modal">
        <img src="../../icons/success.svg" alt="info" class="modal-icon">
        <h3>Actualizado Correctamente</h3>
        <p>Se actualizo la informaci√≥n existente</p>
        <div class="modal-buttons">
            <button class="confirm" onclick="closeSuccessModal()">Aceptar</button>
        </div>
    </div>
</div>

<script>
// Proteger esta p√°gina para docentes y admins
(function() {
    function waitForRouteGuard(roles) {
        if (typeof RouteGuard !== 'undefined') {
            RouteGuard.protect(roles);
        } else {
            setTimeout(function() { waitForRouteGuard(roles); }, 50);
        }
    }
    waitForRouteGuard(['docente', 'admin']);
})();

function showModal() {
    document.getElementById('modal-overlay').style.display = 'flex';
}

function closeModal() {
    document.getElementById('modal-overlay').style.display = 'none';
}

function closeSuccessModal() {
    document.getElementById('success-modal-overlay').style.display = 'none';
    window.location.href = 'estudiante.html';
}

function confirmSave() {
    (async function(){
      try{
        closeModal();
        const form = document.querySelector('.form-contenedor');
        const inputs = form.querySelectorAll('input');
        const selects = form.querySelectorAll('select');
        const nombre = inputs[0] ? inputs[0].value.trim() : '';
        const ape_p = inputs[1] ? inputs[1].value.trim() : '';
        const ape_m = inputs[2] ? inputs[2].value.trim() : '';
        
        const grupoSelect = document.getElementById('grupoSelect');
        const idGrupo = grupoSelect ? Number(grupoSelect.value) || null : null;
        
        const curp = inputs[3] ? inputs[3].value.trim() : '';
        const sexo = (selects[1] && String(selects[1].selectedOptions[0].text||'').toLowerCase().includes('mas')) ? 'M' : (selects[1] && String(selects[1].selectedOptions[0].text||'').toLowerCase().includes('fem') ? 'F' : '');
        const usuarioVal = inputs.length >= 2 ? inputs[inputs.length-2].value.trim() : '';
        const passwordVal = inputs.length >= 1 ? inputs[inputs.length-1].value : '';

        const rfc = curp ? String(curp).toUpperCase().substr(0,13) : '';

        const payload = {
          nombre,
          ape_p,
          ape_m,
          curp,
          rfc,
          sexo,
          usuario: usuarioVal,
          password: passwordVal || 'ChangeMe123',
          rol: 'estudiante',
          estado: 'Activo'
        };

        const validation = usuariosService.validate(payload);
        if (!validation.isValid) {
          alert('Por favor complete todos los campos correctamente:\n' + validation.errors.join('\n'));
          return;
        }

        const id = (new URLSearchParams(location.search)).get('id');
        let estudianteId;
        
        if(id){
          await usuariosService.update(Number(id), payload);
          estudianteId = Number(id);
        } else {
          const nuevoEstudiante = await usuariosService.create(payload);
          estudianteId = nuevoEstudiante.id_usuario || nuevoEstudiante.id;
        }

        // Si se seleccion√≥ un grupo, crear la inscripci√≥n
        if(idGrupo && estudianteId){
          try {
            const inscripcion = {
              idEstudiante: estudianteId,
              idGrupo: idGrupo,
              fechaInscripcion: new Date().toISOString().split('T')[0],
              estado: 'Activo'
            };
            
            console.log('üìù Creando inscripci√≥n estudiante-grupo:', inscripcion);
            const result = await estudianteGrupoService.create(inscripcion);
            console.log('‚úÖ Inscripci√≥n creada:', result);
          } catch(inscErr) {
            if(inscErr.message && inscErr.message.includes('404')) {
              console.warn('‚ö†Ô∏è Endpoint estudiante-grupo no disponible a√∫n (404)');
            } else {
              alert('Advertencia: El estudiante fue guardado pero hubo un error al asignarlo al grupo:\n' + inscErr.message);
            }
          }
        }

        document.getElementById('success-modal-overlay').style.display = 'flex';
      }catch(err){ 
        console.error('‚ùå Error guardando estudiante', err); 
        alert('Error: '+(err.message||err)); 
      }
    })();
}

document.querySelector(".back-link").addEventListener("click", function () {
  window.history.back();
});

// Populate form if editing
(function(){
  function isReady(name){ try{ return typeof eval(name) !== 'undefined'; }catch(e){ return false; } }
  function waitFor(names, timeout=5000){ return new Promise((resolve,reject)=>{ const start=Date.now(); (function poll(){ if(names.every(isReady)) return resolve(); if(Date.now()-start>timeout) return reject(new Error('Servicios no disponibles')); setTimeout(poll,50); })(); }); }
  
  async function loadGrupos() {
    try {
      const grupoSelect = document.getElementById('grupoSelect');
      if (!grupoSelect) return;
      
      grupoSelect.innerHTML = '<option value="">Cargando grupos...</option>';
      
      const grupos = await gruposService.getAll();
      const gruposArray = Array.isArray(grupos) ? grupos : (grupos ? [grupos] : []);
      
      grupoSelect.innerHTML = '<option value="">Seleccionar grupo</option>';
      gruposArray.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.idGrupo || g.id || '';
        opt.textContent = `${g.nombre || ''} (Grado ${g.grado || ''})`;
        grupoSelect.appendChild(opt);
      });
      
      console.log('Grupos cargados:', gruposArray.length);
    } catch (err) {
      console.error('Error cargando grupos:', err);
      const grupoSelect = document.getElementById('grupoSelect');
      if (grupoSelect) grupoSelect.innerHTML = '<option value="">Error al cargar grupos</option>';
    }
  }
  
  waitFor(['usuariosService', 'gruposService', 'estudianteGrupoService']).then(async ()=>{
    await loadGrupos();
    
    const id = (new URLSearchParams(location.search)).get('id');
    if(!id) return;
    try{
      const u = await usuariosService.getById(Number(id));
      if(!u) return;
      const form = document.querySelector('.form-contenedor');
      const inputs = form.querySelectorAll('input');
      const selects = form.querySelectorAll('select');
      if(inputs[0]) inputs[0].value = u.nombre || '';
      if(inputs[1]) inputs[1].value = u.ape_p || '';
      if(inputs[2]) inputs[2].value = u.ape_m || '';
      if(inputs[3]) inputs[3].value = u.curp || '';
      
      const grupoSelect = document.getElementById('grupoSelect');
      if(grupoSelect && u.grupo) {
        const grupoId = u.grupo.idGrupo || u.grupo.id || u.grupo;
        grupoSelect.value = grupoId;
      }
      
      if(selects[1]){ 
        for(const opt of selects[1].options){ 
          if(String(opt.text||'').toLowerCase().includes(String(u.sexo||'').toLowerCase())) 
            opt.selected=true; 
        } 
      }
      if(inputs.length >= 2){ inputs[inputs.length-2].value = u.usuario || ''; }
    }catch(e){ console.error('Error cargando estudiante', e); }
  }).catch(()=>{});
})();
</script>
</main>
  <script src="../../scripts/loadDependencies.js"></script>
</body>
</html>











