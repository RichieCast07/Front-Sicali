<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar estudiantes</title>
    <link rel="stylesheet" href="../../css/agregarestudiante.css">
    <link rel="stylesheet" href="../../css/navbar.css">
    <link rel="stylesheet" href="../../css/modalactualizar.css">
</head>

<body>
    <header class="header">
        <div class="left-section">
            <h1 class="logo">SICALI</h1>
        </div>
        <div class="user-info">
            <div class="text-info">
                <div class="role" id="userRole">Cargando...</div>
                <div class="name" id="userName">Cargando...</div>
            </div>
            <div class="avatar" id="userAvatar">
                <img src="../../img/nino.png" alt="">
            </div>
        </div>
    </header>

    <script>
        // ==========================================
        // CARGAR INFORMACI√ìN DEL USUARIO DIN√ÅMICAMENTE
        // ==========================================
        (function() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userName = document.getElementById('userName');
                const userRole = document.getElementById('userRole');
                
                // Cargar nombre completo
                if (currentUser.nombre && currentUser.ape_p) {
                    const fullName = `${currentUser.nombre} ${currentUser.ape_p} ${currentUser.ape_m || ''}`.trim();
                    userName.textContent = fullName;
                } else {
                    userName.textContent = 'Usuario';
                }

                // Cargar rol din√°micamente
                if (currentUser.rol) {
                    const rolCapitalizado = currentUser.rol.charAt(0).toUpperCase() + currentUser.rol.slice(1);
                    userRole.textContent = rolCapitalizado;
                } else {
                    userRole.textContent = 'Usuario';
                }

                console.log('‚úÖ Usuario cargado:', {
                    nombre: userName.textContent,
                    rol: userRole.textContent,
                    id: currentUser.id_usuario
                });

            } catch (error) {
                console.error('‚ùå Error al cargar datos del usuario:', error);
                document.getElementById('userName').textContent = 'Usuario';
                document.getElementById('userRole').textContent = 'Usuario';
            }
        })();
    </script>

    <!-- Modal Cerrar Sesi√≥n -->
    <div id="logoutModal" class="logout-modal" style="display: none;">
        <button id="logoutBtn" class="logout-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Cerrar Sesi√≥n
        </button>
    </div>

    <nav class="sidebar" id="sidebar">
        <ul class="menu-list">
            <li>
                <a href="../estudiantesdocente/estudiante.html">
                    <span class="icon"><img class="icon" src="../../icons/estudiante.svg" alt=""></span>
                    <span class="text">Estudiantes</span>
                </a>
            </li>
            <li>
                <a href="../tutordocente/tutor.html">
                    <span class="icon"><img class="icon" src="../../icons/tutor.svg" alt=""></span>
                    <span class="text">Tutor</span>
                </a>
            </li>
            <li>
                <a href="../asistencia/asistencia.html">
                    <span class="icon"><img class="icon" src="../../icons/asistencia.svg" alt=""></span>
                    <span class="text">Asistencias</span>
                </a>
            </li>
            <li>
                <a href="../calificaciones/calificaciones.html">
                    <span class="icon"><img class="icon" src="../../icons/calificaciones.svg" alt=""></span>
                    <span class="text">Calificaciones</span>
                </a>
            </li>
            <li>
                <a href="../estadisticas/estadisticasdocente.html">
                    <span class="icon"><img class="icon" src="../../icons/estadisticas.svg" alt=""></span>
                    <span class="text">Estad√≠sticas</span>
                </a>
            </li>
        </ul>
    </nav>
    

    <main class="content" id="content">
    <button type="button" class="back-link" aria-label="Volver atr√°s">
        <span class="icon"><img src="../../icons/atrass.svg" alt="Flecha atr√°s" /> </span>
        <span class="text">Atr√°s</span>
    </button>

    <section class="agregar-estudiante">
  <h2>Agregar Estudiante</h2>
  
  <div class="form-contenedor">
    <div class="form-columna">
      <h3>Estudiante</h3>

      <div class="form-group">
        <label>Nombre:</label>
        <input type="text" placeholder="">
      </div>

      <div class="form-group">
        <label>Apellido Paterno:</label>
        <input type="text" placeholder="">
      </div>

      <div class="form-group">
        <label>Apellido Materno:</label>
        <input type="text" placeholder="">
      </div>

      <div class="form-group">
        <label>Grupo:</label>
        <select id="grupoSelect">
          <option value="">Cargando grupos...</option>
        </select>
      </div>

      <div class="form-group">
        <label>Curp:</label>
        <input type="text"  placeholder="">
      </div>

      <div class="form-group">
        <label>Sexo:</label>
        <select>
          <option>Seleccionar</option>
          <option>Femenino</option>
          <option>Masculino</option>
        </select>
      </div>

      <div class="form-group">
        <label>Fecha de Nacimiento:</label>
        <input type="date"  placeholder="DD/MM/AAAA">
      </div>
    </div>

    <div class="form-columna">
      <h3>Tutor</h3>

      <div class="form-group">
        <label>Seleccionar Tutor:</label>
        <select id="tutorSelect">
          <option value="">Cargando tutores...</option>
        </select>
      </div>

      <div id="tutorInfo" style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px; display: none;">
        <p style="margin: 5px 0;"><strong>Nombre:</strong> <span id="tutorNombre">-</span></p>
        <p style="margin: 5px 0;"><strong>Usuario:</strong> <span id="tutorUsuario">-</span></p>
        <p style="margin: 5px 0;"><strong>Sexo:</strong> <span id="tutorSexo">-</span></p>
      </div>

      <div style="margin-top: 20px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
        <p style="font-size: 14px; color: #1976d2; margin: 0;">
          ‚ÑπÔ∏è <strong>Nota:</strong> Selecciona un tutor existente de la lista. Si necesitas registrar un nuevo tutor, ve al m√≥dulo de Usuarios.
        </p>
      </div>
    </div>
  </div>

  <div class="boton-agregar">
    <button type="button" id="addBtn">
      <img src="../../icons/agregar.svg" class="btn-icon" alt="Agregar">
      Agregar
    </button>
  </div>
</section>

<div id="modal-overlay" class="modal-overlay">
    <div class="modal">
        <img src="../../icons/successverde.svg" alt="success" class="modal-icon success-icon">
        <h3>Agregado Correctamente</h3>
        <p>Este registro se guardo en el sistema</p>
        <div class="modal-buttons">
            <button class="guardar" onclick="closeModal()">Aceptar</button>
        </div>
    </div>
</div>

<script>
    // Proteger esta p√°gina para docentes y directores
    (function() {
        function waitForRouteGuard(roles) {
            if (typeof RouteGuard !== 'undefined') {
                RouteGuard.protect(roles);
            } else {
                setTimeout(function() { waitForRouteGuard(roles); }, 50);
            }
        }
        waitForRouteGuard([docente, 'admin']);
    })();

    (function(){
      function isReady(name){ try{ return typeof eval(name) !== 'undefined'; }catch(e){ return false; } }
      function waitFor(names, timeout=5000){ return new Promise((resolve,reject)=>{ const start=Date.now(); (function poll(){ if(names.every(isReady)) return resolve(); if(Date.now()-start>timeout) return reject(new Error('Servicios no disponibles')); setTimeout(poll,50); })(); }); }

      function sexoToCode(text){ if(!text) return ''; const t = text.toLowerCase(); if(t.includes('mas')) return 'M'; if(t.includes('fem')) return 'F'; return text; }

      // Cargar tutores disponibles
      async function loadTutores() {
        try {
          console.log('üîç Cargando tutores...');
          const usuarios = await usuariosService.getAll();
          console.log('üìä Total usuarios:', usuarios.length);
          const tutores = usuarios.filter(u => u.rol === 'tutor' && u.estado === 'Activo');
          console.log('‚úÖ Tutores encontrados:', tutores.length, tutores);
          
          const select = document.getElementById('tutorSelect');
          select.innerHTML = '<option value="">Seleccionar tutor (opcional)</option>';
          
          tutores.forEach(tutor => {
            const option = document.createElement('option');
            option.value = tutor.id_usuario;
            option.textContent = `${tutor.nombre} ${tutor.ape_p} ${tutor.ape_m || ''}`.trim();
            option.dataset.usuario = tutor.usuario;
            option.dataset.sexo = tutor.sexo === 'M' ? 'Masculino' : tutor.sexo === 'F' ? 'Femenino' : tutor.sexo;
            select.appendChild(option);
          });

          // Mostrar info del tutor al seleccionar
          select.addEventListener('change', function() {
            const selected = this.selectedOptions[0];
            const infoDiv = document.getElementById('tutorInfo');
            
            if (this.value) {
              document.getElementById('tutorNombre').textContent = selected.textContent;
              document.getElementById('tutorUsuario').textContent = selected.dataset.usuario;
              document.getElementById('tutorSexo').textContent = selected.dataset.sexo;
              infoDiv.style.display = 'block';
            } else {
              infoDiv.style.display = 'none';
            }
          });
        } catch (error) {
          console.error('Error cargando tutores:', error);
          document.getElementById('tutorSelect').innerHTML = '<option value="">Error al cargar tutores</option>';
        }
      }

      // Cargar grupos disponibles
      async function loadGrupos() {
        try {
          const grupos = await gruposService.getAll();
          
          const select = document.getElementById('grupoSelect');
          select.innerHTML = '<option value="">Seleccionar grupo (opcional)</option>';
          
          grupos.forEach(grupo => {
            const option = document.createElement('option');
            option.value = grupo.idGrupo;
            option.textContent = `${grupo.nombre} - Grado ${grupo.grado}`;
            select.appendChild(option);
          });
        } catch (error) {
          console.error('Error cargando grupos:', error);
          document.getElementById('grupoSelect').innerHTML = '<option value="">Error al cargar grupos</option>';
        }
      }

      async function createHandler(){
        try{
          const form = document.querySelector('.form-contenedor');
          const inputs = form.querySelectorAll('input');
          const selects = form.querySelectorAll('select');
          
          const nombre = inputs[0] ? inputs[0].value.trim() : '';
          const ape_p = inputs[1] ? inputs[1].value.trim() : '';
          const ape_m = inputs[2] ? inputs[2].value.trim() : '';
          const curp = inputs[3] ? inputs[3].value.trim() : '';
          const sexo = sexoToCode(selects[1] ? selects[1].selectedOptions[0].text : '');
          const fecha = inputs[4] ? inputs[4].value : null;

          // Obtener tutor y grupo seleccionados
          const idTutor = document.getElementById('tutorSelect').value || null;
          const idGrupo = document.getElementById('grupoSelect').value || null;

          // Generate basic user credentials
          const usuario = (nombre && ape_p) ? `${nombre.split(' ')[0].toLowerCase()}.${ape_p.toLowerCase()}` : `user${Date.now()}`;
          const password = 'ChangeMe123';

          // Derive RFC from CURP if not provided
          const rfc = curp ? String(curp).toUpperCase().substr(0,13) : '';

          const payload = {
            nombre,
            ape_p,
            ape_m,
            curp,
            rfc,
            sexo,
            usuario,
            password,
            rol: 'estudiante',
            estado: 'Activo'
          };

          // Agregar idTutor si se seleccion√≥
          if (idTutor) {
            payload.idTutor = parseInt(idTutor);
          }

          console.log('Creando estudiante:', payload);
          const estudianteCreado = await usuariosService.create(payload);
          console.log('Estudiante creado:', estudianteCreado);

          // Guardar tutor en LocalStorage (temporal hasta que backend implemente relaci√≥n)
          if (idTutor && estudianteCreado && estudianteCreado.id_usuario) {
            const estudianteTutorKey = `estudiante_tutor_${estudianteCreado.id_usuario}`;
            localStorage.setItem(estudianteTutorKey, idTutor);
            console.log(`‚úÖ Tutor ${idTutor} asignado a estudiante ${estudianteCreado.id_usuario} (LocalStorage)`);
          }

          // Si se seleccion√≥ un grupo, asignar al estudiante
          if (idGrupo && estudianteCreado && estudianteCreado.id_usuario) {
            try {
              console.log('üìù Asignando estudiante al grupo...');
              const inscripcion = {
                idEstudiante: estudianteCreado.id_usuario,
                idGrupo: parseInt(idGrupo),
                fechaInscripcion: new Date().toISOString().split('T')[0] // Fecha actual
              };
              await estudianteGrupoService.create(inscripcion);
              console.log('‚úÖ Estudiante asignado al grupo correctamente');
            } catch (grupoError) {
              // Distinguir entre endpoint no disponible y otros errores
              if (grupoError.message && grupoError.message.includes('404')) {
                console.warn('‚ö†Ô∏è Endpoint estudiante-grupo no disponible a√∫n (404)');
                console.log('‚ÑπÔ∏è La asignaci√≥n de grupo se realizar√° cuando el backend est√© disponible');
              } else {
                console.error('‚ùå Error al asignar al grupo:', grupoError);
                alert('Estudiante creado, pero hubo un error al asignarlo al grupo: ' + grupoError.message);
              }
            }
          }

          document.getElementById('modal-overlay').style.display = 'flex';
        }catch(err){ 
          console.error('Error creando estudiante',err); 
          alert('Error: '+(err.message||err)); 
        }
      }

      // Hacer closeModal global para que sea accesible desde onclick HTML
      window.closeModal = function() {
        document.getElementById('modal-overlay').style.display = 'none';
        window.location.href = 'estudiante.html';
      }

      waitFor(['usuariosService', 'gruposService', 'estudianteGrupoService']).then(()=>{
        console.log('‚úÖ Servicios cargados correctamente');
        // Cargar datos iniciales
        loadTutores();
        loadGrupos();

        document.querySelector('.form-contenedor').addEventListener('submit', function(e) { e.preventDefault(); });
        document.getElementById('addBtn').addEventListener('click', createHandler);
        document.querySelector(".back-link").addEventListener("click", function () {
          window.history.back();
        });
      }).catch(e=>{ console.error(e); alert(e.message); });
    })();
</script>
</main>
  <script src="../../scripts/loadDependencies.js"></script>
</body>
</html>










