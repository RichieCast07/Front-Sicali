<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar estudiantes</title>
    <link rel="stylesheet" href="../../css/agregarestudiante.css">
    <link rel="stylesheet" href="../../css/navbar.css">
    <link rel="stylesheet" href="../../css/modalactualizar.css">
</head>

<body>
    <header class="header">
        <div class="left-section">
            <h1 class="logo">SICALI</h1>
        </div>
        <div class="user-info">
            <div class="text-info">
                <div class="role">Docente</div>
                <div class="name">Jorge Luis Omalley Pinacho</div>
            </div>
            <div class="avatar"><img src="../../img/nino.png" alt=""></div>
        </div>
    </header>
    
    <nav class="sidebar" id="sidebar">
        <ul class="menu-list">
            <li><span class="icon"> <img class="icon" src="../../icons/estudiante.svg" alt=""></span><span class="text">Estudiantes</span></li>
            <li><a href="../asistencia/asistencia.html"><span class="icon"> <img class="icon" src="../../icons/asistencia.svg" alt=""></span><span class="text">Asistencias</span></a></li>
            <li><a href="../calificaciones/calificaciones.html"><span class="icon"> <img class="icon" src="../../icons/calificaciones.svg" alt=""></span><span class="text">Calificaciones</span></a></li>
            <li><a href="../estadisticas/estadisticasdocente.html"><span class="icon"> <img class="icon" src="../../icons/estadisticas.svg" alt=""></span><span class="text">Estad√≠sticas</span></a></li>
        </ul>
    </nav>
    

    <main class="content" id="content">
    <button type="button" class="back-link" aria-label="Volver atr√°s">
        <span class="icon"><img src="../../icons/atrass.svg" alt="Flecha atr√°s" /> </span>
        <span class="text">Atr√°s</span>
    </button>

    <section class="agregar-estudiante">
  <h2>Agregar Estudiante</h2>
  
  <div class="form-contenedor">
    <div class="form-columna">
      <h3>Estudiante</h3>

      <div class="form-group">
        <label>Nombre:</label>
        <input type="text" placeholder="">
      </div>

      <div class="form-group">
        <label>Apellido Paterno:</label>
        <input type="text" placeholder="">
      </div>

      <div class="form-group">
        <label>Apellido Materno:</label>
        <input type="text" placeholder="">
      </div>

      <div class="form-group">
        <label>Grupo:</label>
        <select id="grupoSelect">
          <option value="">Cargando grupos...</option>
        </select>
      </div>

      <div class="form-group">
        <label>Curp:</label>
        <input type="text"  placeholder="">
      </div>

      <div class="form-group">
        <label>Sexo:</label>
        <select>
          <option>Seleccionar</option>
          <option>Femenino</option>
          <option>Masculino</option>
        </select>
      </div>

      <div class="form-group">
        <label>Fecha de Nacimiento:</label>
        <input type="date"  placeholder="DD/MM/AAAA">
      </div>
    </div>

    <div class="form-columna">
      <h3>Tutor</h3>

      <div class="form-group">
        <label>Nombre:</label>
        <input type="text"  placeholder="">
      </div>

      <div class="form-group">
        <label>Apellido Paterno:</label>
        <input type="text"  placeholder="">
      </div>

      <div class="form-group">
        <label>Apellido Materno:</label>
        <input type="text"  placeholder="">
      </div>

      <div class="form-group">
        <label>Parentesco:</label>
        <input type="text"  placeholder="">
      </div>

      <div class="form-group">
        <label>Sexo:</label>
        <select>
          <option>Seleccionar</option>
          <option>Femenino</option>
          <option>Masculino</option>
        </select>
      </div>

      <div class="form-group">
        <label>Fecha de Nacimiento:</label>
        <input type="date" placeholder="DD/MM/AAAA">
      </div>
    </div>
  </div>

  <div class="boton-agregar">
    <button type="button" id="addBtn">
      <img src="../../icons/agregar.svg" class="btn-icon" alt="Agregar">
      Agregar
    </button>
  </div>
</section>

<div id="modal-overlay" class="modal-overlay">
    <div class="modal">
        <img src="../../icons/successverde.svg" alt="success" class="modal-icon success-icon">
        <h3>Agregado Correctamente</h3>
        <p>Este registro se guardo en el sistema</p>
        <div class="modal-buttons">
            <button class="guardar" onclick="closeModal()">Aceptar</button>
        </div>
    </div>
</div>

<script>
    // Proteger esta p√°gina para docentes y directores
    RouteGuard.protect(['docente', 'director']);

    (function(){
      function isReady(name){ try{ return typeof eval(name) !== 'undefined'; }catch(e){ return false; } }
      function waitFor(names, timeout=5000){ return new Promise((resolve,reject)=>{ const start=Date.now(); (function poll(){ if(names.every(isReady)) return resolve(); if(Date.now()-start>timeout) return reject(new Error('Servicios no disponibles')); setTimeout(poll,50); })(); }); }

      function sexoToCode(text){ if(!text) return ''; const t = text.toLowerCase(); if(t.includes('mas')) return 'M'; if(t.includes('fem')) return 'F'; return text; }

      // Cargar grupos disponibles
      async function loadGrupos() {
        try {
          const grupos = await gruposService.getAll();
          
          const select = document.getElementById('grupoSelect');
          select.innerHTML = '<option value="">Seleccionar grupo (opcional)</option>';
          
          grupos.forEach(grupo => {
            const option = document.createElement('option');
            option.value = grupo.idGrupo;
            option.textContent = `${grupo.nombre} - Grado ${grupo.grado}`;
            select.appendChild(option);
          });
        } catch (error) {
          console.error('Error cargando grupos:', error);
          document.getElementById('grupoSelect').innerHTML = '<option value="">Error al cargar grupos</option>';
        }
      }

      async function createHandler(){
        try{
          const form = document.querySelector('.form-contenedor');
          const inputs = form.querySelectorAll('input');
          const selects = form.querySelectorAll('select');
          
          const nombre = inputs[0] ? inputs[0].value.trim() : '';
          const ape_p = inputs[1] ? inputs[1].value.trim() : '';
          const ape_m = inputs[2] ? inputs[2].value.trim() : '';
          const curp = inputs[3] ? inputs[3].value.trim() : '';
          const sexo = sexoToCode(selects[1] ? selects[1].selectedOptions[0].text : '');
          const fecha = inputs[4] ? inputs[4].value : null;

          // Obtener grupo seleccionado
          const idGrupo = document.getElementById('grupoSelect').value || null;

          // Generate basic user credentials
          const usuario = (nombre && ape_p) ? `${nombre.split(' ')[0].toLowerCase()}.${ape_p.toLowerCase()}` : `user${Date.now()}`;
          const password = 'ChangeMe123';

          // Derive RFC from CURP if not provided
          const rfc = curp ? String(curp).toUpperCase().substr(0,13) : '';

          const payload = {
            nombre,
            ape_p,
            ape_m,
            curp,
            rfc,
            sexo,
            usuario,
            password,
            rol: 'estudiante',
            estado: 'Activo'
          };

          console.log('üìù Creando estudiante:', payload);
          const estudianteCreado = await usuariosService.create(payload);
          console.log('‚úÖ Estudiante creado:', estudianteCreado);

          // Guardar tutor en LocalStorage (temporal hasta que backend implemente relaci√≥n)
          const idTutor = document.getElementById('tutorSelect').value;
          if (idTutor && estudianteCreado && estudianteCreado.id_usuario) {
            const estudianteTutorKey = `estudiante_tutor_${estudianteCreado.id_usuario}`;
            localStorage.setItem(estudianteTutorKey, idTutor);
            console.log(`‚úÖ Tutor ${idTutor} asignado a estudiante ${estudianteCreado.id_usuario} (LocalStorage)`);
          }

          // Si se seleccion√≥ un grupo, asignar al estudiante
          if (idGrupo && estudianteCreado && estudianteCreado.id_usuario) {
            try {
              console.log('üìù Asignando estudiante al grupo...');
              const inscripcion = {
                idEstudiante: estudianteCreado.id_usuario,
                idGrupo: parseInt(idGrupo),
                fechaInscripcion: new Date().toISOString().split('T')[0],
                estado: 'Activo'
              };
              await estudianteGrupoService.create(inscripcion);
              console.log('‚úÖ Estudiante asignado al grupo correctamente');
            } catch (grupoError) {
              if (grupoError.message && grupoError.message.includes('404')) {
                console.warn('‚ö†Ô∏è Endpoint estudiante-grupo no disponible a√∫n (404)');
                console.log('‚ÑπÔ∏è La asignaci√≥n de grupo se realizar√° cuando el backend est√© disponible');
              } else {
                console.error('‚ùå Error al asignar al grupo:', grupoError);
                alert('Estudiante creado, pero hubo un error al asignarlo al grupo: ' + grupoError.message);
              }
            }
          }

          document.getElementById('modal-overlay').style.display = 'flex';
        }catch(err){ 
          console.error('‚ùå Error creando estudiante',err); 
          alert('Error: '+(err.message||err)); 
        }
      }

      function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
        window.location.href = 'estudiante.html';
      }

      waitFor(['usuariosService', 'gruposService', 'estudianteGrupoService']).then(()=>{
        // Cargar datos iniciales
        loadGrupos();

        // Event listeners
        document.getElementById('addBtn').addEventListener('click', createHandler);
        document.querySelector(".back-link").addEventListener("click", function () {
          window.history.back();
        });
      }).catch(e=>{ console.error(e); alert(e.message); });
    })();
</script>
</main>
  <script src="../../scripts/loadDependencies.js"></script>
</body>
</html>










