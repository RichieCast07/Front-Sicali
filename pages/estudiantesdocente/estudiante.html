<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudiantes</title>
    <link rel="stylesheet" href="../../css/estudiantes.css">
    <link rel="stylesheet" href="../../css/navbar.css">
    <link rel="stylesheet" href="../../css/modalactualizar.css">
</head>

<body>
    <header class="header">
        <div class="left-section">
            <h1 class="logo">SICALI</h1>
        </div>
        <div class="user-info">
            <div class="text-info">
                <div class="role">Docente</div>
                <div class="name" id="userName">Cargando...</div>
            </div>
            <div class="avatar"><img src="../../img/nino.png" alt=""></div>
        </div>
    </header>
    
    <nav class="sidebar" id="sidebar">
        <ul class="menu-list">
            <li><span class="icon"> <img class="icon" src="../../icons/estudiante.svg" alt=""></span><span class="text">Estudiantes</span></li>
            <li><a href="../asistencia/asistencia.html"><span class="icon"> <img class="icon" src="../../icons/asistencia.svg" alt=""></span><span class="text">Asistencias</span></a></li>
            <li><a href="../calificaciones/calificaciones.html"><span class="icon"> <img class="icon" src="../../icons/calificaciones.svg" alt=""></span><span class="text">Calificaciones</span></a></li>
            <li><a href="../estadisticas/estadisticasdocente.html"><span class="icon"> <img class="icon" src="../../icons/estadisticas.svg" alt=""></span><span class="text">EstadÃ­sticas</span></a></li>
        </ul>
    </nav>

    <main class="content" id="content">
            <section class="docentes-section">
            <h1 class="titulo">Estudiantes</h1>

            <div class="acciones-superiores">
                <div class="buscador-con-icono">
                    <img src="../../icons/buscador.svg" alt="Icono de buscador" class="icono-input" />
                    <input type="text" placeholder="Buscar" id="buscarDocente" />
                </div>

                <div class="agregar">
                    <label for="">Estudiante</label>
                    <button class="btn-agregar" onclick="window.location.href='agregarestudiante.html'">
                      <img src="../../icons/agregar.svg" alt="Icono agregar" class="icono-agregar"/>
                        Agregar
                    </button>
                </div>
            </div>

            <table class="tabla-docentes">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Nombre</th>
                        <th>Apellido Paterno</th>
                        <th>Apellido Materno</th>
                        <th>CURP</th>
                        <th>Grupo</th>
                        <th>Tutor</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="8" style="text-align:center;padding:40px;color:#666">Cargando estudiantes...</td>
                    </tr>
                </tbody>
            </table>
        </section>


<div id="delete-modal-overlay" class="modal-overlay">
    <div class="modal">
        <img src="../../icons/inforojo.svg" alt="eliminar" class="modal-icon">
        <h3>Â¿Desea eliminarlo?</h3>
        <p>Estas acciÃ³n es permanente y no podrÃ¡ deshacerse</p>
        <div class="modal-buttons">
            <button class="eliminar" onclick="confirmDelete()">Eliminar</button>
            <button class="cancel" onclick="closeDeleteModal()">Cancelar</button>
        </div>
    </div>
</div>

<div id="delete-success-modal-overlay" class="modal-overlay">
    <div class="modal">
        <img src="../../icons/successrojo.svg" alt="success" class="modal-icon">
        <h3>Eliminado correctamente</h3>
        <p>El registro que seleccionaste se elimino del sistema</p>
        <div class="modal-buttons">
            <button class="eliminar" onclick="closeDeleteSuccessModal()">Aceptar</button>
        </div>
    </div>
</div>

<script>
// Proteger esta pÃ¡gina para docentes y admins
(function() {
    function waitForRouteGuard(roles) {
        if (typeof RouteGuard !== 'undefined') {
            RouteGuard.protect(roles);
        } else {
            setTimeout(function() { waitForRouteGuard(roles); }, 50);
        }
    }
    waitForRouteGuard(['docente', 'admin']);
})();

(function(){
    // Cargar informaciÃ³n del docente logueado
    (function() {
        try {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const userName = document.getElementById('userName');
            
            if (currentUser.nombre && currentUser.ape_p) {
                const fullName = `${currentUser.nombre} ${currentUser.ape_p} ${currentUser.ape_m || ''}`.trim();
                userName.textContent = fullName;
            } else {
                userName.textContent = 'Usuario';
            }
        } catch (error) {
            console.error('Error al cargar datos del usuario:', error);
            document.getElementById('userName').textContent = 'Usuario';
        }
    })();
    
    function isReady(name){ try{ return typeof eval(name) !== 'undefined'; }catch(e){ return false; } }
    function waitFor(names, timeout=5000){ return new Promise((resolve,reject)=>{ const start=Date.now(); (function poll(){ if(names.every(isReady)) return resolve(); if(Date.now()-start>timeout) return reject(new Error('Servicios no disponibles')); setTimeout(poll,50); })(); }); }
    function escapeHtml(str){ if(!str) return ''; const div = document.createElement('div'); div.textContent = String(str); return div.innerHTML; }
    
    let idToDelete = null;
    
    window.showDeleteModal = function(){ document.getElementById('delete-modal-overlay').style.display = 'flex'; };
    window.closeDeleteModal = function(){ document.getElementById('delete-modal-overlay').style.display = 'none'; };
    window.closeDeleteSuccessModal = function(){ document.getElementById('delete-success-modal-overlay').style.display = 'none'; };
    
    async function loadAndRender(){
        try{
            console.log('ðŸ‘¥ Cargando estudiantes del docente...');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            if (!currentUser.id_usuario) {
                console.error('âŒ No se encontrÃ³ informaciÃ³n del docente');
                return;
            }
            
            console.log('ðŸ‘¤ Docente ID:', currentUser.id_usuario);
            
            // Obtener grupos del docente
            const todosGrupos = await gruposService.getAll();
            const gruposDocente = todosGrupos.filter(g => {
                const docenteId = g.idDocente?.id_usuario || g.idDocente;
                return Number(docenteId) === Number(currentUser.id_usuario);
            });
            
            console.log('ðŸ“š Grupos del docente:', gruposDocente.length);
            
            if (gruposDocente.length === 0) {
                const tbody = document.querySelector('.tabla-docentes tbody');
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:40px;color:#666">No tienes grupos asignados. Contacta al director.</td></tr>`;
                return;
            }
            
            // Obtener IDs de los grupos del docente
            const gruposDocenteIds = gruposDocente.map(g => Number(g.idGrupo));
            console.log('ðŸ“‹ IDs de grupos:', gruposDocenteIds);
            
            // Obtener todas las inscripciones
            const allEstudianteGrupo = await estudianteGrupoService.getAll();
            console.log('âœ… Total inscripciones:', allEstudianteGrupo.length);
            
            // Filtrar solo inscripciones de los grupos del docente
            const inscripcionesDocente = allEstudianteGrupo.filter(insc => {
                const grupoId = insc.idGrupo || insc.grupo?.idGrupo;
                return gruposDocenteIds.includes(Number(grupoId));
            });
            
            console.log('âœ… Inscripciones en grupos del docente:', inscripcionesDocente.length);
            
            // Obtener IDs Ãºnicos de estudiantes
            const estudiantesIds = [...new Set(inscripcionesDocente.map(insc => {
                return insc.idEstudiante || insc.estudiante?.id_usuario;
            }))];
            
            console.log('ðŸ‘¨â€ðŸŽ“ Total estudiantes Ãºnicos:', estudiantesIds.length);
            
            // Obtener todos los estudiantes
            const todosEstudiantes = await usuariosService.getByRol('estudiante');
            
            // Filtrar solo los estudiantes del docente
            const students = todosEstudiantes.filter(s => 
                estudiantesIds.includes(s.id_usuario)
            );
            
            console.log('âœ… Estudiantes filtrados:', students.length);
            
            let gruposMap = new Map();
            let tutoresMap = new Map();
            
            try {
                // Cargar tutores
                const allTutores = await usuariosService.getByRol('tutor');
                const tutoresArray = Array.isArray(allTutores) ? allTutores : (allTutores ? [allTutores] : []);
                tutoresArray.forEach(t => tutoresMap.set(t.id_usuario, t));
                
                // Mapear grupos por estudiante
                inscripcionesDocente.forEach(eg => {
                    const idEst = eg.idEstudiante || eg.estudiante?.id_usuario;
                    if (idEst) {
                        if (!gruposMap.has(idEst)) {
                            gruposMap.set(idEst, []);
                        }
                        gruposMap.get(idEst).push(eg);
                    }
                });
            } catch (loadError) {
                console.error('Error cargando datos adicionales:', loadError);
            }
            
            const tbody = document.querySelector('.tabla-docentes tbody');
            const newTbody = tbody.cloneNode(false);

            if(!students.length){
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="8" style="text-align:center;padding:40px;color:#666">No hay estudiantes en tus grupos</td>`;
                newTbody.appendChild(tr);
                tbody.parentNode.replaceChild(newTbody, tbody);
                return;
            }

            students.forEach((s, idx) => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-id', s.id || s.id_usuario || '');
                
                const estudianteGrupos = gruposMap.get(s.id_usuario) || [];
                const grupoNames = estudianteGrupos.map(eg => {
                    if (eg.grupo && eg.grupo.nombre) {
                        return `${eg.grupo.nombre} (Grado ${eg.grupo.grado || ''})`;
                    }
                    return eg.idGrupo ? `Grupo ${eg.idGrupo}` : '';
                }).filter(g => g).join(', ') || '-';
                
                // Obtener tutor del estudiante desde LocalStorage (temporal hasta que backend implemente)
                const estudianteTutorKey = `estudiante_tutor_${s.id_usuario}`;
                const idTutorGuardado = localStorage.getItem(estudianteTutorKey);
                const tutor = idTutorGuardado ? tutoresMap.get(Number(idTutorGuardado)) : null;
                const tutorName = tutor ? `${tutor.nombre} ${tutor.ape_p}`.trim() : '-';
                
                tr.innerHTML = `
                    <td>${idx+1}</td>
                    <td>${escapeHtml(s.nombre)}</td>
                    <td>${escapeHtml(s.ape_p)}</td>
                    <td>${escapeHtml(s.ape_m)}</td>
                    <td>${escapeHtml(s.curp||'')}</td>
                    <td>${escapeHtml(grupoNames)}</td>
                    <td>${escapeHtml(tutorName)}</td>
                    <td>
                        <button class="btn-editar"><img src="../../icons/visualizar.svg" alt="visualizar"/></button>
                        <button class="btn-eliminar"><img src="../../icons/eliminar.svg" alt="Eliminar"/></button>
                    </td>`;
                newTbody.appendChild(tr);

                const editBtn = tr.querySelector('.btn-editar');
                editBtn.addEventListener('click', () => { window.location.href = 'editarestudiante.html?id=' + encodeURIComponent(s.id || s.id_usuario); });

                const delBtn = tr.querySelector('.btn-eliminar');
                delBtn.addEventListener('click', (e) => { e.preventDefault(); idToDelete = s.id || s.id_usuario; showDeleteModal(); });
            });

            tbody.parentNode.replaceChild(newTbody, tbody);
            setupSearch();
        }catch(err){ console.error('Error cargando estudiantes:', err); }
    }

    function setupSearch(){
        const searchInput = document.getElementById('buscarDocente');
        if(!searchInput) return;
        
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            const rows = document.querySelectorAll('.tabla-docentes tbody tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if(cells.length === 0) return;
                
                const nombre = cells[1]?.textContent.toLowerCase() || '';
                const apeP = cells[2]?.textContent.toLowerCase() || '';
                const apeM = cells[3]?.textContent.toLowerCase() || '';
                const curp = cells[4]?.textContent.toLowerCase() || '';
                const grupo = cells[5]?.textContent.toLowerCase() || '';
                const tutor = cells[6]?.textContent.toLowerCase() || '';
                
                const matches = nombre.includes(searchTerm) || 
                              apeP.includes(searchTerm) || 
                              apeM.includes(searchTerm) || 
                              curp.includes(searchTerm) || 
                              grupo.includes(searchTerm) ||
                              tutor.includes(searchTerm);
                
                row.style.display = matches ? '' : 'none';
            });
        });
    }

    window.confirmDelete = async function(){
        try{
            closeDeleteModal();
            if(!idToDelete) return;
            await usuariosService.delete(Number(idToDelete));
            idToDelete = null;
            await loadAndRender();
            document.getElementById('delete-success-modal-overlay').style.display = 'flex';
        }catch(err){ console.error('Error eliminando estudiante:', err); alert('Error eliminando: '+(err.message||err)); }
    };

    waitFor(['usuariosService', 'estudianteGrupoService', 'gruposService']).then(loadAndRender).catch(err => console.warn('No se cargaron los servicios:', err.message));
})();
</script>
    </main>
        <script src="../../scripts/loadDependencies.js"></script>
    </body>
    </html>











