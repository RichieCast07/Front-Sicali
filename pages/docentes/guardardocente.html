<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Docente</title>
  <link rel="stylesheet" href="../../css/editardocente.css">
  <link rel="stylesheet" href="../../css/navbar.css">
  <link rel="stylesheet" href="../../css/modalactualizar.css">
</head>

<body>
  <header class="header">
    <div class="left-section">
      <h1 class="logo">SICALI</h1>
    </div>
    <div class="user-info">
      <div class="text-info">
        <div class="role">Director</div>
        <div class="name">Jorge Luis Omalley Pinacho</div>
      </div>
      <div class="avatar"><img src="../../img/nino.png" alt=""></div>
    </div>
  </header>

    <nav class="sidebar" id="sidebar">
        <ul class="menu-list">
            <li class="active"><a href="./docente.html"><img class="icon" src="../../icons/docente.svg" alt=""><span class="text">Docentes</span></a></li>
            <li><a href="../estudiantes/estudiante.html"><img class="icon" src="../../icons/estudiante.svg" alt=""><span class="text">Estudiantes</span></a></li>
            <li ><a href="../grupos/grupos.html"><img class="icon" src="../../icons/grupos.svg" alt=""><span class="text">Grupos</span></a></li>
            <li><a href="../asignaturas/asignatura.html"><img class="icon" src="../../icons/asignatura.svg" alt=""><span class="text">Asignaturas</span></a></li>
            <li><a href="../estadisticas/Estadisticadirector.html"><img class="icon" src="../../icons/estadisticas.svg" alt=""><span class="text">Estadísticas</span></a></li>
        </ul>
    </nav>

  <main class="content">
    <button type="button" class="back-link">
      <span class="icon"><img src="../../icons/atrass.svg" alt="Flecha atrás" /></span>
      <span class="text">Atrás</span>
    </button>

    <section class="editar-docente">
      <h2>Docente</h2>

      <form class="form-docente">
        <div class="form-row">
          <div class="form-group">
            <label>Nombre:</label>
            <input type="text" value="alejandra">
          </div>
          <div class="form-group">
            <label>RFC:</label>
            <input type="text" value="VETA850621det">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Apellido Paterno:</label>
            <input type="text" value="vela">
          </div>
          <div class="form-group">
            <label>CURP:</label>
            <input type="text" value="VETA850621MDFLLRA9">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Apellido Materno:</label>
            <input type="text" value="torrez">
          </div>
          <div class="form-group">
            <label>Sexo:</label>
            <select>
              <option>Seleccionar</option>
              <option>Masculino</option>
              <option selected>Femenino</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Fecha de Nacimiento:</label>
            <input type="date" value="1985-06-21">
          </div>
          <div class="form-group">
            <label>Usuario:</label>
            <input type="text" value="alejandra.vela">
          </div>
         <div class="form-group" style="position: relative;">
          <label>Contraseña:</label>
          <input type="password" id="password" value="1sicali">
          <button type="button" onclick="togglePassword()" style="position: absolute; right: 10px; top: 32px;">
            <span class="iconpasswor"><img src="../../icons/visualizar password.svg" alt="Flecha atrás" /></span>
          </button>
         </div>
        </div>


        <div class="boton-editar">
          <button type="button" onclick="showModal()" class="btn-editar">
            <img src="../../icons/guardar.svg" class="btn-icon" alt="Guardar">
            Guardar
          </button>
        </div>
      </form>
    </section>


<div id="modal-overlay" class="modal-overlay">
   <div class="modal">
       <img src="../../icons/info.svg" alt="info" class="modal-icon">
       <h3>¿Desea Actualizarlo?</h3>
       <p>Los datos actuales serán reemplazados por la nueva información</p>
       <div class="modal-buttons">
           <button class="confirm" onclick="confirmSave()">Guardar</button>
           <button class="cancel" onclick="closeModal()">Cancelar</button>
       </div>
   </div>
</div>

<div id="success-modal-overlay" class="modal-overlay">
   <div class="modal">
       <img src="../../icons/success.svg" alt="info" class="modal-icon">
       <h3>Actualizado Correctamente</h3>
       <p>Se actualizo la información existente</p>
       <div class="modal-buttons">
           <button class="confirm" onclick="closeSuccessModal()">Aceptar</button>
       </div>
   </div>
</div>

<script>
// Proteger esta página solo para directores
(function() {
    function waitForRouteGuard(roles) {
        if (typeof RouteGuard !== 'undefined') {
            RouteGuard.protect(roles);
        } else {
            setTimeout(function() { waitForRouteGuard(roles); }, 50);
        }
    }
    waitForRouteGuard(['director']);
})();

function showModal() {
   document.getElementById('modal-overlay').style.display = 'flex';
}

function closeModal() {
   document.getElementById('modal-overlay').style.display = 'none';
}

function closeSuccessModal() {
   document.getElementById('success-modal-overlay').style.display = 'none';
   // Redirigir a la lista de docentes
   window.location.href = 'docente.html';
}

function confirmSave() {
   // Perform save via API (create or update depending on query id)
   (async function(){
     try{
       closeModal();
       const form = document.querySelector('.form-docente');
       const inputs = form.querySelectorAll('input');
       const nombre = inputs[0] ? inputs[0].value.trim() : '';
       const rfc = inputs[1] ? inputs[1].value.trim() : '';
       const ape_p = inputs[2] ? inputs[2].value.trim() : '';
       const curp = inputs[3] ? inputs[3].value.trim() : '';
       const ape_m = inputs[4] ? inputs[4].value.trim() : '';
       const fecha = inputs[5] ? inputs[5].value : null;
       const usuarioVal = inputs[6] ? inputs[6].value.trim() : '';
       const passwordVal = inputs[7] ? inputs[7].value : '';
       const sexoSel = form.querySelector('select');
       const sexoText = sexoSel ? sexoSel.selectedOptions[0].text : '';
       const sexo = (String(sexoText||'').toLowerCase().includes('mas')) ? 'M' : (String(sexoText||'').toLowerCase().includes('fem') ? 'F' : sexoText);

       const payload = {
         nombre,
         ape_p,
         ape_m,
         curp,
         rfc,
         sexo,
         usuario: usuarioVal,
         password: passwordVal || 'ChangeMe123', // Siempre incluir password
         rol: 'docente',
         estado: 'Activo'
       };

       // Validar que todos los campos estén completos
       const validation = usuariosService.validate(payload);
       if (!validation.isValid) {
         alert('Por favor complete todos los campos correctamente:\n' + validation.errors.join('\n'));
         return;
       }

       const id = (new URLSearchParams(location.search)).get('id');
       if(id){
         await usuariosService.update(Number(id), payload);
       } else {
         await usuariosService.create(payload);
       }

       document.getElementById('success-modal-overlay').style.display = 'flex';
     }catch(err){ console.error('Error guardando docente', err); alert('Error: '+(err.message||err)); }
   })();
}

// On load: if id present, populate form with usuario data
(function(){
  function isReady(name){ try{ return typeof eval(name) !== 'undefined'; }catch(e){ return false; } }
  function waitFor(names, timeout=5000){ return new Promise((resolve,reject)=>{ const start=Date.now(); (function poll(){ if(names.every(isReady)) return resolve(); if(Date.now()-start>timeout) return reject(new Error('Servicios no disponibles')); setTimeout(poll,50); })(); }); }

  waitFor(['usuariosService']).then(async ()=>{
    const id = (new URLSearchParams(location.search)).get('id');
    if(!id) return;
    try{
      const u = await usuariosService.getById(Number(id));
      if(!u) return;
      const form = document.querySelector('.form-docente');
      const inputs = form.querySelectorAll('input');
      if(inputs[0]) inputs[0].value = u.nombre || '';
      if(inputs[1]) inputs[1].value = u.rfc || '';
      if(inputs[2]) inputs[2].value = u.ape_p || '';
      if(inputs[3]) inputs[3].value = u.curp || '';
      if(inputs[4]) inputs[4].value = u.ape_m || '';
      if(inputs[5]) inputs[5].value = u.fechaNacimiento || '';
      if(inputs[6]) inputs[6].value = u.usuario || '';
      if(inputs[7]) inputs[7].value = '';
      const sexoSel = form.querySelector('select');
      if(sexoSel){ for(const opt of sexoSel.options){ if(String(opt.text||'').toLowerCase().includes(String(u.sexo||'').toLowerCase())) opt.selected=true; } }
    }catch(e){ console.error('Error cargando usuario', e); }
  }).catch(()=>{});

  document.querySelector(".back-link").addEventListener("click", function () { window.history.back(); });
})();

     function togglePassword() {
      const passwordInput = document.getElementById('password');
      if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
  } else {
    passwordInput.type = 'password';
  }}

</script>
  </main>
    <script src="../../scripts/loadDependencies.js"></script>
  </body>
  </html>













