<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docentes</title>
    <link rel="stylesheet" href="../../css/docentes.css">
    <link rel="stylesheet" href="../../css/navbar.css">
    <link rel="stylesheet" href="../../css/modalactualizar.css">
</head>

<body>
    <header class="header">
        <div class="left-section">
            <h1 class="logo">SICALI</h1>
        </div>
        <div class="user-info">
            <div class="text-info">
                <div class="role">Director</div>
                <div class="name">Jorge Luis Omalley Pinacho</div>
            </div>
            <div class="avatar"><img src="../../img/nino.png" alt=""></div>
        </div>
    </header>
    <script>
    // Enhancer: carga y renderiza docentes desde la API usando usuariosService
    (function(){
        let idToDelete = null;

        function waitFor(names, timeout = 5000) {
            return new Promise((resolve, reject) => {
                const start = Date.now();
                (function poll() {
                    try {
                        const ok = names.every(n => { try { return typeof eval(n) !== 'undefined'; } catch(e){ return false; } });
                        if (ok) return resolve();
                    } catch (e) {}
                    if (Date.now() - start > timeout) return reject(new Error('Servicios no disponibles: ' + names.join(',')));
                    setTimeout(poll, 50);
                })();
            });
        }

        function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

        async function loadAndRender(){
            try{
                console.log('üë§ Iniciando carga de docentes...');
                const raw = await usuariosService.getByRol('docente');
                console.log('‚úÖ Respuesta API:', raw);
                
                const docs = Array.isArray(raw) ? raw : (raw ? [raw] : []);
                console.log('üìä Total docentes:', docs.length);
                
                const tbody = document.querySelector('.tabla-docentes tbody');
                const newTbody = tbody.cloneNode(false);

                if(!docs.length){
                    console.log('‚ö†Ô∏è No hay docentes registrados');
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="6" style="text-align:center;padding:16px;color:#666">No hay docentes registrados</td>`;
                    newTbody.appendChild(tr);
                    tbody.parentNode.replaceChild(newTbody, tbody);
                    return;
                }

                docs.forEach((d, idx) => {
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-id', d.id || d.id_usuario || '');
                    tr.innerHTML = `
                        <td>${idx+1}</td>
                        <td>${escapeHtml(d.nombre)}</td>
                        <td>${escapeHtml(d.ape_p)}</td>
                        <td>${escapeHtml(d.ape_m)}</td>
                        <td>${escapeHtml(d.rfc||'')}</td>
                        <td>
                            <button class="btn-editar"><img src="../../icons/visualizar.svg" alt="visualizar"/></button>
                            <button class="btn-eliminar"><img src="../../icons/eliminar.svg" alt="Eliminar"/></button>
                        </td>`;
                    newTbody.appendChild(tr);

                    const editBtn = tr.querySelector('.btn-editar');
                    editBtn.addEventListener('click', () => { window.location.href = 'editardocente.html?id=' + encodeURIComponent(d.id || d.id_usuario); });

                    const delBtn = tr.querySelector('.btn-eliminar');
                    delBtn.addEventListener('click', (e) => { e.preventDefault(); idToDelete = d.id || d.id_usuario; showDeleteModal(); });
                });

                tbody.parentNode.replaceChild(newTbody, tbody);
                console.log('‚úÖ Tabla renderizada exitosamente');
                setupSearch();
            }catch(err){ 
                console.error('‚ùå Error cargando docentes:', err); 
                alert('Error cargando docentes: ' + (err.message || err));
            }
        }

        // Setup search functionality
        function setupSearch(){
            const searchInput = document.getElementById('buscarDocente');
            if(!searchInput) return;
            
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const rows = document.querySelectorAll('.tabla-docentes tbody tr');
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if(cells.length === 0) return;
                    
                    // Buscar en nombre, apellidos y RFC (columnas 1-5)
                    const nombre = cells[1]?.textContent.toLowerCase() || '';
                    const apeP = cells[2]?.textContent.toLowerCase() || '';
                    const apeM = cells[3]?.textContent.toLowerCase() || '';
                    const rfc = cells[4]?.textContent.toLowerCase() || '';
                    
                    const matches = nombre.includes(searchTerm) || 
                                  apeP.includes(searchTerm) || 
                                  apeM.includes(searchTerm) || 
                                  rfc.includes(searchTerm);
                    
                    row.style.display = matches ? '' : 'none';
                });
            });
        }

        // Implement confirmDelete to call API and refresh
        window.confirmDelete = async function(){
            try{
                closeDeleteModal();
                if(!idToDelete) return;
                await usuariosService.delete(Number(idToDelete));
                idToDelete = null;
                await loadAndRender();
                document.getElementById('delete-success-modal-overlay').style.display = 'flex';
            }catch(err){ console.error('Error eliminando docente (enhancer)', err); alert('Error eliminando: '+(err.message||err)); }
        };

        console.log('üîç Esperando usuariosService...');
        waitFor(['usuariosService'])
            .then(() => {
                console.log('‚úÖ usuariosService disponible');
                return loadAndRender();
            })
            .catch(err => {
                console.error('‚ùå Error cargando servicio:', err);
                alert('Error: No se pudo cargar el servicio de usuarios');
            });
    })();
    </script>
    
    <nav class="sidebar" id="sidebar">
        <ul class="menu-list">
            <li class="active"><a href=""><img class="icon" src="../../icons/docente.svg" alt=""><span class="text">Docentes</span></a></li>
            <li><a href="../estudiantes/estudiante.html"><img class="icon" src="../../icons/estudiante.svg" alt=""><span class="text">Estudiantes</span></a></li>
            <li ><a href="../grupos/grupos.html"><img class="icon" src="../../icons/grupos.svg" alt=""><span class="text">Grupos</span></a></li>
            <li><a href="../asignaturas/asignatura.html"><img class="icon" src="../../icons/asignatura.svg" alt=""><span class="text">Asignaturas</span></a></li>
            <li><a href="../estadisticas/Estadisticadirector.html"><img class="icon" src="../../icons/estadisticas.svg" alt=""><span class="text">Estad√≠sticas</span></a></li>
        </ul>
    </nav>

    <main class="content" id="content">
            <section class="docentes-section">
            <h1 class="titulo">Docentes</h1>

            <div class="acciones-superiores">
                <div class="buscador-con-icono">
                    <img src="../../icons/buscador.svg" alt="Icono de buscador" class="icono-input" />
                    <input type="text" placeholder="Buscar" id="buscarDocente" />
                </div>

                <div class="agregar">
                    <label for="">Docente</label>
                    <button class="btn-agregar" onclick="window.location.href='agregardocente.html'">
                      <img src="../../icons/agregar.svg" alt="Icono agregar" class="icono-agregar"/>
                        Agregar
                    </button>
                </div>
            </div>

            <table class="tabla-docentes">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Nombre</th>
                        <th>Apellido Paterno</th>
                        <th>Apellido Materno</th>
                        <th>RFC</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td>alejandra</td>
                        <td>vela</td>
                        <td>torrez</td>
                        <td>VETA850621det</td>
                        <td>
                            <button class="btn-editar" onclick="window.location.href='editardocente.html'"><img src="../../icons/visualizar.svg" alt="visualizar"/></button>
                            <button class="btn-eliminar" onclick="showDeleteModal()"><img src="../../icons/eliminar.svg" alt="Eliminar"/></button>
                        </td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Juan</td>
                        <td>P√©rez</td>
                        <td>Mart√≠nez</td>
                        <td>PEMJ800914wvb</td>
                        <td>
                            <button class="btn-editar" onclick="window.location.href='editardocente.html'"><img src="../../icons/visualizar.svg" alt="visualizar"/></button>
                            <button class="btn-eliminar" onclick="showDeleteModal()"><img src="../../icons/Eliminar.svg" alt="Eliminar"/></button>
                        </td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Ana</td>
                        <td>Garc√≠a</td>
                        <td>Garcia</td>
                        <td>GAOA901110dnd</td>
                        <td>
                            <button class="btn-editar" onclick="window.location.href='editardocente.html'"><img src="../../icons/visualizar.svg" alt="visualizar"/></button>
                            <button class="btn-eliminar" onclick="showDeleteModal()"><img src="../../icons/Eliminar.svg" alt="Eliminar"/></button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>

<div id="delete-modal-overlay" class="modal-overlay">
   <div class="modal">
       <img src="../../icons/inforojo.svg" alt="eliminar" class="modal-icon">
       <h3>¬øDesea eliminarlo?</h3>
       <p>Estas acci√≥n es permanente y no podr√° deshacerse</p>
       <div class="modal-buttons">
           <button class="eliminar" onclick="window.confirmDelete()">Eliminar</button>
           <button class="cancel" onclick="closeDeleteModal()">Cancelar</button>
       </div>
   </div>
</div>

<div id="delete-success-modal-overlay" class="modal-overlay">
   <div class="modal">
       <img src="../../icons/successrojo.svg" alt="success" class="modal-icon">
       <h3>Eliminado correctamente</h3>
       <p>El registro que seleccionaste se elimino del sistema</p>
       <div class="modal-buttons">
           <button class="eliminar" onclick="closeDeleteSuccessModal()">Aceptar</button>
       </div>
   </div>
</div>

<script>
// Proteger esta p√°gina solo para directores
(function() {
    function waitForRouteGuard(roles) {
        if (typeof RouteGuard !== 'undefined') {
            RouteGuard.protect(roles);
        } else {
            setTimeout(function() { waitForRouteGuard(roles); }, 50);
        }
    }
    waitForRouteGuard(['director']);
})();

function showDeleteModal() {
    document.getElementById('delete-modal-overlay').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('delete-modal-overlay').style.display = 'none';
}

/* confirmDelete is implemented by the enhancer and performs the API delete */

function closeDeleteSuccessModal() {
     document.getElementById('delete-success-modal-overlay').style.display = 'none';
}
</script>
</main>
    <script src="../../scripts/loadDependencies.js"></script>
</body>
</html>











