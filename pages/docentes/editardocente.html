<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizar Docente</title>
  <link rel="stylesheet" href="../../css/editardocente.css">
  <link rel="stylesheet" href="../../css/navbar.css">
</head>

<body>
  <header class="header">
    <div class="left-section">
      <h1 class="logo">SICALI</h1>
    </div>
    <div class="user-info">
      <div class="text-info">
        <div class="role" id="userRole">Cargando...</div>
        <div class="name" id="userName">Cargando...</div>
      </div>
      <div class="avatar"><img src="../../img/nino.png" alt=""></div>
    </div>
  </header>

  <script>
    // ==========================================
    // CARGAR INFORMACI√ìN DEL USUARIO DIN√ÅMICAMENTE
    // ==========================================
    (function() {
        try {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            
            if (currentUser.nombre && currentUser.ape_p) {
                const fullName = (currentUser.nombre + ' ' + currentUser.ape_p + ' ' + (currentUser.ape_m || '')).trim();
                userName.textContent = fullName;
            } else {
                userName.textContent = 'Usuario';
            }

            if (currentUser.rol) {
                const rolCapitalizado = currentUser.rol.charAt(0).toUpperCase() + currentUser.rol.slice(1);
                userRole.textContent = rolCapitalizado;
            } else {
                userRole.textContent = 'Usuario';
            }
        } catch (error) {
            console.error('‚ùå Error al cargar datos del usuario:', error);
            document.getElementById('userName').textContent = 'Usuario';
            document.getElementById('userRole').textContent = 'Usuario';
        }
    })();

    (function() {
      function waitForRouteGuard(roles) {
        if (typeof RouteGuard !== 'undefined') {
          RouteGuard.protect(roles);
        } else {
          setTimeout(function() { waitForRouteGuard(roles); }, 50);
        }
      }
      waitForRouteGuard(['admin']);
    })();
  </script>

  <nav class="sidebar" id="sidebar">
      <ul class="menu-list">
          <li class="active"><a href="./docente.html"><img class="icon" src="../../icons/docente.svg" alt=""><span class="text">Docentes</span></a></li>
          <li><a href="../tutor/tutor.html"><span class="icon"><img class="icon" src="../../icons/tutor.svg" alt=""></span><span class="text">Tutor</span></a></li>
          <li><a href="../estudiantes/estudiante.html"><img class="icon" src="../../icons/estudiante.svg" alt=""><span class="text">Estudiantes</span></a></li>
          <li><a href="../grupos/grupos.html"><img class="icon" src="../../icons/grupos.svg" alt=""><span class="text">Grupos</span></a></li>
          <li><a href="../asignaturas/asignatura.html"><img class="icon" src="../../icons/asignatura.svg" alt=""><span class="text">Asignaturas</span></a></li>
          <li><a href="../estadisticas/Estadisticadirector.html"><img class="icon" src="../../icons/estadisticas.svg" alt=""><span class="text">Estad√≠sticas</span></a></li>
      </ul>
  </nav>

  <main class="content">
    <button type="button" class="back-link">
      <span class="icon"><img src="../../icons/atrass.svg" alt="Flecha atr√°s" /></span>
      <span class="text">Atr√°s</span>
    </button>

    <section class="editar-docente">
      <h2>Docente</h2>

      <form class="form-docente">
        <div class="form-row">
          <div class="form-group">
            <label>Nombre:</label>
            <input type="text" id="nombre" disabled placeholder="Cargando...">
          </div>
          <div class="form-group">
            <label>RFC:</label>
            <input type="text" id="rfc" disabled placeholder="Cargando...">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Apellido Paterno:</label>
            <input type="text" id="ape_p" disabled placeholder="Cargando...">
          </div>
          <div class="form-group">
            <label>CURP:</label>
            <input type="text" id="curp" disabled placeholder="Cargando...">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Apellido Materno:</label>
            <input type="text" id="ape_m" disabled placeholder="Cargando...">
          </div>
          <div class="form-group">
            <label>Sexo:</label>
            <select id="sexo" disabled>
              <option value="">Seleccionar</option>
              <option value="M">Masculino</option>
              <option value="F">Femenino</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Fecha de Nacimiento:</label>
            <input type="date" id="fecha_nacimiento" disabled>
          </div>
          <div class="form-group">
            <label>Usuario:</label>
            <input type="text" id="usuario" disabled placeholder="Cargando...">
          </div>
          <div class="form-group" style="position: relative;">
            <label>Contrase√±a:</label>
            <input type="password" id="password" disabled placeholder="Cargando...">
            <button type="button" id="togglePasswordBtn" style="position: absolute; right: 10px; top: 32px; background: none; border: none; cursor: pointer;">
              <span class="iconpasswor"><img src="../../icons/visualizar password.svg" alt="Mostrar/Ocultar contrase√±a" /></span>
            </button>
          </div>
        </div>

        <div class="boton-editar">
          <button type="button" onclick="navigateToSave()" class="btn-editar">
            <img src="../../icons/editar.svg" alt="Editar" class="btn-icon">
            Editar
          </button>
        </div>
      </form>
    </section>
 
    <script>
    let dataLoaded = false;
    let savedFecha = null;
    let savedPassword = null;

    document.querySelector(".back-link").addEventListener("click", function () {
      window.history.back();
    });

    function getIdFromQuery(){ 
      const p = new URLSearchParams(location.search); 
      return p.get('id'); 
    }
    
    function navigateToSave(){ 
      const id = getIdFromQuery(); 
      window.location.href = 'guardardocente.html' + (id ? '?id=' + encodeURIComponent(id) : ''); 
    }

    function togglePassword() {
      const passwordInput = document.getElementById('password');
      if (passwordInput) {
        passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
      }
    }

    const togglePasswordBtn = document.getElementById('togglePasswordBtn');
    if (togglePasswordBtn) {
      togglePasswordBtn.addEventListener('click', togglePassword);
    }

    // Load docente data on page load
    (function(){
      function isReady(name){ 
        try{ 
          return typeof eval(name) !== 'undefined'; 
        } catch(e){ 
          return false; 
        } 
      }
      
      function waitFor(names, timeout){ 
        timeout = timeout || 5000;
        return new Promise(function(resolve, reject){ 
          const start = Date.now(); 
          (function poll(){ 
            if(names.every(isReady)) return resolve(); 
            if(Date.now() - start > timeout) return reject(new Error('Servicios no disponibles')); 
            setTimeout(poll, 50); 
          })(); 
        }); 
      }
      
      waitFor(['usuariosService']).then(async function(){
        if (dataLoaded) return;
        dataLoaded = true;

        const id = getIdFromQuery();
        if (!id) {
          console.log('‚ÑπÔ∏è No hay ID en la URL');
          return;
        }

        try {
          console.log('üîç Cargando docente ID:', id);
          const response = await usuariosService.getById(Number(id));
          const docente = response.data || response;
          
          if (!docente) {
            console.warn('‚ö†Ô∏è No se encontr√≥ el docente');
            return;
          }
          
          console.log('‚úÖ Docente cargado:', docente);
          
          // Llenar campos
          document.getElementById('nombre').value = docente.nombre || '';
          document.getElementById('rfc').value = docente.rfc || '';
          document.getElementById('ape_p').value = docente.ape_p || '';
          document.getElementById('curp').value = docente.curp || '';
          document.getElementById('ape_m').value = docente.ape_m || '';
          document.getElementById('sexo').value = docente.sexo || '';
          document.getElementById('usuario').value = docente.usuario || '';
          
          // Guardar y cargar contrase√±a
          savedPassword = docente.password || '';
          document.getElementById('password').value = savedPassword;
          console.log('üîë Contrase√±a cargada');
          
          // ‚úÖ CARGAR FECHA
          const fechaInput = document.getElementById('fecha_nacimiento');
          if (docente.fecha_nacimiento) {
            let fechaFormateada = '';
            const fechaStr = String(docente.fecha_nacimiento);
            
            if (fechaStr.indexOf('T') !== -1) {
              fechaFormateada = fechaStr.split('T')[0];
            } else if (fechaStr.indexOf('-') !== -1) {
              fechaFormateada = fechaStr.split(' ')[0];
            } else {
              const fecha = new Date(docente.fecha_nacimiento);
              fechaFormateada = fecha.toISOString().split('T')[0];
            }
            
            savedFecha = fechaFormateada;
            fechaInput.value = fechaFormateada;
            console.log('üìÖ Fecha cargada:', fechaFormateada);
          } else {
            console.warn('‚ö†Ô∏è Este docente no tiene fecha de nacimiento registrada');
            fechaInput.placeholder = 'Sin fecha registrada';
          }
          
          console.log('‚úÖ Datos cargados exitosamente');
          
        } catch(e){ 
          console.error('‚ùå Error cargando docente:', e); 
          alert('Error al cargar datos del docente: ' + e.message);
        }
      }).catch(function(err){
        console.warn('‚ö†Ô∏è Servicios no disponibles:', err);
      });
    })();
    </script>
  </main>
    <script src="../../scripts/loadDependencies.js"></script>
    <script src="../../scripts/utils/logoutModal.js"></script>
  </body>
  </html>