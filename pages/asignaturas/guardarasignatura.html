<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Asignatura</title>
  <link rel="stylesheet" href="../../css/editardocente.css">
  <link rel="stylesheet" href="../../css/navbar.css">
  <link rel="stylesheet" href="../../css/modalactualizar.css">
</head>

<body>
  <header class="header">
    <div class="left-section">
      <h1 class="logo">SICALI</h1>
    </div>
    <div class="user-info">
      <div class="text-info">
        <div class="role">Director</div>
        <div class="name">Jorge Luis Omalley Pinacho</div>
      </div>
      <div class="avatar"><img src="../../img/nino.png" alt=""></div>
    </div>
  </header>

  <nav class="sidebar" id="sidebar">
    <ul class="menu-list">
      <li><a href="../docentes/docente.html"><img class="icon" src="../../icons/docente.svg" alt=""><span class="text">Docentes</span></a></li>
      <li><a href="../estudiantes/estudiante.html"><img class="icon" src="../../icons/estudiante.svg" alt=""><span class="text">Estudiantes</span></a></li>
      <li><a href="../grupos/grupos.html"><img class="icon" src="../../icons/grupos.svg" alt=""><span class="text">Grupos</span></a></li>
      <li class="active"><a href="asignatura.html"><img class="icon" src="../../icons/asignatura.svg" alt=""><span class="text">Asignaturas</span></a></li>
      <li><a href="../estadisticas/Estadisticadirector.html"><img class="icon" src="../../icons/estadisticas.svg" alt=""><span class="text">Estadísticas</span></a></li>
    </ul>
  </nav>

  <main class="content">
    <button type="button" class="back-link" onclick="volverAtras()">
      <span class="icon"><img src="../../icons/atrass.svg" alt="Flecha atrás" /></span>
      <span class="text">Atrás</span>
    </button>

    <section class="editar-docente">
      <h2>Editar Asignatura</h2>

      <form class="form-docente" id="form-asignatura">
        <div class="form-row">
          <div class="form-group">
            <label>Nombre: *</label>
            <input type="text" id="nombre" placeholder="Ej: Matemáticas" required>
          </div>
          <div class="form-group">
            <label>Código: *</label>
            <input type="text" id="codigo" placeholder="Ej: MAT101" required>
          </div>
        </div>

        <div class="form-rows single">
          <div class="form-group">
            <label>Descripción:</label>
            <input type="text" id="descripcion" placeholder="Descripción de la asignatura">
          </div>
        </div>

        <div class="boton-editar">
          <button type="button" onclick="validarYMostrarModal()" class="btn-editar">
            <img src="../../icons/guardar.svg" alt="guardar" class="btn-icon">
            Guardar
          </button>
        </div>
      </form>
    </section>

    <!-- Modal de confirmación -->
    <div id="modal-overlay" class="modal-overlay">
      <div class="modal">
        <img src="../../icons/info.svg" alt="info" class="modal-icon">
        <h3>¿Desea Actualizarlo?</h3>
        <p>Los datos actuales serán reemplazados por la nueva información</p>
        <div class="modal-buttons">
          <button class="confirm" onclick="guardarAsignatura()">Guardar</button>
          <button class="cancel" onclick="closeModal()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal de éxito -->
    <div id="success-modal-overlay" class="modal-overlay">
      <div class="modal">
        <img src="../../icons/success.svg" alt="success" class="modal-icon">
        <h3>Actualizado Correctamente</h3>
        <p>Se actualizó la información exitosamente</p>
        <div class="modal-buttons">
          <button class="confirm" onclick="closeSuccessModal()">Aceptar</button>
        </div>
      </div>
    </div>
  </main>

  <!-- ============================================ -->
  <!-- SCRIPTS DEL SISTEMA                          -->
  <!-- ============================================ -->
  <script src="../../scripts/loadDependencies.js"></script>

  <!-- Servicio de Asignaturas (inline) -->
  <script>
    // Proteger esta página solo para admins
    (function() {
        function waitForRouteGuard(roles) {
            if (typeof RouteGuard !== 'undefined') {
                RouteGuard.protect(roles);
            } else {
                setTimeout(function() { waitForRouteGuard(roles); }, 50);
            }
        }
        waitForRouteGuard(['admin']);
    })();

    class AsignaturasService {
      async getById(id) {
        try {
          const response = await httpClient.get(`/asignaturas/${id}`);
          if (response.success) {
            return response.data;
          }
          throw new Error(response.message);
        } catch (error) {
          console.error('Error al obtener asignatura:', error);
          throw error;
        }
      }

      async update(id, asignatura) {
        try {
          const response = await httpClient.put(`/asignaturas/${id}`, asignatura);
          if (response.success) {
            return response.data;
          }
          throw new Error(response.message);
        } catch (error) {
          console.error('Error al actualizar asignatura:', error);
          throw error;
        }
      }
    }

    const asignaturasService = new AsignaturasService();
  </script>

  <!-- ============================================ -->
  <!-- CÓDIGO DE LA PÁGINA                          -->
  <!-- ============================================ -->
  <script>
    // Variables globales
    let idAsignatura = null;
    let datosOriginales = {};

    // ==========================================
    // CARGAR ASIGNATURA AL INICIAR
    // ==========================================
    document.addEventListener('DOMContentLoaded', function() {
      // Obtener ID de la URL
      const urlParams = new URLSearchParams(window.location.search);
      idAsignatura = urlParams.get('id');

      if (!idAsignatura) {
        UIUtils.showError('No se especificó el ID de la asignatura');
        setTimeout(() => {
          window.location.href = 'asignatura.html';
        }, 2000);
        return;
      }

      cargarAsignatura();
    });

    // ==========================================
    // CARGAR DATOS DE LA ASIGNATURA
    // ==========================================
    async function cargarAsignatura() {
      try {
        UIUtils.showLoader('Cargando datos...');

        // Obtener de la API
        const asignatura = await asignaturasService.getById(idAsignatura);

        // Guardar datos originales
        datosOriginales = { ...asignatura };

        // Llenar formulario
        document.getElementById('nombre').value = asignatura.nombre || '';
        document.getElementById('codigo').value = asignatura.codigo || '';
        document.getElementById('descripcion').value = asignatura.descripcion || '';

        UIUtils.hideLoader();

      } catch (error) {
        UIUtils.hideLoader();
        UIUtils.showError('Error al cargar asignatura: ' + error.message);
        
        setTimeout(() => {
          window.location.href = 'asignatura.html';
        }, 2000);
      }
    }

    // ==========================================
    // VALIDAR Y MOSTRAR MODAL DE CONFIRMACIÓN
    // ==========================================
    function validarYMostrarModal() {
      const nombre = document.getElementById('nombre').value.trim();
      const codigo = document.getElementById('codigo').value.trim();

      // Validar campos obligatorios
      if (!nombre) {
        UIUtils.showWarning('El nombre es obligatorio');
        document.getElementById('nombre').focus();
        return;
      }

      if (!codigo) {
        UIUtils.showWarning('El código es obligatorio');
        document.getElementById('codigo').focus();
        return;
      }

      // Validar longitud mínima
      if (nombre.length < 3) {
        UIUtils.showWarning('El nombre debe tener al menos 3 caracteres');
        document.getElementById('nombre').focus();
        return;
      }

      if (codigo.length < 2) {
        UIUtils.showWarning('El código debe tener al menos 2 caracteres');
        document.getElementById('codigo').focus();
        return;
      }

      // Verificar si hubo cambios
      const huboyCambios = 
        nombre !== datosOriginales.nombre ||
        codigo !== datosOriginales.codigo ||
        document.getElementById('descripcion').value.trim() !== (datosOriginales.descripcion || '');

      if (!huboyCambios) {
        UIUtils.showInfo('No se detectaron cambios');
        return;
      }

      // Mostrar modal de confirmación
      showModal();
    }

    // ==========================================
    // GUARDAR ASIGNATURA
    // ==========================================
    async function guardarAsignatura() {
      // Cerrar modal de confirmación
      closeModal();

      const nombre = document.getElementById('nombre').value.trim();
      const codigo = document.getElementById('codigo').value.trim();
      const descripcion = document.getElementById('descripcion').value.trim();

      try {
        UIUtils.showLoader('Guardando cambios...');

        const datos = {
          nombre: nombre,
          codigo: codigo,
          descripcion: descripcion
        };

        // Actualizar en la API
        await asignaturasService.update(idAsignatura, datos);

        UIUtils.hideLoader();

        // Actualizar datos originales
        datosOriginales = { ...datos, idAsignatura: idAsignatura };

        // Mostrar modal de éxito
        showSuccessModal();

      } catch (error) {
        UIUtils.hideLoader();
        UIUtils.showError('Error al guardar: ' + error.message);
        console.error(error);
      }
    }

    // ==========================================
    // FUNCIONES DE MODALES
    // ==========================================
    function showModal() {
      document.getElementById('modal-overlay').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('modal-overlay').style.display = 'none';
    }

    function showSuccessModal() {
      document.getElementById('success-modal-overlay').style.display = 'flex';
    }

    function closeSuccessModal() {
      document.getElementById('success-modal-overlay').style.display = 'none';
      // Volver a la lista después de cerrar el modal
      window.location.href = 'asignatura.html';
    }

    // ==========================================
    // VOLVER ATRÁS
    // ==========================================
    function volverAtras() {
      // Verificar si hay cambios sin guardar
      const nombre = document.getElementById('nombre').value.trim();
      const codigo = document.getElementById('codigo').value.trim();
      const descripcion = document.getElementById('descripcion').value.trim();

      const huboyCambios = 
        nombre !== datosOriginales.nombre ||
        codigo !== datosOriginales.codigo ||
        descripcion !== (datosOriginales.descripcion || '');

      if (huboyCambios) {
        UIUtils.showConfirm(
          '¿Deseas salir sin guardar los cambios?',
          () => {
            window.location.href = 'asignatura.html';
          },
          () => {
            UIUtils.showInfo('Continúa editando');
          }
        );
      } else {
        window.location.href = 'asignatura.html';
      }
    }

    // ==========================================
    // DETECCIÓN DE CAMBIOS EN TIEMPO REAL
    // ==========================================
    document.addEventListener('DOMContentLoaded', function() {
      // Marcar campos modificados visualmente
      const campos = ['nombre', 'codigo', 'descripcion'];
      
      campos.forEach(campoId => {
        const campo = document.getElementById(campoId);
        
        campo.addEventListener('input', function() {
          const valorActual = this.value.trim();
          const valorOriginal = datosOriginales[campoId] || '';
          
          // Marcar con borde si cambió
          if (valorActual !== valorOriginal) {
            this.style.borderColor = '#f59e0b';
            this.style.borderWidth = '2px';
          } else {
            this.style.borderColor = '';
            this.style.borderWidth = '';
          }
        });
      });
    });

    // ==========================================
    // ATAJOS DE TECLADO
    // ==========================================
    document.addEventListener('keydown', function(e) {
      // Ctrl + S para guardar
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        validarYMostrarModal();
      }
      
      // Escape para volver atrás
      if (e.key === 'Escape') {
        volverAtras();
      }
    });
  </script>

</body>
</html>