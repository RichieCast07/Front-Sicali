<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asignaturas</title>
    <link rel="stylesheet" href="../../css/estudiantes.css">
    <link rel="stylesheet" href="../../css/navbar.css">
    <link rel="stylesheet" href="../../css/modalactualizar.css">
</head>
<body>
    <header class="header">
        <div class="left-section">
            <h1 class="logo">SICALI</h1>
        </div>
        <div class="user-info">
            <div class="text-info">
                <div class="role" id="userRole">Cargando...</div>
                <div class="name" id="userName">Cargando...</div>
            </div>
            <div class="avatar" id="userAvatar">
                <img src="../../img/nino.png" alt="">
            </div>
        </div>
    </header>

    <script>
        // ==========================================
        // CARGAR INFORMACI√ìN DEL USUARIO DIN√ÅMICAMENTE
        // ==========================================
        (function() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userName = document.getElementById('userName');
                const userRole = document.getElementById('userRole');
                
                // Cargar nombre completo
                if (currentUser.nombre && currentUser.ape_p) {
                    const fullName = `${currentUser.nombre} ${currentUser.ape_p} ${currentUser.ape_m || ''}`.trim();
                    userName.textContent = fullName;
                } else {
                    userName.textContent = 'Usuario';
                }

                // Cargar rol din√°micamente
                if (currentUser.rol) {
                    const rolCapitalizado = currentUser.rol.charAt(0).toUpperCase() + currentUser.rol.slice(1);
                    userRole.textContent = rolCapitalizado;
                } else {
                    userRole.textContent = 'Usuario';
                }

                console.log('‚úÖ Usuario cargado:', {
                    nombre: userName.textContent,
                    rol: userRole.textContent,
                    id: currentUser.id_usuario
                });

            } catch (error) {
                console.error('‚ùå Error al cargar datos del usuario:', error);
                document.getElementById('userName').textContent = 'Usuario';
                document.getElementById('userRole').textContent = 'Usuario';
            }
        })();
    </script>

    <nav class="sidebar" id="sidebar">
        <ul class="menu-list">
            <li>
                <a href="../docentes/docente.html">
                    <img class="icon" src="../../icons/docente.svg" alt="">
                    <span class="text">Docentes</span>
                </a>
            </li>
            <li>
                <a href="../tutordocente/tutor.html">
                    <span class="icon"><img class="icon" src="../../icons/tutor.svg" alt=""></span>
                    <span class="text">Tutor</span>
                </a>
            </li>
            <li>
                <a href="../estudiantes/estudiante.html">
                    <img class="icon" src="../../icons/estudiante.svg" alt="">
                    <span class="text">Estudiantes</span>
                </a>
            </li>
            <li>
                <a href="../grupos/grupos.html">
                    <img class="icon" src="../../icons/grupos.svg" alt="">
                    <span class="text">Grupos</span>
                </a>
            </li>
            <li class="active">
                <a href="asignatura.html">
                    <img class="icon" src="../../icons/asignatura.svg" alt="">
                    <span class="text">Asignaturas</span>
                </a>
            </li>
            <li>
                <a href="../estadisticas/Estadisticadirector.html">
                    <img class="icon" src="../../icons/estadisticas.svg" alt="">
                    <span class="text">Estad√≠sticas</span>
                </a>
            </li>
        </ul>
    </nav>

    <main class="content" id="content">
        <section class="docentes-section">
            <h1 class="titulo">Asignaturas</h1>

            <div class="acciones-superiores">
                <div class="buscador-con-icono">
                    <img src="../../icons/buscador.svg" alt="Icono de buscador" class="icono-input" />
                    <input type="text" placeholder="Buscar" id="buscarAsignatura" onkeyup="filtrarAsignaturas()" />
                </div>

                <div class="agregar">
                    <label for="">Asignatura</label>
                    <button class="btn-agregar" onclick="showAgregarModal()">
                        <img src="../../icons/agregar.svg" alt="Icono agregar" class="icono-agregar"/>
                        Agregar
                    </button>
                </div>
            </div>

            <table class="tabla-docentes">
                <thead>
                    <tr>
                        <th style="width:10%;">#</th>
                        <th style="width:30%;">Nombre</th>
                        <th style="width:20%;">C√≥digo</th>
                        <th style="width:30%;">Descripci√≥n</th>
                        <th style="width:10%;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tbody-asignaturas">
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            Cargando asignaturas...
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- ------------------------- MODAL AGREGAR -------------------------- -->
        <div id="modal-overlay-asignatura" class="modal-overlay-asignatura">
            <div class="modal-asignatura">
                <h3 id="modal-title">Agregar Asignatura</h3>
                <div class="form-group">
                    <label>Nombre:</label>
                    <input type="text" id="agregar-nombre" placeholder="Ej: Matem√°ticas">
                </div>
                <div class="form-group">
                    <label>C√≥digo:</label>
                    <input type="text" id="agregar-codigo" placeholder="Ej: MAT101">
                </div>
                <div class="form-group">
                    <label>Descripci√≥n:</label>
                    <input type="text" id="agregar-desc" placeholder="Descripci√≥n breve">
                </div>
                <div class="modal-buttons">
                    <button class="guardar" onclick="guardarAsignatura()">Guardar</button>
                    <button class="cancel" onclick="closeAgregarModal()">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- ------------------------- MODAL √âXITO AGREGAR -------------------------- -->
        <div id="success-modal-overlay" class="modal-overlay">
            <div class="modal">
                <img src="../../icons/successverde.svg" alt="success" class="modal-icon">
                <h3>Agregado Correctamente</h3>
                <p>Este registro se guard√≥ en el sistema</p>
            </div>
        </div>

        <!-- ------------------------- MODAL ELIMINAR -------------------------- -->
        <div id="delete-modal-overlay" class="modal-overlay">
            <div class="modal">
                <img src="../../icons/inforojo.svg" alt="eliminar" class="modal-icon">
                <h3>¬øDesea eliminarlo?</h3>
                <p>Esta acci√≥n es permanente y no podr√° deshacerse</p>
                <div class="modal-buttons">
                    <button class="eliminar" onclick="confirmDelete(event)">Eliminar</button>
                    <button class="cancel" onclick="closeDeleteModal()">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- ------------------------- MODAL √âXITO ELIMINAR -------------------------- -->
        <div id="delete-success-modal-overlay" class="modal-overlay">
            <div class="modal">
                <img src="../../icons/successrojo.svg" alt="success" class="modal-icon">
                <h3>Eliminado correctamente</h3>
                <p>El registro que seleccionaste se elimin√≥ del sistema</p>
                <div class="modal-buttons">
                    <button class="eliminar" onclick="closeDeleteSuccessModal()">Aceptar</button>
                </div>
            </div>
        </div>
    </main>

    <!-- ============================================ -->
    <!-- SCRIPTS DEL SISTEMA - AGREGAR AL FINAL      -->
    <!-- ============================================ -->
    <script src="../../scripts/loadDependencies.js"></script>

    <!-- SERVICIO DE ASIGNATURAS -->
    <script>
        // ==========================================
        // SERVICIO DE ASIGNATURAS (inline por ahora)
        // ==========================================
        class AsignaturasService {
            async getAll() {
                try {
                    const response = await httpClient.get('/asignaturas');
                    console.log('‚úÖ AsignaturasService.getAll - respuesta:', response);
                    if (response && response.success) {
                        console.log('üìä Asignaturas cargadas:', Array.isArray(response.data) ? response.data.length : 'n/a');
                        return response.data;
                    }
                    throw new Error(response && response.message ? response.message : 'Error al obtener asignaturas');
                } catch (error) {
                    console.error('‚ùå Error al obtener asignaturas:', error);
                    throw error;
                }
            }

            async create(asignatura) {
                try {
                    const response = await httpClient.post('/asignaturas', asignatura);
                    if (response.success) {
                        return response.data;
                    }
                    const serverMsg = response.data && (typeof response.data === 'string' ? response.data : (response.data.error || null));
                    throw new Error(serverMsg || response.message);
                } catch (error) {
                    console.error('‚ùå Error al crear asignatura:', error);
                    throw error;
                }
            }

            async update(id, asignatura) {
                try {
                    const response = await httpClient.put(`/asignaturas/${id}`, asignatura);
                    if (response.success) {
                        return response.data;
                    }
                    const serverMsg = response.data && (typeof response.data === 'string' ? response.data : (response.data.error || null));
                    throw new Error(serverMsg || response.message);
                } catch (error) {
                    console.error('‚ùå Error al actualizar asignatura:', error);
                    throw error;
                }
            }

            async delete(id) {
                try {
                    const idNum = Number(id);
                    if (Number.isNaN(idNum)) {
                        throw new Error('ID inv√°lido para eliminar asignatura');
                    }
                    console.log('üóëÔ∏è Eliminando asignatura:', idNum);
                    const response = await httpClient.delete(`/asignaturas/${idNum}`);
                    return response;
                } catch (error) {
                    console.error('‚ùå Error al eliminar asignatura:', error);
                    throw error;
                }
            }
        }

        const asignaturasService = new AsignaturasService();
    </script>

    <!-- ============================================ -->
    <!-- C√ìDIGO DE LA P√ÅGINA                          -->
    <!-- ============================================ -->
    <script>
        // Proteger esta p√°gina solo para admins
        (function() {
            function waitForRouteGuard(roles) {
                if (typeof RouteGuard !== 'undefined') {
                    RouteGuard.protect(roles);
                } else {
                    setTimeout(function() { waitForRouteGuard(roles); }, 50);
                }
            }
            waitForRouteGuard(['admin']);
        })();

        // Variables globales
        let asignaturaEditando = null;
        let idAsignaturaEliminar = null;
        let todasLasAsignaturas = [];

        // Cargar asignaturas al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            const ready = () => (typeof httpClient !== 'undefined' && typeof UIUtils !== 'undefined');

            if (ready()) {
                cargarAsignaturas();
                return;
            }

            let tries = 0;
            const maxTries = 50;
            const iv = setInterval(() => {
                if (ready()) {
                    clearInterval(iv);
                    cargarAsignaturas();
                    return;
                }
                tries += 1;
                if (tries > maxTries) {
                    clearInterval(iv);
                    console.error('‚ùå Dependencias no cargadas: httpClient/UIUtils');
                    const tbody = document.getElementById('tbody-asignaturas');
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: #ef4444;">
                                    ‚ö†Ô∏è Error: dependencias de la aplicaci√≥n no cargadas. Recarga la p√°gina.
                                </td>
                            </tr>
                        `;
                    }
                }
            }, 100);
        });

        // ==========================================
        // FUNCI√ìN PRINCIPAL: CARGAR ASIGNATURAS
        // ==========================================
        async function cargarAsignaturas() {
            try {
                console.log('üìö Cargando asignaturas...');
                UIUtils.showLoader('Cargando asignaturas...');
                
                todasLasAsignaturas = await asignaturasService.getAll();
                console.log('‚úÖ Asignaturas cargadas:', todasLasAsignaturas.length);
                
                mostrarAsignaturas(todasLasAsignaturas);
                UIUtils.hideLoader();
                
            } catch (error) {
                UIUtils.hideLoader();
                UIUtils.showError('Error al cargar asignaturas: ' + error.message);
                console.error('‚ùå Error:', error);
                
                document.getElementById('tbody-asignaturas').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #ef4444;">
                            ‚ö†Ô∏è Error al cargar asignaturas. Verifica tu conexi√≥n.
                        </td>
                    </tr>
                `;
            }
        }

        // ==========================================
        // MOSTRAR ASIGNATURAS EN TABLA
        // ==========================================
        function mostrarAsignaturas(asignaturas) {
            const tbody = document.getElementById('tbody-asignaturas');
            
            if (!Array.isArray(asignaturas)) {
                console.warn('‚ö†Ô∏è Expected array but got:', typeof asignaturas);
                asignaturas = [];
            }

            if (asignaturas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            üì≠ No hay asignaturas registradas
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = asignaturas.map((asig, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${asig.nombre || 'Sin nombre'}</td>
                    <td>${asig.codigo || 'Sin c√≥digo'}</td>
                    <td>${asig.descripcion || 'Sin descripci√≥n'}</td>
                    <td>
                        <button class="btn-editar" onclick="editarAsignatura(${asig.idAsignatura})">
                            <img src="../../icons/visualizar.svg" alt="editar"/>
                        </button>
                        <button class="btn-eliminar" onclick="prepararEliminar(event, ${asig.idAsignatura})">
                            <img src="../../icons/eliminar.svg" alt="eliminar"/>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // ==========================================
        // FILTRAR ASIGNATURAS (B√öSQUEDA)
        // ==========================================
        function filtrarAsignaturas() {
            const busqueda = document.getElementById('buscarAsignatura').value.toLowerCase();
            
            if (!busqueda) {
                mostrarAsignaturas(todasLasAsignaturas);
                return;
            }
            
            const filtradas = todasLasAsignaturas.filter(asig => 
                (asig.nombre || '').toLowerCase().includes(busqueda) ||
                (asig.codigo || '').toLowerCase().includes(busqueda) ||
                (asig.descripcion || '').toLowerCase().includes(busqueda)
            );
            
            mostrarAsignaturas(filtradas);
        }

        // ==========================================
        // MODAL AGREGAR/EDITAR
        // ==========================================
        function showAgregarModal() {
            document.getElementById('modal-title').textContent = 'Agregar Asignatura';
            document.getElementById('modal-overlay-asignatura').style.display = 'flex';
            asignaturaEditando = null;
        }

        function closeAgregarModal() {
            document.getElementById('modal-overlay-asignatura').style.display = 'none';
            document.getElementById('agregar-nombre').value = '';
            document.getElementById('agregar-codigo').value = '';
            document.getElementById('agregar-desc').value = '';
            asignaturaEditando = null;
        }

        // ==========================================
        // GUARDAR ASIGNATURA (CREAR O ACTUALIZAR)
        // ==========================================
        async function guardarAsignatura() {
            const nombre = document.getElementById('agregar-nombre').value.trim();
            const codigo = document.getElementById('agregar-codigo').value.trim();
            const descripcion = document.getElementById('agregar-desc').value.trim();

            if (!nombre || !codigo) {
                UIUtils.showWarning('Debes llenar Nombre y C√≥digo');
                return;
            }

            try {
                console.log(asignaturaEditando ? 'üìù Actualizando asignatura...' : '‚ûï Creando asignatura...');
                UIUtils.showLoader(asignaturaEditando ? 'Actualizando...' : 'Guardando...');
                
                const datos = {
                    nombre: nombre,
                    codigo: codigo,
                    descripcion: descripcion
                };

                let resultMessage = null;
                if (asignaturaEditando) {
                    resultMessage = await asignaturasService.update(asignaturaEditando, datos);
                } else {
                    resultMessage = await asignaturasService.create(datos);
                }

                closeAgregarModal();
                UIUtils.hideLoader();

                document.getElementById('success-modal-overlay').style.display = 'flex';
                
                setTimeout(() => {
                    document.getElementById('success-modal-overlay').style.display = 'none';
                }, 1500);

                await cargarAsignaturas();
                
                const notifyMsg = (typeof resultMessage === 'string' && resultMessage.trim())
                    ? resultMessage
                    : (asignaturaEditando ? 'Asignatura actualizada' : 'Asignatura creada');
                UIUtils.showSuccess(notifyMsg);
                console.log('‚úÖ', notifyMsg);

            } catch (error) {
                UIUtils.hideLoader();
                UIUtils.showError('Error al guardar: ' + error.message);
                console.error('‚ùå Error:', error);
            }
        }

        // ==========================================
        // EDITAR ASIGNATURA
        // ==========================================
        async function editarAsignatura(idAsignatura) {
            try {
                console.log('üìù Cargando asignatura para editar:', idAsignatura);
                UIUtils.showLoader('Cargando datos...');
                
                const asignatura = todasLasAsignaturas.find(a => a.idAsignatura === idAsignatura);
                
                if (!asignatura) {
                    throw new Error('Asignatura no encontrada');
                }
                
                document.getElementById('agregar-nombre').value = asignatura.nombre || '';
                document.getElementById('agregar-codigo').value = asignatura.codigo || '';
                document.getElementById('agregar-desc').value = asignatura.descripcion || '';
                
                document.getElementById('modal-title').textContent = 'Editar Asignatura';
                asignaturaEditando = idAsignatura;
                
                document.getElementById('modal-overlay-asignatura').style.display = 'flex';
                
                UIUtils.hideLoader();
                console.log('‚úÖ Datos cargados para edici√≥n');
                
            } catch (error) {
                UIUtils.hideLoader();
                UIUtils.showError('Error al cargar asignatura: ' + error.message);
                console.error('‚ùå Error:', error);
            }
        }

        // ==========================================
        // MODAL ELIMINAR
        // ==========================================
        function prepararEliminar(event, idAsignatura) {
            try {
                if (event && event.stopImmediatePropagation) {
                    event.stopImmediatePropagation();
                    event.preventDefault();
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è No se pudo detener propagaci√≥n del evento');
            }
            idAsignaturaEliminar = idAsignatura;
            document.getElementById('delete-modal-overlay').style.display = 'flex';
            console.log('üóëÔ∏è Preparando eliminar asignatura:', idAsignatura);
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal-overlay').style.display = 'none';
            idAsignaturaEliminar = null;
        }

        async function confirmDelete(event) {
            try {
                if (event && event.stopImmediatePropagation) {
                    event.stopImmediatePropagation();
                    event.preventDefault();
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è No se pudo detener propagaci√≥n del evento');
            }
            
            if (!idAsignaturaEliminar) return;
            const idToDelete = idAsignaturaEliminar;
            
            try {
                closeDeleteModal();
                
                console.log('üóëÔ∏è Eliminando asignatura:', idToDelete);
                UIUtils.showLoader('Eliminando asignatura...');
                
                const resultado = await asignaturasService.delete(idToDelete);
                console.log('‚úÖ Resultado eliminaci√≥n:', resultado);

                UIUtils.hideLoader();

                if (resultado && resultado.success) {
                    await cargarAsignaturas();

                    await new Promise(resolve => setTimeout(resolve, 50));

                    try {
                        const tbody = document.getElementById('tbody-asignaturas');
                        if (tbody && tbody.parentNode) {
                            const fresh = tbody.cloneNode(false);
                            tbody.parentNode.replaceChild(fresh, tbody);
                            mostrarAsignaturas(todasLasAsignaturas || []);
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Error al reemplazar tbody:', e);
                    }

                    const stillExists = todasLasAsignaturas && todasLasAsignaturas.find(a => a.idAsignatura === Number(idToDelete));
                    if (stillExists) {
                        UIUtils.hideLoader();
                        UIUtils.showError('La asignatura sigue presente en el servidor. Intenta nuevamente.');
                        console.warn('‚ö†Ô∏è Elemento sigue presente despu√©s de eliminar');
                        idAsignaturaEliminar = null;
                        return;
                    }

                    document.getElementById('delete-success-modal-overlay').style.display = 'flex';

                    setTimeout(() => {
                        closeDeleteSuccessModal();
                    }, 1500);

                    const deleteMsg = (resultado.data && typeof resultado.data === 'string' && resultado.data.trim())
                        ? resultado.data
                        : 'Asignatura eliminada correctamente';
                    UIUtils.showSuccess(deleteMsg);
                    console.log('‚úÖ', deleteMsg);
                    idAsignaturaEliminar = null;
                } else if (resultado && resultado.success === false) {
                    const serverErr = (resultado.data && (resultado.data.error || resultado.data)) || resultado.message || 'No se pudo eliminar la asignatura';
                    UIUtils.showError(String(serverErr));
                    console.error('‚ùå', serverErr);
                } else {
                    UIUtils.showError('No se pudo eliminar la asignatura');
                }
                
            } catch (error) {
                UIUtils.hideLoader();
                UIUtils.showError('Error al eliminar: ' + error.message);
                console.error('‚ùå Error:', error);
            }
        }

        function closeDeleteSuccessModal() {
            document.getElementById('delete-success-modal-overlay').style.display = 'none';
            idAsignaturaEliminar = null;
        }

        // ==========================================
        // CERRAR MODALES AL HACER CLIC FUERA
        // ==========================================
        document.getElementById('modal-overlay-asignatura').addEventListener('click', function(e) {
            if (e.target === this) closeAgregarModal();
        });

        document.getElementById('delete-modal-overlay').addEventListener('click', function(e) {
            if (e.target === this) closeDeleteModal();
        });
    </script>

    <script src="../../scripts/utils/logoutModal.js"></script>
</body>
</html>