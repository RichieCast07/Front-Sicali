<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar estudiantes</title>
    <link rel="stylesheet" href="../../css/agregarestudiante.css">
    <link rel="stylesheet" href="../../css/navbar.css">
    <link rel="stylesheet" href="../../css/modalactualizar.css">
</head>

<body>
    <header class="header">
        <div class="left-section">
            <h1 class="logo">SICALI</h1>
        </div>
        <div class="user-info">
            <div class="text-info">
                <div class="role" id="userRole">Cargando...</div>
                <div class="name" id="userName">Cargando...</div>
            </div>
            <div class="avatar"><img src="../../img/nino.png" alt=""></div>
        </div>
    </header>

    <script>
        // ==========================================
        // CARGAR INFORMACIÓN DEL USUARIO DINÁMICAMENTE
        // ==========================================
        (function() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userName = document.getElementById('userName');
                const userRole = document.getElementById('userRole');
                
                // Cargar nombre completo
                if (currentUser.nombre && currentUser.ape_p) {
                    const fullName = `${currentUser.nombre} ${currentUser.ape_p} ${currentUser.ape_m || ''}`.trim();
                    userName.textContent = fullName;
                } else {
                    userName.textContent = 'Usuario';
                }

                // Cargar rol dinámicamente
                if (currentUser.rol) {
                    const rolCapitalizado = currentUser.rol.charAt(0).toUpperCase() + currentUser.rol.slice(1);
                    userRole.textContent = rolCapitalizado;
                } else {
                    userRole.textContent = 'Usuario';
                }

                console.log('✅ Usuario cargado:', {
                    nombre: userName.textContent,
                    rol: userRole.textContent,
                    id: currentUser.id_usuario
                });

            } catch (error) {
                console.error('❌ Error al cargar datos del usuario:', error);
                document.getElementById('userName').textContent = 'Usuario';
                document.getElementById('userRole').textContent = 'Usuario';
            }
        })();
    </script>
    
    <script>
      (function() {
        function waitForRouteGuard(roles) {
          if (typeof RouteGuard !== 'undefined') {
            RouteGuard.protect(roles);
          } else {
            setTimeout(function() { waitForRouteGuard(roles); }, 50);
          }
        }
        waitForRouteGuard([docente, 'admin']);
      })();
    </script>

    <nav class="sidebar" id="sidebar">
        <ul class="menu-list">
            <li><a href="../estudiantesdocente/estudiante.html"><span class="icon"> <img class="icon" src="../../icons/estudiante.svg" alt=""></span><span class="text">Estudiantes</span></a></li>
            <li><a href="../tutordocente/tutor.html"><span class="icon"> <img class="icon" src="../../icons/tutor.svg" alt=""></span><span class="text">Tutor</span></a></li>
            <li><a href="../asistencia/asistencia.html"><span class="icon"> <img class="icon" src="../../icons/asistencia.svg" alt=""></span><span class="text">Asistencias</span></a></li>
            <li><a href="../calificaciones/calificaciones.html"><span class="icon"> <img class="icon" src="../../icons/calificaciones.svg" alt=""></span><span class="text">Calificaciones</span></a></li>
            <li><a href="../estadisticas/estadisticasdocente.html"><span class="icon"> <img class="icon" src="../../icons/estadisticas.svg" alt=""></span><span class="text">Estadísticas</span></a></li>
        </ul>
    </nav>
    

    <main class="content" id="content">
    <button type="button" class="back-link" aria-label="Volver atrás">
        <span class="icon"><img src="../../icons/atrass.svg" alt="Flecha atrás" /> </span>
        <span class="text">Atrás</span>
    </button>

    <section class="agregar-estudiante">
  <h2>Agregar Tutor</h2>
  
  <div class="form-contenedor">
    <div class="form-columna">
      <div class="form-group">
        <label>Nombre:</label>
        <input type="text" id="tutorNombre" name="nombre" placeholder="">
      </div>

      <div class="form-group">
        <label>Apellido Paterno:</label>
        <input type="text" id="tutorApeP" name="ape_p" placeholder="">
      </div>

      <div class="form-group">
        <label>Apellido Materno:</label>
        <input type="text" id="tutorApeM" name="ape_m" placeholder="">
      </div>
    </div>

    <div class="form-columna">
      <div class="form-group">
        <label for="tutorSexo">Sexo:</label>
        <select id="tutorSexo" name="sexo">
          <option value="">Seleccionar</option>
          <option value="F">Femenino</option>
          <option value="M">Masculino</option>
        </select>
      </div>

      <div class="form-group">
        <label for="tutorFechaNacimiento">Fecha de Nacimiento:</label>
        <input type="date" id="tutorFechaNacimiento" name="fecha_nacimiento" placeholder="DD/MM/AAAA">
      </div>

      <div class="form-group">
        <label for="tutorUsuario">Usuario:</label>
        <input type="text" id="tutorUsuario" name="usuario" placeholder="usuario.login">
      </div>

      <div class="form-group">
        <label for="tutorPassword">Contraseña:</label>
        <input type="password" id="tutorPassword" name="password" placeholder="Contraseña">
      </div>
    </div>
  </div>

  <div class="boton-agregar">
    <button type="button" id="btnAddTutor">
      <img src="../../icons/agregar.svg" class="btn-icon" alt="Agregar">
      Agregar
    </button>
  </div>
</section>

<div id="modal-overlay" class="modal-overlay">
    <div class="modal">
        <img src="../../icons/successverde.svg" alt="success" class="modal-icon success-icon">
        <h3>Agregado Correctamente</h3>
        <p>Este registro se guardo en el sistema</p>
        <div class="modal-buttons">
            <button class="guardar" onclick="closeModal()">Aceptar</button>
        </div>
    </div>
</div>

<script src="../../scripts/loadDependencies.js"></script>
<script src="../../scripts/services/tutorService.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Role guard: only docente or director can add tutors
  const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
  const role = (currentUser.rol || currentUser.role || '').toString().toLowerCase();
  const btn = document.getElementById('btnAddTutor');
  if (!btn) return;
  if (role !== 'docente' && role !== 'admin') {
    btn.style.display = 'none';
  }

  btn.addEventListener('click', async function() {
    // ✅ ACTUALIZADO: Obtener campos por ID
    const nombre = document.getElementById('tutorNombre')?.value?.trim() || '';
    const ape_p = document.getElementById('tutorApeP')?.value?.trim() || '';
    const ape_m = document.getElementById('tutorApeM')?.value?.trim() || '';
    const sexo = document.getElementById('tutorSexo')?.value || '';
    const fecha_nacimiento = document.getElementById('tutorFechaNacimiento')?.value || '';
    const usuario = document.getElementById('tutorUsuario')?.value?.trim() || `${nombre.toLowerCase()}.${ape_p.toLowerCase()}`.replace(/\s+/g,'');
    const password = document.getElementById('tutorPassword')?.value || 'password123';

    if (!nombre || !ape_p) { 
      alert('Nombre y apellido paterno son obligatorios'); 
      return; 
    }

    const payload = { 
      nombre, 
      ape_p, 
      ape_m, 
      sexo, 
      fecha_nacimiento,
      usuario, 
      password, 
      rol: 'tutor' 
    };

    try {
      const res = await tutorService.create(payload);
      console.log('✅ Tutor creado:', res);
      document.getElementById('modal-overlay').style.display = 'flex';
    } catch (err) {
      console.error('❌ Error creando tutor:', err);
      alert('Error creando tutor. Revisa la consola.');
    }
  });

  document.querySelector('.back-link').addEventListener('click', function(){ window.history.back(); });
});

// Función para cerrar el modal
function closeModal() {
  document.getElementById('modal-overlay').style.display = 'none';
  window.location.href = '../tutordocente/tutor.html';
}
</script>
</main>
</body>
</html>