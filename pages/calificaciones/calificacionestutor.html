<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calificaciones Tutor</title>
    <link rel="stylesheet" href="../../css/calificaciontutor.css">
    <link rel="stylesheet" href="../../css/navbar.css">
    <link rel="stylesheet" href="../../css/modalactualizar.css">
</head>
<body>
    <header class="header">
        <div class="left-section">
            <h1 class="logo">SICALI</h1>
        </div>
        <div class="user-info">
            <div class="text-info">
                <div class="role">Tutor</div>
                <div class="name" id="userName">Cargando...</div>
            </div>
            <div class="avatar"><img src="../../img/nina.png" alt=""></div>
        </div>
    </header>

    <main class="content" id="content" style="width: 100%; margin-left: 0; padding: 20px;">
        <section class="calificaciones-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1 class="titulo" style="margin: 0;">Calificaciones</h1>
                <button onclick="window.location.href='../bienvenidas/bienvenida Tutor.html'" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500;">
                    ‚Üê Volver
                </button>
            </div>
            <div class="container">
                <div class="header-div">
                    <div class="col">
                        <h3>Estudiante</h3>
                        <p id="estudianteNombre">Cargando...</p>
                    </div>
                    <div class="col">
                        <h3>Grupo</h3>
                        <p id="estudianteGrupo">Cargando...</p>
                    </div>
                </div>

                <div class="grid" id="calificacionesGrid">
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                        <p>Cargando calificaciones...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="../../scripts/loadDependencies.js"></script>
    <script>
        // ==========================================
        // CONSTANTES Y UTILIDADES
        // ==========================================
        const CALIFICACION_MIN = 0;
        const CALIFICACION_MAX = 10;
        const SERVICE_TIMEOUT = 10000;  // Aumentado a 10 segundos para asegurar carga

        // Normalizar diferentes estructuras de respuesta del API
        function normalizeApiResponse(response) {
            if (!response) return [];
            if (Array.isArray(response)) return response;
            if (response.data?.data && Array.isArray(response.data.data)) return response.data.data;
            if (Array.isArray(response.data)) return response.data;
            if (response.data) return [response.data];
            return [];
        }

        // Extraer ID de estudiante de diferentes estructuras
        const getEstudianteId = (obj) => obj.idEstudiante || obj.estudiante?.id_usuario;

        // Validar y normalizar calificaci√≥n
        function validarCalificacion(valor) {
            const num = parseFloat(valor);
            if (isNaN(num) || num === null || num === undefined) return 0;
            return Math.max(CALIFICACION_MIN, Math.min(CALIFICACION_MAX, num));
        }

        // Calcular promedio de manera segura
        function calcularPromedio(...calificaciones) {
            const validas = calificaciones
                .map(validarCalificacion)
                .filter(c => c !== null && c !== undefined);
            
            if (validas.length === 0) return 0;
            
            const suma = validas.reduce((acc, cal) => acc + cal, 0);
            return (suma / validas.length).toFixed(1);
        }

        // Esperar a que los servicios est√©n disponibles
        function waitForServices(services, timeout = SERVICE_TIMEOUT) {
            return new Promise((resolve, reject) => {
                let resolved = false;
                
                const onDependenciesLoaded = () => {
                    if (resolved) return;
                    // Dar 100ms m√°s para que los servicios se ejecuten completamente
                    setTimeout(() => {
                        const allAvailable = services.every(service => typeof window[service] !== 'undefined');
                        if (allAvailable) {
                            if (!resolved) {
                                resolved = true;
                                window.removeEventListener('dependenciesLoaded', onDependenciesLoaded);
                                resolve();
                            }
                        }
                    }, 100);
                };
                
                window.addEventListener('dependenciesLoaded', onDependenciesLoaded);
                
                // Fallback: verificar manualmente con timeout
                const startTime = Date.now();
                const check = setInterval(() => {
                    if (resolved) {
                        clearInterval(check);
                        return;
                    }
                    
                    const allAvailable = services.every(service => typeof window[service] !== 'undefined');
                    
                    if (allAvailable) {
                        resolved = true;
                        clearInterval(check);
                        window.removeEventListener('dependenciesLoaded', onDependenciesLoaded);
                        resolve();
                    } else if (Date.now() - startTime > timeout) {
                        resolved = true;
                        clearInterval(check);
                        window.removeEventListener('dependenciesLoaded', onDependenciesLoaded);
                        
                        // Listar servicios que NO est√°n disponibles
                        const missing = services.filter(s => typeof window[s] === 'undefined');
                        console.error('‚ùå Servicios no disponibles:', missing);
                        console.log('‚úÖ Servicios disponibles en window:', Object.keys(window).filter(k => {
                            const val = window[k];
                            return typeof val === 'object' && val && (val.constructor.name.includes('Service') || k.includes('Config'));
                        }));
                        
                        reject(new Error('Timeout esperando servicios: ' + missing.join(', ')));
                    }
                }, 100);
            });
        }

        // ==========================================
        // PROTECCI√ìN DE RUTAS
        // ==========================================
        (function() {
            function waitForRouteGuard(roles) {
                if (typeof RouteGuard !== 'undefined') {
                    RouteGuard.protect(roles);
                } else {
                    setTimeout(() => waitForRouteGuard(roles), 50);
                }
            }
            waitForRouteGuard(['tutor', 'director']);
        })();

        // ==========================================
        // CARGAR INFORMACI√ìN DEL TUTOR
        // ==========================================
        (function() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userName = document.getElementById('userName');
                
                if (currentUser.nombre && currentUser.ape_p) {
                    const fullName = `${currentUser.nombre} ${currentUser.ape_p} ${currentUser.ape_m || ''}`.trim();
                    userName.textContent = fullName;
                } else {
                    userName.textContent = 'Usuario';
                }
            } catch (error) {
                console.error('Error al cargar datos del usuario:', error);
                document.getElementById('userName').textContent = 'Usuario';
            }
        })();

        // ==========================================
        // CARGAR DATOS DEL ESTUDIANTE
        // ==========================================
        async function loadEstudianteData() {
            try {
                console.log('Cargando datos del estudiante...');
                
                const estudianteId = localStorage.getItem('selectedEstudianteId');
                const estudianteNombre = localStorage.getItem('selectedEstudianteNombre');
                
                if (!estudianteId) {
                    console.error('No se seleccion√≥ estudiante');
                    document.getElementById('estudianteNombre').textContent = 'No disponible';
                    document.getElementById('estudianteGrupo').textContent = 'No disponible';
                    mostrarCalificacionesEjemplo();
                    return;
                }

                console.log('Estudiante ID:', estudianteId);

                // Mostrar nombre del estudiante (desde localStorage)
                if (estudianteNombre) {
                    document.getElementById('estudianteNombre').textContent = estudianteNombre;
                }
                
                // Intentar cargar datos adicionales del servidor
                try {
                    if (typeof usuariosService !== 'undefined') {
                        const estudiante = await usuariosService.getById(estudianteId);
                        const nombreCompleto = estudianteNombre || 
                            `${estudiante.nombre} ${estudiante.ape_p} ${estudiante.ape_m || ''}`.trim();
                        document.getElementById('estudianteNombre').textContent = nombreCompleto;
                    }
                } catch (err) {
                    console.warn('No se pudo cargar info adicional del estudiante:', err);
                }
                
                // Intentar cargar grupos
                try {
                    if (typeof estudianteGrupoService !== 'undefined') {
                        const todasInscripciones = await estudianteGrupoService.getAll();
                        const gruposEstudiante = todasInscripciones.filter(insc => {
                            const idEst = getEstudianteId(insc);
                            return Number(idEst) === Number(estudianteId);
                        });
                        
                        if (gruposEstudiante && gruposEstudiante.length > 0) {
                            const grupoInfo = gruposEstudiante.map(eg => {
                                const grupo = eg.grupo;
                                if (grupo && grupo.nombre) {
                                    return `${grupo.nombre} - Grado ${grupo.grado || ''}`;
                                }
                                return `Grupo ${eg.idGrupo}`;
                            }).join(', ');
                            document.getElementById('estudianteGrupo').textContent = grupoInfo;
                        }
                    }
                } catch (err) {
                    console.warn('No se pudieron cargar grupos:', err);
                }
                
                // Cargar calificaciones
                await loadCalificacionesReales(estudianteId);

            } catch (error) {
                console.error('Error al cargar datos del estudiante:', error);
                mostrarCalificacionesEjemplo();
            }
        }

        // ==========================================
        // CARGAR CALIFICACIONES REALES
        // ==========================================
        async function loadCalificacionesReales(estudianteId) {
            try {
                console.log('=== INICIANDO loadCalificacionesReales ===');
                console.log('Estudiante ID:', estudianteId);
                console.log('calificacionesService disponible:', typeof calificacionesService !== 'undefined');
                console.log('httpClient disponible:', typeof httpClient !== 'undefined');
                console.log('API_CONFIG disponible:', typeof API_CONFIG !== 'undefined');

                let todasCalificaciones = [];
                let asignaturas = [];

                // Intentar cargar calificaciones usando calificacionesService
                if (typeof calificacionesService !== 'undefined') {
                    try {
                        console.log('Llamando calificacionesService.getAll()...');
                        
                        // Obtener todas las calificaciones
                        const allCalificaciones = await calificacionesService.getAll();
                        
                        console.log('Respuesta de calificacionesService:', {
                            tipo: typeof allCalificaciones,
                            esArray: Array.isArray(allCalificaciones),
                            cantidad: Array.isArray(allCalificaciones) ? allCalificaciones.length : 'N/A',
                            datos: allCalificaciones
                        });
                        
                        // Filtrar por estudiante
                        todasCalificaciones = allCalificaciones.filter(cal => {
                            return Number(cal.idEstudiante) === Number(estudianteId);
                        });
                        
                        console.log('Calificaciones filtradas para estudiante:', {
                            cantidad: todasCalificaciones.length,
                            datos: todasCalificaciones
                        });
                    } catch (error) {
                        console.error('Error llamando calificacionesService.getAll():', error);
                    }
                } else {
                    console.warn('‚ö†Ô∏è calificacionesService NO est√° definido');
                }

                // Si no hay calificaciones, mostrar ejemplo
                if (todasCalificaciones.length === 0) {
                    console.log('‚ùå Sin calificaciones - mostrando ejemplo');
                    mostrarCalificacionesEjemplo();
                    return;
                }

                console.log('‚úÖ Cargando calificaciones reales...');

                // Los nombres de asignaturas ya vienen del backend en normalizeCalificacion
                // No es necesario hacer llamadas adicionales
                
                // Organizar calificaciones por asignatura
                const calificacionesPorAsignatura = {};
                
                console.log('[DEBUG] Procesando calificaciones. Total:', todasCalificaciones.length);
                
                todasCalificaciones.forEach(cal => {
                    const idAsig = cal.idAsignatura;
                    
                    if (!idAsig) {
                        console.warn('[DEBUG] Calificaci√≥n sin idAsignatura:', cal);
                        return;
                    }
                    
                    if (!calificacionesPorAsignatura[idAsig]) {
                        // El nombre de la asignatura ya viene normalizado del servicio
                        const nombreAsignatura = cal.nombreAsignatura || `Asignatura ${idAsig}`;
                        
                        console.log(`[DEBUG] Asignatura ${idAsig}:`, {
                            nombre: nombreAsignatura,
                            calificacionCompleta: cal
                        });
                        
                        calificacionesPorAsignatura[idAsig] = {
                            nombre: nombreAsignatura,
                            calificacion1: validarCalificacion(cal.calificacion1),
                            calificacion2: validarCalificacion(cal.calificacion2),
                            calificacion3: validarCalificacion(cal.calificacion3),
                            calificacion4: validarCalificacion(cal.calificacion4)
                        };
                    }
                });

                console.log('[DEBUG] Calificaciones por asignatura:', calificacionesPorAsignatura);
                renderCalificaciones(calificacionesPorAsignatura);

            } catch (error) {
                console.error('Error cargando calificaciones:', error);
                mostrarCalificacionesEjemplo();
            }
        }

        // ==========================================
        // RENDERIZAR CALIFICACIONES
        // ==========================================
        function renderCalificaciones(calificacionesPorAsignatura) {
            const colores = ['azul', 'rosa', 'naranja', 'verde', 'morado', 'amarillo'];
            let colorIndex = 0;

            const cardsHTML = Object.values(calificacionesPorAsignatura).map(cal => {
                const promedio = calcularPromedio(
                    cal.calificacion1,
                    cal.calificacion2,
                    cal.calificacion3,
                    cal.calificacion4
                );
                const color = colores[colorIndex % colores.length];
                colorIndex++;

                return `
                    <div class="card">
                        <div class="title ${color}">${cal.nombre.toUpperCase()}</div>
                        <div class="box">
                            <p>PERIODO 1: <span>${cal.calificacion1}</span></p>
                            <p>PERIODO 2: <span>${cal.calificacion2}</span></p>
                            <p>PERIODO 3: <span>${cal.calificacion3}</span></p>
                            <p>PERIODO 4: <span>${cal.calificacion4}</span></p>
                            <p style="border-top: 2px solid #ddd; margin-top: 10px; padding-top: 10px; font-weight: bold;">
                                PROMEDIO: <span>${promedio}</span>
                            </p>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('calificacionesGrid').innerHTML = `${cardsHTML}`;

            console.log('Calificaciones renderizadas correctamente');
        }

        // ==========================================
        // MOSTRAR CALIFICACIONES DE EJEMPLO
        // ==========================================
        function mostrarCalificacionesEjemplo() {
            const calificaciones = [
                {
                    asignatura: 'LENGUAJES',
                    color: 'azul',
                    periodo1: 7.7,
                    periodo2: 8.9,
                    periodo3: 9.1,
                    periodo4: 9.2
                },
                {
                    asignatura: 'DE LO HUMANO Y LO COMUNITARIO',
                    color: 'rosa',
                    periodo1: 8.9,
                    periodo2: 9.2,
                    periodo3: 7.7,
                    periodo4: 9.1
                },
                {
                    asignatura: 'SABERES Y PENSAMIENTO CIENT√çFICO',
                    color: 'naranja',
                    periodo1: 7.7,
                    periodo2: 8.1,
                    periodo3: 9.1,
                    periodo4: 8.9
                },
                {
                    asignatura: '√âTICA, NATURALEZA Y SOCIEDADES',
                    color: 'verde',
                    periodo1: 9.1,
                    periodo2: 8.9,
                    periodo3: 9.2,
                    periodo4: 9.2
                }
            ];
            
            const cardsHTML = calificaciones.map(cal => {
                const promedio = calcularPromedio(cal.periodo1, cal.periodo2, cal.periodo3, cal.periodo4);
                return `
                    <div class="card">
                        <div class="title ${cal.color}">${cal.asignatura}</div>
                        <div class="box">
                            <p>PERIODO 1: <span>${cal.periodo1}</span></p>
                            <p>PERIODO 2: <span>${cal.periodo2}</span></p>
                            <p>PERIODO 3: <span>${cal.periodo3}</span></p>
                            <p>PERIODO 4: <span>${cal.periodo4}</span></p>
                            <p style="border-top: 2px solid #ddd; margin-top: 10px; padding-top: 10px; font-weight: bold;">
                                PROMEDIO: <span>${promedio}</span>
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('calificacionesGrid').innerHTML = `
                <div style="grid-column: 1/-1; background: #e3f2fd; padding: 12px 20px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #1565c0; font-size: 14px;">
                        No hay calificaciones registradas a√∫n. Mostrando datos de ejemplo.
                    </p>
                </div>
                ${cardsHTML}
            `;
        }

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        // Variable para controlar si ya se ha iniciado la carga
        let initializationStarted = false;
        
        async function initializeApp() {
            if (initializationStarted) {
                console.log('‚ö†Ô∏è Inicializaci√≥n ya en progreso');
                return;
            }
            
            initializationStarted = true;
            
            try {
                console.log('üîÑ Inicializando aplicaci√≥n...');
                
                // Esperar a que los servicios necesarios est√©n disponibles
                console.log('‚è≥ Esperando servicios...');
                await waitForServices(['calificacionesService', 'httpClient', 'API_CONFIG']);
                
                console.log('‚úÖ Servicios cargados correctamente');
                console.log('calificacionesService disponible:', typeof calificacionesService !== 'undefined');
                console.log('httpClient disponible:', typeof httpClient !== 'undefined');
                console.log('API_CONFIG disponible:', typeof API_CONFIG !== 'undefined');
                
                // Cargar datos del estudiante
                await loadEstudianteData();
                
                console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error en la inicializaci√≥n:', error);
                // Mostrar datos de ejemplo como fallback
                mostrarCalificacionesEjemplo();
            }
        }
        
        // Esperar a dependenciesLoaded para iniciar
        window.addEventListener('dependenciesLoaded', async () => {
            console.log('üì¢ Evento dependenciesLoaded disparado');
            await initializeApp();
        });
        
        // Fallback: iniciar en DOMContentLoaded si dependenciesLoaded no se ha disparado
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded disparado');
            // Dar 200ms para que dependenciesLoaded se dispare
            setTimeout(async () => {
                if (!initializationStarted) {
                    console.log('‚ö†Ô∏è dependenciesLoaded no se dispar√≥, iniciando con fallback...');
                    await initializeApp();
                }
            }, 200);
        });
    </script>
    <script src="../../scripts/utils/logoutModal.js"></script>
</body>
</html>