<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calificaciones Tutor</title>
    <link rel="stylesheet" href="../../css/calificaciontutor.css">
    <link rel="stylesheet" href="../../css/navbar.css">
    <link rel="stylesheet" href="../../css/modalactualizar.css">
</head>
<body>
    <header class="header">
        <div class="left-section">
            <h1 class="logo">SICALI</h1>
        </div>
        <div class="user-info">
            <div class="text-info">
                <div class="role">Tutor</div>
                <div class="name" id="userName">Cargando...</div>
            </div>
            <div class="avatar"><img src="../../img/nina.png" alt=""></div>
        </div>
    </header>

    <nav class="sidebar" id="sidebar">
        <ul class="menu-list">
            <li class="active">
                <span class="icon"><img class="icon" src="../../icons/calificaciones.svg" alt=""></span>
                <span class="text">Calificaciones</span>
            </li>
            <li>
                <a href="../estadisticas/estadisticastutor.html">
                    <span class="icon"><img class="icon" src="../../icons/estadisticas.svg" alt=""></span>
                    <span class="text">Estad√≠sticas</span>
                </a>
            </li>
        </ul>
    </nav>

    <main class="content" id="content">
        <section class="calificaciones-section">
            <h1 class="titulo">Calificaciones</h1>
            <div class="container">
                <div class="header-div">
                    <div class="col">
                        <h3>Estudiante</h3>
                        <p id="estudianteNombre">Cargando...</p>
                    </div>
                    <div class="col">
                        <h3>Grupo</h3>
                        <p id="estudianteGrupo">Cargando...</p>
                    </div>
                </div>

                <div class="grid" id="calificacionesGrid">
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                        <p>Cargando calificaciones...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="../../scripts/loadDependencies.js"></script>
    <script>
        // ==========================================
        // CONSTANTES Y UTILIDADES
        // ==========================================
        const CALIFICACION_MIN = 0;
        const CALIFICACION_MAX = 10;
        const SERVICE_TIMEOUT = 5000;

        // Normalizar diferentes estructuras de respuesta del API
        function normalizeApiResponse(response) {
            if (!response) return [];
            if (Array.isArray(response)) return response;
            if (response.data?.data && Array.isArray(response.data.data)) return response.data.data;
            if (Array.isArray(response.data)) return response.data;
            if (response.data) return [response.data];
            return [];
        }

        // Extraer ID de estudiante de diferentes estructuras
        const getEstudianteId = (obj) => obj.idEstudiante || obj.estudiante?.id_usuario;

        // Validar y normalizar calificaci√≥n
        function validarCalificacion(valor) {
            const num = parseFloat(valor);
            if (isNaN(num) || num === null || num === undefined) return 0;
            return Math.max(CALIFICACION_MIN, Math.min(CALIFICACION_MAX, num));
        }

        // Calcular promedio de manera segura
        function calcularPromedio(...calificaciones) {
            const validas = calificaciones
                .map(validarCalificacion)
                .filter(c => c !== null && c !== undefined);
            
            if (validas.length === 0) return 0;
            
            const suma = validas.reduce((acc, cal) => acc + cal, 0);
            return (suma / validas.length).toFixed(1);
        }

        // Esperar a que los servicios est√©n disponibles
        function waitForServices(services, timeout = SERVICE_TIMEOUT) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                const check = setInterval(() => {
                    const allAvailable = services.every(service => typeof window[service] !== 'undefined');
                    
                    if (allAvailable) {
                        clearInterval(check);
                        resolve();
                    } else if (Date.now() - startTime > timeout) {
                        clearInterval(check);
                        reject(new Error('Timeout esperando servicios: ' + services.join(', ')));
                    }
                }, 100);
            });
        }

        // ==========================================
        // PROTECCI√ìN DE RUTAS
        // ==========================================
        (function() {
            function waitForRouteGuard(roles) {
                if (typeof RouteGuard !== 'undefined') {
                    RouteGuard.protect(roles);
                } else {
                    setTimeout(() => waitForRouteGuard(roles), 50);
                }
            }
            waitForRouteGuard(['tutor', 'admin']);
        })();

        // ==========================================
        // CARGAR INFORMACI√ìN DEL TUTOR
        // ==========================================
        (function() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userName = document.getElementById('userName');
                
                if (currentUser.nombre && currentUser.ape_p) {
                    const fullName = `${currentUser.nombre} ${currentUser.ape_p} ${currentUser.ape_m || ''}`.trim();
                    userName.textContent = fullName;
                } else {
                    userName.textContent = 'Usuario';
                }
            } catch (error) {
                console.error('Error al cargar datos del usuario:', error);
                document.getElementById('userName').textContent = 'Usuario';
            }
        })();

        // ==========================================
        // CARGAR DATOS DEL ESTUDIANTE
        // ==========================================
        async function loadEstudianteData() {
            try {
                console.log('üìä Cargando datos del estudiante...');
                
                const estudianteId = localStorage.getItem('selectedEstudianteId');
                const estudianteNombre = localStorage.getItem('selectedEstudianteNombre');
                
                if (!estudianteId) {
                    alert('No se seleccion√≥ ning√∫n estudiante. Redirigiendo...');
                    window.location.href = '../bienvenidas/bienvenida Tutor.html';
                    return;
                }

                console.log('üë§ Estudiante ID:', estudianteId);

                // Obtener datos del estudiante
                const estudiante = await usuariosService.getById(estudianteId);
                
                // Mostrar nombre del estudiante
                const nombreCompleto = estudianteNombre || 
                    `${estudiante.nombre} ${estudiante.ape_p} ${estudiante.ape_m || ''}`.trim();
                document.getElementById('estudianteNombre').textContent = nombreCompleto;
                
                console.log('‚úÖ Estudiante cargado:', nombreCompleto);
                
                // Obtener y mostrar grupos del estudiante
                let gruposEstudiante = [];
                try {
                    const todasInscripciones = await estudianteGrupoService.getAll();
                    gruposEstudiante = todasInscripciones.filter(insc => {
                        const idEst = getEstudianteId(insc);
                        return Number(idEst) === Number(estudianteId);
                    });
                    
                    console.log('üìö Grupos encontrados:', gruposEstudiante.length);
                    
                    if (gruposEstudiante && gruposEstudiante.length > 0) {
                        const grupoInfo = gruposEstudiante.map(eg => {
                            const grupo = eg.grupo;
                            if (grupo && grupo.nombre) {
                                return `${grupo.nombre} - Grado ${grupo.grado || ''}`;
                            }
                            return `Grupo ${eg.idGrupo}`;
                        }).join(', ');
                        document.getElementById('estudianteGrupo').textContent = grupoInfo;
                    } else {
                        document.getElementById('estudianteGrupo').textContent = 'Sin grupo asignado';
                    }
                } catch (grupoError) {
                    console.error('‚ùå Error cargando grupos:', grupoError);
                    document.getElementById('estudianteGrupo').textContent = 'Error al cargar grupo';
                }
                
                // Cargar calificaciones del estudiante
                await loadCalificacionesReales(estudianteId, gruposEstudiante);

            } catch (error) {
                console.error('‚ùå Error al cargar datos del estudiante:', error);
                alert('Error: ' + error.message);
                window.location.href = '../bienvenidas/bienvenida Tutor.html';
            }
        }

        // ==========================================
        // CARGAR CALIFICACIONES REALES
        // ==========================================
        async function loadCalificacionesReales(estudianteId, gruposEstudiante) {
            try {
                console.log('üìö Cargando calificaciones del estudiante ID:', estudianteId);

                let todasCalificaciones = [];

                // 1. Intentar cargar desde backend
                try {
                    const response = await httpClient.get(API_CONFIG.ENDPOINTS.CALIFICACIONES.LIST);
                    console.log('üì° Response del backend:', response);
                    
                    const calificacionesBackend = normalizeApiResponse(response);
                    
                    console.log('üìä Total calificaciones en BD:', calificacionesBackend.length);
                    
                    // Filtrar por estudiante
                    todasCalificaciones = calificacionesBackend.filter(cal => {
                        const idEst = getEstudianteId(cal);
                        const match = Number(idEst) === Number(estudianteId);
                        if (match) {
                            console.log('‚úÖ Calificaci√≥n encontrada:', cal);
                        }
                        return match;
                    });
                    
                    console.log('‚úÖ Calificaciones del backend para este estudiante:', todasCalificaciones.length);
                } catch (error) {
                    console.error('‚ùå Error al cargar desde backend:', error);
                    console.warn('‚ö†Ô∏è Backend no disponible, usando localStorage');
                }

                // 2. Cargar desde localStorage (calificaciones guardadas localmente)
                try {
                    const calificacionesLocales = JSON.parse(
                        localStorage.getItem('calificaciones_pendientes') || '[]'
                    );
                    const calificacionesEstudiante = calificacionesLocales.filter(cal => 
                        Number(cal.idEstudiante) === Number(estudianteId)
                    );

                    if (calificacionesEstudiante.length > 0) {
                        console.log('üì¶ Calificaciones locales encontradas:', calificacionesEstudiante.length);
                        
                        // Combinar con backend (localStorage tiene prioridad)
                        calificacionesEstudiante.forEach(calLocal => {
                            const existe = todasCalificaciones.find(cal => 
                                cal.idAsignatura === calLocal.idAsignatura
                            );
                            if (!existe) {
                                todasCalificaciones.push(calLocal);
                            } else {
                                // localStorage tiene prioridad, actualizar con datos locales
                                Object.assign(existe, calLocal);
                            }
                        });
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error al cargar calificaciones locales:', error);
                }

                // 3. Si no hay calificaciones, mostrar datos de ejemplo
                if (todasCalificaciones.length === 0) {
                    console.log('‚ÑπÔ∏è No hay calificaciones reales, mostrando ejemplo');
                    mostrarCalificacionesEjemplo();
                    return;
                }

                // 4. Cargar asignaturas para obtener nombres
                let asignaturas = [];
                try {
                    const respAsignaturas = await httpClient.get(API_CONFIG.ENDPOINTS.ASIGNATURAS.LIST);
                    asignaturas = normalizeApiResponse(respAsignaturas);
                    console.log('üìö Asignaturas cargadas:', asignaturas.length);
                } catch (error) {
                    console.warn('‚ö†Ô∏è No se pudieron cargar asignaturas:', error);
                }

                // 5. Organizar calificaciones por asignatura
                const calificacionesPorAsignatura = {};
                
                todasCalificaciones.forEach(cal => {
                    const idAsig = cal.idAsignatura || cal.asignatura?.idAsignatura;
                    
                    if (!idAsig) {
                        console.warn('‚ö†Ô∏è Calificaci√≥n sin ID de asignatura:', cal);
                        return;
                    }
                    
                    if (!calificacionesPorAsignatura[idAsig]) {
                        const asignatura = asignaturas.find(a => a.idAsignatura === idAsig);
                        calificacionesPorAsignatura[idAsig] = {
                            nombre: asignatura?.nombre || `Asignatura ${idAsig}`,
                            calificacion1: validarCalificacion(cal.calificacion1),
                            calificacion2: validarCalificacion(cal.calificacion2),
                            calificacion3: validarCalificacion(cal.calificacion3),
                            calificacion4: validarCalificacion(cal.calificacion4)
                        };
                    }
                });
                
                console.log('üìã Calificaciones organizadas:', calificacionesPorAsignatura);

                // 6. Renderizar calificaciones
                renderCalificaciones(calificacionesPorAsignatura);

            } catch (error) {
                console.error('‚ùå Error cargando calificaciones:', error);
                mostrarCalificacionesEjemplo();
            }
        }

        // ==========================================
        // RENDERIZAR CALIFICACIONES
        // ==========================================
        function renderCalificaciones(calificacionesPorAsignatura) {
            const colores = ['azul', 'rosa', 'naranja', 'verde', 'morado', 'amarillo'];
            let colorIndex = 0;

            const cardsHTML = Object.values(calificacionesPorAsignatura).map(cal => {
                const promedio = calcularPromedio(
                    cal.calificacion1,
                    cal.calificacion2,
                    cal.calificacion3,
                    cal.calificacion4
                );
                const color = colores[colorIndex % colores.length];
                colorIndex++;

                return `
                    <div class="card">
                        <div class="title ${color}">${cal.nombre.toUpperCase()}</div>
                        <div class="box">
                            <p>PERIODO 1: <span>${cal.calificacion1}</span></p>
                            <p>PERIODO 2: <span>${cal.calificacion2}</span></p>
                            <p>PERIODO 3: <span>${cal.calificacion3}</span></p>
                            <p>PERIODO 4: <span>${cal.calificacion4}</span></p>
                            <p style="border-top: 2px solid #ddd; margin-top: 10px; padding-top: 10px; font-weight: bold;">
                                PROMEDIO: <span>${promedio}</span>
                            </p>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('calificacionesGrid').innerHTML = `
                <div style="grid-column: 1/-1; background: #e8f5e9; padding: 12px 20px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #2e7d32; font-size: 14px;">
                        ‚úÖ Mostrando calificaciones reales del estudiante (${Object.keys(calificacionesPorAsignatura).length} asignaturas)
                    </p>
                </div>
                ${cardsHTML}
            `;

            console.log('‚úÖ Calificaciones renderizadas correctamente');
        }

        // ==========================================
        // MOSTRAR CALIFICACIONES DE EJEMPLO
        // ==========================================
        function mostrarCalificacionesEjemplo() {
            const calificaciones = [
                {
                    asignatura: 'LENGUAJES',
                    color: 'azul',
                    periodo1: 7.7,
                    periodo2: 8.9,
                    periodo3: 9.1,
                    periodo4: 9.2
                },
                {
                    asignatura: 'DE LO HUMANO Y LO COMUNITARIO',
                    color: 'rosa',
                    periodo1: 8.9,
                    periodo2: 9.2,
                    periodo3: 7.7,
                    periodo4: 9.1
                },
                {
                    asignatura: 'SABERES Y PENSAMIENTO CIENT√çFICO',
                    color: 'naranja',
                    periodo1: 7.7,
                    periodo2: 8.1,
                    periodo3: 9.1,
                    periodo4: 8.9
                },
                {
                    asignatura: '√âTICA, NATURALEZA Y SOCIEDADES',
                    color: 'verde',
                    periodo1: 9.1,
                    periodo2: 8.9,
                    periodo3: 9.2,
                    periodo4: 9.2
                }
            ];
            
            const cardsHTML = calificaciones.map(cal => {
                const promedio = calcularPromedio(cal.periodo1, cal.periodo2, cal.periodo3, cal.periodo4);
                return `
                    <div class="card">
                        <div class="title ${cal.color}">${cal.asignatura}</div>
                        <div class="box">
                            <p>PERIODO 1: <span>${cal.periodo1}</span></p>
                            <p>PERIODO 2: <span>${cal.periodo2}</span></p>
                            <p>PERIODO 3: <span>${cal.periodo3}</span></p>
                            <p>PERIODO 4: <span>${cal.periodo4}</span></p>
                            <p style="border-top: 2px solid #ddd; margin-top: 10px; padding-top: 10px; font-weight: bold;">
                                PROMEDIO: <span>${promedio}</span>
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('calificacionesGrid').innerHTML = `
                <div style="grid-column: 1/-1; background: #e3f2fd; padding: 12px 20px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #1565c0; font-size: 14px;">
                        üí° No hay calificaciones registradas a√∫n. Mostrando datos de ejemplo.
                    </p>
                </div>
                ${cardsHTML}
            `;
        }

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('üöÄ Inicializando aplicaci√≥n...');
                
                // Esperar a que los servicios est√©n disponibles
                await waitForServices(['usuariosService', 'estudianteGrupoService', 'httpClient']);
                
                console.log('‚úÖ Servicios cargados correctamente');
                
                // Cargar datos del estudiante
                await loadEstudianteData();
                
            } catch (error) {
                console.error('‚ùå Error en la inicializaci√≥n:', error);
                alert('Error al inicializar la aplicaci√≥n. Por favor, recarga la p√°gina.');
            }
        });
    </script>
    <script src="../../scripts/utils/logoutModal.js"></script>
</body>
</html>