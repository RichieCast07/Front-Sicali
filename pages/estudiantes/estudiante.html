<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudiantes</title>
    <link rel="stylesheet" href="../../css/estudiantes.css">
    <link rel="stylesheet" href="../../css/navbar.css">
    <link rel="stylesheet" href="../../css/modalactualizar.css">
</head>

<body>
    <header class="header">
        <div class="left-section">
            <h1 class="logo">SICALI</h1>
        </div>
        <div class="user-info">
            <div class="text-info">
                <div class="role">Director</div>
                <div class="name">Jorge Luis Omalley Pinacho</div>
            </div>
            <div class="avatar"><img src="../../img/nino.png" alt=""></div>
        </div>
    </header>
    <script>
    // Enhancer: carga y renderiza estudiantes desde la API usando usuariosService
    (function(){
        let idToDelete = null;
        function waitFor(names, timeout = 5000) {
            return new Promise((resolve, reject) => {
                const start = Date.now();
                (function poll() {
                    try {
                        const ok = names.every(n => { try { return typeof eval(n) !== 'undefined'; } catch(e){ return false; } });
                        if (ok) return resolve();
                    } catch (e) {}
                    if (Date.now() - start > timeout) return reject(new Error('Servicios no disponibles: ' + names.join(',')));
                    setTimeout(poll, 50);
                })();
            });
        }

        function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

        async function loadAndRender(){
            try{
                const raw = await usuariosService.getByRol('estudiante');
                const students = Array.isArray(raw) ? raw : (raw ? [raw] : []);
                
                // Cargar grupos v√°lidos, estudiante-grupo y tutores en paralelo
                let gruposMap = new Map();
                let tutoresMap = new Map();
                let gruposValidosSet = new Set();
                
            try {
                // Intentar cargar grupos, inscripciones y tutores
                // Si estudiante-grupo falla (404), continuar sin esos datos
                let allGruposExistentes = [];
                let allEstudianteGrupo = [];
                let allTutores = [];
                
                try {
                    allGruposExistentes = await gruposService.getAll();
                    console.log('‚úÖ Grupos cargados:', allGruposExistentes.length);
                } catch(e) { console.error('‚ùå Error cargando grupos:', e); }
                
                try {
                    allEstudianteGrupo = await estudianteGrupoService.getAll();
                    console.log('‚úÖ Inscripciones cargadas:', allEstudianteGrupo.length);
                } catch(e) { 
                    console.error('‚ùå Error cargando inscripciones estudiante-grupo:', e);
                }
                
                try {
                    allTutores = await usuariosService.getByRol('tutor');
                    console.log('‚úÖ Tutores cargados:', allTutores.length);
                } catch(e) { console.error('‚ùå Error cargando tutores:', e); }                    // Crear set de grupos v√°lidos (que existen en la tabla grupos)
                    const gruposArray = Array.isArray(allGruposExistentes) ? allGruposExistentes : (allGruposExistentes ? [allGruposExistentes] : []);
                    gruposArray.forEach(g => {
                        const id = g.idGrupo || g.id;
                        if (id) gruposValidosSet.add(Number(id));
                    });
                    
                    console.log('Grupos v√°lidos:', Array.from(gruposValidosSet));
                    
                    // Crear mapas para acceso r√°pido
                    const tutoresArray = Array.isArray(allTutores) ? allTutores : (allTutores ? [allTutores] : []);
                    tutoresArray.forEach(t => tutoresMap.set(t.id_usuario, t));
                    
                    // Agrupar estudiante-grupo por estudiante (solo grupos v√°lidos)
                    if (Array.isArray(allEstudianteGrupo)) {
                        console.log('üìä Procesando', allEstudianteGrupo.length, 'inscripciones para mapeo');
                        console.log('üìä Grupos v√°lidos:', Array.from(gruposValidosSet));
                        allEstudianteGrupo.forEach(eg => {
                            if (eg.idEstudiante) {
                                // Verificar que el grupo exista
                                const grupoId = eg.grupo?.idGrupo || eg.idGrupo;
                                if (grupoId && gruposValidosSet.has(Number(grupoId))) {
                                    if (!gruposMap.has(eg.idEstudiante)) {
                                        gruposMap.set(eg.idEstudiante, []);
                                    }
                                    gruposMap.get(eg.idEstudiante).push(eg);
                                    console.log(`‚úÖ Estudiante ${eg.idEstudiante} -> Grupo ${grupoId}`);
                                } else {
                                    console.warn(`‚ö†Ô∏è Estudiante ${eg.idEstudiante} inscrito en grupo inexistente ${grupoId}`);
                                }
                            } else {
                                console.warn('‚ö†Ô∏è Inscripci√≥n sin idEstudiante:', eg);
                            }
                        });
                        console.log('üìä Mapa final de grupos:', gruposMap);
                    }
                } catch (loadError) {
                    console.warn('Error cargando grupos/tutores:', loadError);
                }
                
                const tbody = document.querySelector('.tabla-docentes tbody');
                const newTbody = tbody.cloneNode(false);

                if(!students.length){
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="8" style="text-align:center;padding:16px;color:#666">No hay estudiantes registrados</td>`;
                    newTbody.appendChild(tr);
                    tbody.parentNode.replaceChild(newTbody, tbody);
                    return;
                }

                students.forEach((s, idx) => {
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-id', s.id || s.id_usuario || '');
                    
                    // Obtener grupos del estudiante
                    const estudianteGrupos = gruposMap.get(s.id_usuario) || [];
                    const grupoNames = estudianteGrupos.map(eg => {
                        if (eg.grupo && eg.grupo.nombre) {
                            return `${eg.grupo.nombre} (Grado ${eg.grupo.grado || ''})`;
                        }
                        return eg.idGrupo ? `Grupo ${eg.idGrupo}` : '';
                    }).filter(g => g).join(', ') || '-';
                    
                    // Obtener tutor del estudiante desde LocalStorage (temporal hasta que backend implemente)
                    const estudianteTutorKey = `estudiante_tutor_${s.id_usuario}`;
                    const idTutorGuardado = localStorage.getItem(estudianteTutorKey);
                    const tutor = idTutorGuardado ? tutoresMap.get(Number(idTutorGuardado)) : null;
                    const tutorName = tutor ? `${tutor.nombre} ${tutor.ape_p}`.trim() : '-';
                    
                    tr.innerHTML = `
                        <td>${idx+1}</td>
                        <td>${escapeHtml(s.nombre)}</td>
                        <td>${escapeHtml(s.ape_p)}</td>
                        <td>${escapeHtml(s.ape_m)}</td>
                        <td>${escapeHtml(s.curp||'')}</td>
                        <td>${escapeHtml(grupoNames)}</td>
                        <td>${escapeHtml(tutorName)}</td>
                        <td>
                            <button class="btn-editar"><img src="../../icons/visualizar.svg" alt="visualizar"/></button>
                            <button class="btn-eliminar"><img src="../../icons/eliminar.svg" alt="Eliminar"/></button>
                        </td>`;
                    newTbody.appendChild(tr);

                    const editBtn = tr.querySelector('.btn-editar');
                    editBtn.addEventListener('click', () => { window.location.href = 'editarestudiante.html?id=' + encodeURIComponent(s.id || s.id_usuario); });

                    const delBtn = tr.querySelector('.btn-eliminar');
                    delBtn.addEventListener('click', (e) => { e.preventDefault(); idToDelete = s.id || s.id_usuario; showDeleteModal(); });
                });

                tbody.parentNode.replaceChild(newTbody, tbody);
                setupSearch();
            }catch(err){ console.error('Error cargando estudiantes (enhancer)', err); }
        }

        // Setup search functionality
        function setupSearch(){
            const searchInput = document.getElementById('buscarDocente');
            if(!searchInput) return;
            
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const rows = document.querySelectorAll('.tabla-docentes tbody tr');
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if(cells.length === 0) return;
                    
                    // Buscar en nombre, apellidos, CURP, grupo y tutor (columnas 1-7)
                    const nombre = cells[1]?.textContent.toLowerCase() || '';
                    const apeP = cells[2]?.textContent.toLowerCase() || '';
                    const apeM = cells[3]?.textContent.toLowerCase() || '';
                    const curp = cells[4]?.textContent.toLowerCase() || '';
                    const grupo = cells[5]?.textContent.toLowerCase() || '';
                    const tutor = cells[6]?.textContent.toLowerCase() || '';
                    
                    const matches = nombre.includes(searchTerm) || 
                                  apeP.includes(searchTerm) || 
                                  apeM.includes(searchTerm) || 
                                  curp.includes(searchTerm) || 
                                  grupo.includes(searchTerm) ||
                                  tutor.includes(searchTerm);
                    
                    row.style.display = matches ? '' : 'none';
                });
            });
        }

        window.confirmDelete = async function(){
            try{
                closeDeleteModal();
                if(!idToDelete) return;
                await usuariosService.delete(Number(idToDelete));
                idToDelete = null;
                await loadAndRender();
                document.getElementById('delete-success-modal-overlay').style.display = 'flex';
            }catch(err){ console.error('Error eliminando estudiante (enhancer)', err); alert('Error eliminando: '+(err.message||err)); }
        };

        waitFor(['usuariosService', 'estudianteGrupoService', 'gruposService']).then(loadAndRender).catch(err => console.warn('No se cargaron los servicios:', err.message));
    })();
    </script>
    
    <nav class="sidebar" id="sidebar">
        <ul class="menu-list">
            <li><a href="../docentes/docente.html"><img class="icon" src="../../icons/docente.svg" alt=""><span class="text">Docentes</span></a></li>
            <li class="active"><a href="../estudiantes/estudiante.html"><img class="icon" src="../../icons/estudiante.svg" alt=""><span class="text">Estudiantes</span></a></li>
            <li><a href="../grupos/grupos.html"><img class="icon" src="../../icons/grupos.svg" alt=""><span class="text">Grupos</span></a></li>
            <li><a href="../asignaturas/asignatura.html"><img class="icon" src="../../icons/asignatura.svg" alt=""><span class="text">Asignaturas</span></a></li>
            <li><a href="../estadisticas/Estadisticadirector.html"><img class="icon" src="../../icons/estadisticas.svg" alt=""><span class="text">Estad√≠sticas</span></a></li>
        </ul>
    </nav>

    <main class="content" id="content">
            <section class="docentes-section">
            <h1 class="titulo">Estudiantes</h1>

            <div class="acciones-superiores">
                <div class="buscador-con-icono">
                    <img src="../../icons/buscador.svg" alt="Icono de buscador" class="icono-input" />
                    <input type="text" placeholder="Buscar" id="buscarDocente" />
                </div>

                <div class="agregar">
                    <label for="">Estudiante</label>
                    <button class="btn-agregar" onclick="window.location.href='agregarestudiante.html'">
                      <img src="../../icons/agregar.svg" alt="Icono agregar" class="icono-agregar"/>
                        Agregar
                    </button>
                </div>
            </div>

            <table class="tabla-docentes">
                <thead>
                    <tr>
                        <th>N¬∫</th>
                        <th>Nombre</th>
                        <th>Apellido Paterno</th>
                        <th>Apellido Materno</th>
                        <th>CURP</th>
                        <th>Grupo</th>
                        <th>Tutor</th>
                        <th class="th-acciones">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td>alejandra</td>
                        <td>vela</td>
                        <td>torrez</td>
                        <td>VETA850621MCSDRA9</td>
                        <td>A</td>
                        <td>
                            <button class="btn-editar" onclick="window.location.href='editarestudiante.html'"><img src="../../icons/visualizar.svg" alt="visualizar"/></button>
                            <button class="btn-eliminar" onclick="showDeleteModal()"><img src="../../icons/eliminar.svg" alt="Eliminar"/></button>
                        </td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Juan</td>
                        <td>P√©rez</td>
                        <td>Mart√≠nez</td>
                        <td>PEMJ030729MCSDRA9</td>
                        <td>A</td>
                        <td>
                            <button class="btn-editar" onclick="window.location.href='editarestudiante.html'"><img src="../../icons/visualizar.svg" alt="visualizar"/></button>
                            <button class="btn-eliminar" onclick="showDeleteModal()"><img src="../../icons/eliminar.svg" alt="Eliminar"/></button>
                        </td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Ana</td>
                        <td>Garc√≠a</td>
                        <td>Garcia</td>
                        <td>GAOA901110DREMCS9</td>
                        <td>A</td>
                        <td>
                            <button class="btn-editar" onclick="window.location.href='editarestudiante.html'"><img src="../../icons/visualizar.svg" alt="visualizar"/></button>
                            <button class="btn-eliminar" onclick="showDeleteModal()"><img src="../../icons/eliminar.svg" alt="Eliminar"/></button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>

<div id="delete-modal-overlay" class="modal-overlay">
    <div class="modal">
        <img src="../../icons/inforojo.svg" alt="eliminar" class="modal-icon">
        <h3>¬øDesea eliminarlo?</h3>
        <p>Estas acci√≥n es permanente y no podr√° deshacerse</p>
            <div class="modal-buttons">
            <button class="eliminar" onclick="window.confirmDelete()">Eliminar</button>
            <button class="cancel" onclick="closeDeleteModal()">Cancelar</button>
        </div>
    </div>
</div>

<div id="delete-success-modal-overlay" class="modal-overlay">
    <div class="modal">
        <img src="../../icons/successrojo.svg" alt="success" class="modal-icon">
        <h3>Eliminado correctamente</h3>
        <p>El registro que seleccionaste se elimino del sistema</p>
        <div class="modal-buttons">
            <button class="eliminar" onclick="closeDeleteSuccessModal()">Aceptar</button>
        </div>
    </div>
</div>

<script>
// Proteger esta p√°gina solo para admins
(function() {
    function waitForRouteGuard(roles) {
        if (typeof RouteGuard !== 'undefined') {
            RouteGuard.protect(roles);
        } else {
            setTimeout(function() { waitForRouteGuard(roles); }, 50);
        }
    }
    waitForRouteGuard(['admin']);
})();

function showDeleteModal() {
    document.getElementById('delete-modal-overlay').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('delete-modal-overlay').style.display = 'none';
}

function closeDeleteSuccessModal() {
    document.getElementById('delete-success-modal-overlay').style.display = 'none';
}

/* confirmDelete() implemented by enhancer and calls usuariosService.delete */

</script>
    </main>
    <script src="../../scripts/loadDependencies.js"></script>
</body>
</html>











