<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizar Estudiante</title>
    <link rel="stylesheet" href="../../css/Editar estudiante.css">
    <link rel="stylesheet" href="../../css/navbar.css">
</head>

<body>
    <header class="header">
        <div class="left-section">
            <h1 class="logo">SICALI</h1>
        </div>
        <div class="user-info">
            <div class="text-info">
                <div class="role" id="userRole">Cargando...</div>
                <div class="name" id="userName">Cargando...</div>
            </div>
            <div class="avatar"><img src="../../img/nino.png" alt=""></div>
        </div>
    </header>

    <script>
        (function() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userName = document.getElementById('userName');
                const userRole = document.getElementById('userRole');
                
                if (currentUser.nombre && currentUser.ape_p) {
                    const fullName = (currentUser.nombre + ' ' + currentUser.ape_p + ' ' + (currentUser.ape_m || '')).trim();
                    userName.textContent = fullName;
                } else {
                    userName.textContent = 'Usuario';
                }

                if (currentUser.rol) {
                    const rolCapitalizado = currentUser.rol.charAt(0).toUpperCase() + currentUser.rol.slice(1);
                    userRole.textContent = rolCapitalizado;
                } else {
                    userRole.textContent = 'Usuario';
                }
            } catch (error) {
                console.error('‚ùå Error al cargar datos del usuario:', error);
                document.getElementById('userName').textContent = 'Usuario';
                document.getElementById('userRole').textContent = 'Usuario';
            }
        })();
    </script>
    
    <nav class="sidebar" id="sidebar">
        <ul class="menu-list">
            <li><a href="../docentes/docente.html"><img class="icon" src="../../icons/docente.svg" alt=""><span class="text">Docentes</span></a></li>
            <li><a href="../tutor/tutor.html"><span class="icon"><img class="icon" src="../../icons/tutor.svg" alt=""></span><span class="text">Tutor</span></a></li>
            <li class="active"><a href="estudiante.html"><img class="icon" src="../../icons/estudiante.svg" alt=""><span class="text">Estudiantes</span></a></li>
            <li><a href="../grupos/grupos.html"><img class="icon" src="../../icons/grupos.svg" alt=""><span class="text">Grupos</span></a></li>
            <li><a href="../asignaturas/asignatura.html"><img class="icon" src="../../icons/asignatura.svg" alt=""><span class="text">Asignaturas</span></a></li>
            <li><a href="../estadisticas/Estadisticadirector.html"><img class="icon" src="../../icons/estadisticas.svg" alt=""><span class="text">Estad√≠sticas</span></a></li>
        </ul>
    </nav>

    <main class="content" id="content">
    <button type="button" class="back-link" aria-label="Volver atr√°s">
        <span class="icon"><img src="../../icons/atrass.svg" alt="Flecha atr√°s" /> </span>
        <span class="text">Atr√°s</span>
    </button>

    <section class="editar-estudiante">
        <h2>Estudiante</h2>

        <div class="form-contenedor">
            <div class="form-columna">
                <div class="form-group">
                    <label>Nombre:</label>
                    <input disabled type="text" id="nombre" placeholder="Cargando...">
                </div>

                <div class="form-group">
                    <label>Apellido Paterno:</label>
                    <input disabled type="text" id="ape_p" placeholder="Cargando...">
                </div>

                <div class="form-group">
                    <label>Apellido Materno:</label>
                    <input disabled type="text" id="ape_m" placeholder="Cargando...">
                </div>

                <div class="form-group">
                    <label>CURP:</label>
                    <input disabled type="text" id="curp" placeholder="Cargando...">
                </div>

                <div class="form-group">
                    <label>Sexo:</label>
                    <select disabled id="sexo">
                        <option value="">Seleccionar</option>
                        <option value="F">Femenino</option>
                        <option value="M">Masculino</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Fecha de Nacimiento:</label>
                    <input disabled type="date" id="fecha" placeholder="Cargando...">
                </div>

                <div class="form-group">
                    <label>Grupo:</label>
                    <select disabled id="grupo">
                        <option value="">Cargando...</option>
                    </select>
                </div>

                <div class="form-group" style="position: relative;">
                    <label>Contrase√±a:</label>
                    <input type="password" id="password" disabled placeholder="Cargando...">
                    <button type="button" id="togglePasswordBtn" style="position: absolute; right: 10px; top: 32px; background: none; border: none; cursor: pointer;">
                        <span class="iconpasswor"><img src="../../icons/visualizar password.svg" alt="Mostrar/Ocultar contrase√±a" /></span>
                    </button>
                </div>
            </div>
        </div>

        <div class="boton-agregar">
            <button type="button" onclick="navigateToSave()">
                <img src="../../icons/editar.svg" class="btn-icon" alt="Editar">
                Editar
            </button>
        </div>
    </section>

    <script src="../../scripts/loadDependencies.js"></script>

    <script>
        (function() {
            function waitForRouteGuard(roles) {
                if (typeof RouteGuard !== 'undefined') {
                    RouteGuard.protect(roles);
                } else {
                    setTimeout(function() { waitForRouteGuard(roles); }, 50);
                }
            }
            waitForRouteGuard(['director']);
        })();

        (function(){
            let dataLoaded = false;
            let savedFecha = null; // ‚úÖ Guardar fecha globalmente

            function getIdFromQuery(){ 
                const p = new URLSearchParams(location.search); 
                return p.get('id'); 
            }

            function navigateToSave(){ 
                const id = getIdFromQuery(); 
                window.location.href = 'guardarestudiante.html' + (id ? '?id=' + encodeURIComponent(id) : ''); 
            }

            function togglePassword() {
                const passwordInput = document.getElementById('password');
                if (passwordInput) {
                    passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
                }
            }

            // ‚úÖ FUNCI√ìN PARA VERIFICAR PERI√ìDICAMENTE
            function monitorFechaInput() {
                setInterval(function() {
                    const fechaInput = document.getElementById('fecha');
                    if (fechaInput && savedFecha && fechaInput.value !== savedFecha) {
                        console.warn('‚ö†Ô∏è FECHA BORRADA! Restaurando...', {
                            valorActual: fechaInput.value,
                            valorGuardado: savedFecha
                        });
                        fechaInput.value = savedFecha;
                    }
                }, 500);
            }

            async function loadEstudianteData() {
                if (dataLoaded) {
                    console.log('‚ö†Ô∏è Datos ya cargados, abortando...');
                    return;
                }
                dataLoaded = true;

                try {
                    const id = getIdFromQuery();
                    console.log('üìã ID desde query:', id);
                    
                    if (!id) {
                        alert('No se especific√≥ ID de estudiante');
                        window.location.href = 'estudiante.html';
                        return;
                    }

                    console.log('üîç Cargando datos del estudiante ID:', id);

                    const response = await usuariosService.getById(id);
                    console.log('üì¶ Respuesta RAW del servidor:', JSON.stringify(response, null, 2));
                    
                    const estudiante = response.data || response;
                    console.log('‚úÖ Estudiante procesado:', JSON.stringify(estudiante, null, 2));

                    // Llenar campos b√°sicos
                    document.getElementById('nombre').value = estudiante.nombre || '';
                    document.getElementById('ape_p').value = estudiante.ape_p || '';
                    document.getElementById('ape_m').value = estudiante.ape_m || '';
                    document.getElementById('curp').value = estudiante.curp || '';
                    document.getElementById('sexo').value = estudiante.sexo || '';
                    document.getElementById('password').value = estudiante.password || '';

                    // ‚úÖ MANEJO MEJORADO DE FECHA
                    const fechaInput = document.getElementById('fecha');
                    console.log('üîç Input fecha encontrado:', fechaInput);
                    console.log('üîç Input fecha ID:', fechaInput ? fechaInput.id : 'N/A');
                    console.log('üîç Input fecha disabled:', fechaInput ? fechaInput.disabled : 'N/A');
                    
                    console.log('üìÖ Fecha raw del servidor:', estudiante.fecha_nacimiento);
                    console.log('üìÖ Tipo de fecha:', typeof estudiante.fecha_nacimiento);
                    
                    if (estudiante.fecha_nacimiento) {
                        let fechaFormateada = '';
                        const fechaStr = String(estudiante.fecha_nacimiento);
                        
                        console.log('üìÖ Fecha como string:', fechaStr);
                        
                        if (fechaStr.indexOf('T') !== -1) {
                            fechaFormateada = fechaStr.split('T')[0];
                            console.log('üìÖ Usando formato ISO');
                        } else if (fechaStr.indexOf('-') !== -1) {
                            fechaFormateada = fechaStr.split(' ')[0];
                            console.log('üìÖ Usando formato simple');
                        } else {
                            const fecha = new Date(estudiante.fecha_nacimiento);
                            fechaFormateada = fecha.toISOString().split('T')[0];
                            console.log('üìÖ Usando formato Date');
                        }
                        
                        console.log('üìÖ Fecha FINAL formateada:', fechaFormateada);
                        
                        // ‚úÖ ASIGNAR Y GUARDAR
                        savedFecha = fechaFormateada;
                        fechaInput.value = fechaFormateada;
                        
                        console.log('‚úÖ Fecha asignada al input');
                        console.log('üîç Valor del input INMEDIATAMENTE despu√©s:', fechaInput.value);
                        
                        // ‚úÖ VERIFICAR DESPU√âS DE 100MS
                        setTimeout(function() {
                            console.log('üîç Valor del input despu√©s de 100ms:', fechaInput.value);
                            if (fechaInput.value !== fechaFormateada) {
                                console.error('‚ùå LA FECHA SE BORR√ì! Restaurando...');
                                fechaInput.value = fechaFormateada;
                            }
                        }, 100);
                        
                        // ‚úÖ VERIFICAR DESPU√âS DE 500MS
                        setTimeout(function() {
                            console.log('üîç Valor del input despu√©s de 500ms:', fechaInput.value);
                            if (fechaInput.value !== fechaFormateada) {
                                console.error('‚ùå LA FECHA SE BORR√ì OTRA VEZ! Restaurando...');
                                fechaInput.value = fechaFormateada;
                            }
                        }, 500);
                        
                        // ‚úÖ INICIAR MONITOREO
                        monitorFechaInput();
                        
                    } else {
                        console.warn('‚ö†Ô∏è No hay fecha_nacimiento en los datos');
                    }

                    // Cargar grupos
                    try {
                        const inscripciones = await estudianteGrupoService.getByEstudiante(id);
                        const grupoSelect = document.getElementById('grupo');
                        
                        if (inscripciones && inscripciones.length > 0) {
                            grupoSelect.innerHTML = '';
                            inscripciones.forEach(function(insc) {
                                const option = document.createElement('option');
                                const grupo = insc.grupo;
                                option.value = grupo.idGrupo;
                                option.textContent = grupo.nombre + ' - Grado ' + (grupo.grado || '');
                                grupoSelect.appendChild(option);
                            });
                            console.log('‚úÖ Grupos cargados:', inscripciones.length);
                        } else {
                            grupoSelect.innerHTML = '<option value="">Sin grupo asignado</option>';
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error cargando grupos:', error);
                        document.getElementById('grupo').innerHTML = '<option value="">Error al cargar grupos</option>';
                    }

                    console.log('‚úÖ CARGA COMPLETA');

                } catch (error) {
                    console.error('‚ùå Error cargando datos:', error);
                    console.error('Stack:', error.stack);
                    alert('Error al cargar datos del estudiante: ' + error.message);
                    dataLoaded = false;
                }
            }

            // Event listeners
            const backLink = document.querySelector(".back-link");
            if (backLink) {
                backLink.addEventListener("click", function () {
                    window.history.back();
                });
            }

            const togglePasswordBtn = document.getElementById('togglePasswordBtn');
            if (togglePasswordBtn) {
                togglePasswordBtn.addEventListener('click', togglePassword);
            }

            window.togglePassword = togglePassword;
            window.navigateToSave = navigateToSave;

            function checkServicesAndLoad() {
                if (dataLoaded) {
                    console.log('‚ö†Ô∏è checkServicesAndLoad: datos ya cargados');
                    return;
                }
                
                if (typeof usuariosService !== 'undefined' && 
                    typeof gruposService !== 'undefined' && 
                    typeof estudianteGrupoService !== 'undefined') {
                    console.log('‚úÖ Servicios disponibles, cargando datos...');
                    loadEstudianteData();
                } else {
                    console.log('‚è≥ Esperando servicios...');
                    setTimeout(checkServicesAndLoad, 100);
                }
            }
            
            checkServicesAndLoad();
        })();
    </script>

    <script src="../../scripts/utils/logoutModal.js"></script>
    </main>
</body>
</html>