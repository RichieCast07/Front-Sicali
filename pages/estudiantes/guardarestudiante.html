<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Estudiante</title>
    <link rel="stylesheet" href="../../css/Editar estudiante.css">
    <link rel="stylesheet" href="../../css/navbar.css">
    <link rel="stylesheet" href="../../css/modalactualizar.css">
</head>

<body>
    <header class="header">
        <div class="left-section">
            <h1 class="logo">SICALI</h1>
        </div>
        <div class="user-info">
            <div class="text-info">
                <div class="role" id="userRole">Cargando...</div>
                <div class="name" id="userName">Cargando...</div>
            </div>
            <div class="avatar"><img src="../../img/nino.png" alt=""></div>
        </div>
    </header>

    <script>
        // ==========================================
        // CARGAR INFORMACI√ìN DEL USUARIO DIN√ÅMICAMENTE
        // ==========================================
        (function() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userName = document.getElementById('userName');
                const userRole = document.getElementById('userRole');
                
                if (currentUser.nombre && currentUser.ape_p) {
                    const fullName = (currentUser.nombre + ' ' + currentUser.ape_p + ' ' + (currentUser.ape_m || '')).trim();
                    userName.textContent = fullName;
                } else {
                    userName.textContent = 'Usuario';
                }

                if (currentUser.rol) {
                    const rolCapitalizado = currentUser.rol.charAt(0).toUpperCase() + currentUser.rol.slice(1);
                    userRole.textContent = rolCapitalizado;
                } else {
                    userRole.textContent = 'Usuario';
                }

                console.log('‚úÖ Usuario cargado:', {
                    nombre: userName.textContent,
                    rol: userRole.textContent,
                    id: currentUser.id_usuario
                });

            } catch (error) {
                console.error('‚ùå Error al cargar datos del usuario:', error);
                document.getElementById('userName').textContent = 'Usuario';
                document.getElementById('userRole').textContent = 'Usuario';
            }
        })();
    </script>
    
    <nav class="sidebar" id="sidebar">
        <ul class="menu-list">
            <li><a href="../docentes/docente.html"><img class="icon" src="../../icons/docente.svg" alt=""><span class="text">Docentes</span></a></li>
            <li><a href="../tutor/tutor.html"><span class="icon"><img class="icon" src="../../icons/tutor.svg" alt=""></span><span class="text">Tutor</span></a></li>
            <li class="active"><a href="estudiante.html"><img class="icon" src="../../icons/estudiante.svg" alt=""><span class="text">Estudiantes</span></a></li>
            <li><a href="../grupos/grupos.html"><img class="icon" src="../../icons/grupos.svg" alt=""><span class="text">Grupos</span></a></li>
            <li><a href="../asignaturas/asignatura.html"><img class="icon" src="../../icons/asignatura.svg" alt=""><span class="text">Asignaturas</span></a></li>
            <li><a href="../estadisticas/Estadisticadirector.html"><img class="icon" src="../../icons/estadisticas.svg" alt=""><span class="text">Estad√≠sticas</span></a></li>
        </ul>
    </nav>

    <main class="content" id="content">
    <button type="button" class="back-link" aria-label="Volver atr√°s">
        <span class="icon"><img src="../../icons/atrass.svg" alt="Flecha atr√°s" /> </span>
        <span class="text">Atr√°s</span>
    </button>

    <section class="editar-estudiante">
        <h2>Estudiante</h2>

        <div class="form-contenedor">
            <div class="form-columna">
                <div class="form-group">
                    <label>Nombre:</label>
                    <input type="text" id="nombre" placeholder="Ingrese nombre">
                </div>

                <div class="form-group">
                    <label>Apellido Paterno:</label>
                    <input type="text" id="ape_p" placeholder="Ingrese apellido paterno">
                </div>

                <div class="form-group">
                    <label>Apellido Materno:</label>
                    <input type="text" id="ape_m" placeholder="Ingrese apellido materno">
                </div>

                <div class="form-group">
                    <label>CURP:</label>
                    <input type="text" id="curp" placeholder="Ingrese CURP" maxlength="18">
                </div>

                <div class="form-group">
                    <label>Sexo:</label>
                    <select id="sexo">
                        <option value="">Seleccionar</option>
                        <option value="F">Femenino</option>
                        <option value="M">Masculino</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Fecha de Nacimiento:</label>
                    <input type="date" id="fecha_nacimiento">
                </div>

                <div class="form-group">
                    <label>Grupo:</label>
                    <select id="grupoSelect">
                        <option value="">Cargando grupos...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Usuario:</label>
                    <input type="text" id="usuario" placeholder="Ingrese usuario">
                </div>

                <div class="form-group" style="position: relative;">
                    <label>Contrase√±a:</label>
                    <input type="password" id="password" placeholder="Ingrese contrase√±a">
                    <button type="button" id="togglePasswordBtn" style="position: absolute; right: 10px; top: 32px; background: none; border: none; cursor: pointer;">
                        <span class="iconpasswor"><img src="../../icons/visualizar password.svg" alt="Mostrar/Ocultar contrase√±a" /></span>
                    </button>
                </div>
            </div>
        </div>

        <div class="boton-agregar">
            <button type="button" onclick="showModal()">
                <img src="../../icons/guardar.svg" class="btn-icon" alt="Guardar">
                Guardar
            </button>
        </div>
    </section>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <img src="../../icons/info.svg" alt="info" class="modal-icon">
            <h3>¬øDesea Actualizarlo?</h3>
            <p>Los datos actuales ser√°n reemplazados por la nueva informaci√≥n</p>
            <div class="modal-buttons">
                <button class="confirm" onclick="confirmSave()">Guardar</button>
                <button class="cancel" onclick="closeModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="success-modal-overlay" class="modal-overlay"> 
        <div class="modal">
            <img src="../../icons/success.svg" alt="success" class="modal-icon">
            <h3>Actualizado Correctamente</h3>
            <p>Se actualiz√≥ la informaci√≥n existente</p>
            <div class="modal-buttons">
                <button class="confirm" onclick="closeSuccessModal()">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Cargar dependencias primero -->
    <script src="../../scripts/loadDependencies.js"></script>

    <script>
    // Proteger esta p√°gina solo para directores
    (function() {
        function waitForRouteGuard(roles) {
            if (typeof RouteGuard !== 'undefined') {
                RouteGuard.protect(roles);
            } else {
                setTimeout(function() { waitForRouteGuard(roles); }, 50);
            }
        }
        waitForRouteGuard(['director']);
    })();

    // ==========================================
    // FUNCIONES DE MODALES
    // ==========================================
    function showModal() {
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
    }

    function closeSuccessModal() {
        document.getElementById('success-modal-overlay').style.display = 'none';
        window.location.href = 'estudiante.html';
    }

    // ==========================================
    // TOGGLE PASSWORD
    // ==========================================
    function togglePassword() {
        const passwordInput = document.getElementById('password');
        if (passwordInput) {
            passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
        }
    }

    // Event listener para toggle password
    const togglePasswordBtn = document.getElementById('togglePasswordBtn');
    if (togglePasswordBtn) {
        togglePasswordBtn.addEventListener('click', togglePassword);
    }

    // ==========================================
    // GUARDAR ESTUDIANTE
    // ==========================================
    function confirmSave() {
        (async function(){
            try {
                closeModal();
                
                const nombre = document.getElementById('nombre').value.trim();
                const ape_p = document.getElementById('ape_p').value.trim();
                const ape_m = document.getElementById('ape_m').value.trim();
                const curp = document.getElementById('curp').value.trim();
                const sexo = document.getElementById('sexo').value;
                const fecha_nacimiento = document.getElementById('fecha_nacimiento').value;
                const grupoSelect = document.getElementById('grupoSelect');
                const nuevoGrupoId = grupoSelect ? Number(grupoSelect.value) || null : null;
                const usuarioVal = document.getElementById('usuario').value.trim();
                const passwordVal = document.getElementById('password').value;

                // Validaciones
                if (!nombre || !ape_p) {
                    alert('Nombre y apellido paterno son obligatorios');
                    return;
                }

                // Derivar RFC del CURP
                const rfc = curp ? curp.toUpperCase().substr(0, 13) : '';

                const payload = {
                    nombre: nombre,
                    ape_p: ape_p,
                    ape_m: ape_m || '',
                    curp: curp || '',
                    rfc: rfc,
                    sexo: sexo || '',
                    fecha_nacimiento: fecha_nacimiento || null,
                    usuario: usuarioVal,
                    password: passwordVal || 'ChangeMe123',
                    rol: 'estudiante',
                    estado: 'Activo'
                };

                console.log('üì¶ Payload a enviar:', payload);

                const id = (new URLSearchParams(location.search)).get('id');
                let estudianteId;
                
                if (id) {
                    // Actualizar estudiante existente
                    payload.id_usuario = Number(id);
                    await usuariosService.update(Number(id), payload);
                    estudianteId = Number(id);
                    console.log('‚úÖ Estudiante actualizado');
                } else {
                    // Crear nuevo estudiante
                    const nuevoEstudiante = await usuariosService.create(payload);
                    estudianteId = nuevoEstudiante.id_usuario || nuevoEstudiante.id;
                    console.log('‚úÖ Estudiante creado con ID:', estudianteId);
                }

                // ==========================================
                // MANEJO DE CAMBIO DE GRUPO
                // ==========================================
                if (nuevoGrupoId && estudianteId) {
                    try {
                        // Obtener inscripciones actuales del estudiante
                        console.log('üîç Buscando inscripciones actuales del estudiante...');
                        const inscripcionesActuales = await estudianteGrupoService.getByEstudiante(Number(estudianteId));
                        
                        // Filtrar inscripciones activas
                        const inscripcionesActivas = Array.isArray(inscripcionesActuales) 
                            ? inscripcionesActuales.filter(ins => ins.estado === 'Activo')
                            : (inscripcionesActuales && inscripcionesActuales.estado === 'Activo' ? [inscripcionesActuales] : []);
                        
                        console.log('üìä Inscripciones activas encontradas:', inscripcionesActivas.length);

                        // Si hay una inscripci√≥n activa anterior, eliminarla
                        if (inscripcionesActivas.length > 0) {
                            const grupoAnterior = inscripcionesActivas[0].grupo;
                            const idGrupoAnterior = grupoAnterior.idGrupo || grupoAnterior.id;
                            
                            // Solo eliminar si es diferente del nuevo grupo
                            if (idGrupoAnterior !== nuevoGrupoId) {
                                console.log('üóëÔ∏è Eliminando inscripci√≥n anterior en grupo:', idGrupoAnterior);
                                await estudianteGrupoService.delete(Number(estudianteId), idGrupoAnterior);
                                console.log('‚úÖ Inscripci√≥n anterior eliminada');
                            } else {
                                console.log('‚ÑπÔ∏è El estudiante ya est√° en el grupo seleccionado');
                            }
                        }

                        // Crear nueva inscripci√≥n si no existe o fue eliminada
                        const inscripcionesFinales = await estudianteGrupoService.getByEstudiante(Number(estudianteId));
                        const enNuevoGrupo = Array.isArray(inscripcionesFinales) 
                            ? inscripcionesFinales.some(ins => (ins.grupo.idGrupo || ins.grupo.id) === nuevoGrupoId && ins.estado === 'Activo')
                            : false;

                        if (!enNuevoGrupo) {
                            console.log('üìù Creando inscripci√≥n en nuevo grupo:', nuevoGrupoId);
                            const nuevaInscripcion = {
                                idEstudiante: estudianteId,
                                idGrupo: nuevoGrupoId,
                                fechaInscripcion: new Date().toISOString().split('T')[0],
                                estado: 'Activo'
                            };
                            
                            await estudianteGrupoService.create(nuevaInscripcion);
                            console.log('‚úÖ Inscripci√≥n en nuevo grupo creada exitosamente');
                        } else {
                            console.log('‚ÑπÔ∏è El estudiante ya tiene una inscripci√≥n activa en este grupo');
                        }
                        
                    } catch (inscErr) {
                        console.error('‚ùå Error al gestionar inscripci√≥n en grupo:', inscErr);
                        console.error('Detalles del error:', inscErr.message);
                        alert('Advertencia: El estudiante fue guardado pero hubo un error al asignarlo al grupo:\n' + inscErr.message);
                    }
                } else if (!nuevoGrupoId && id) {
                    // Si no se seleccion√≥ grupo pero es actualizaci√≥n, verificar si eliminar grupo anterior
                    console.log('‚ö†Ô∏è No se seleccion√≥ grupo para el estudiante');
                }

                console.log('‚úÖ Proceso completado exitosamente');
                document.getElementById('success-modal-overlay').style.display = 'flex';
                
            } catch (err) {
                console.error('‚ùå Error guardando estudiante:', err);
                console.error('Tipo de error:', err.constructor.name);
                alert('Error: ' + (err.message || err));
            }
        })();
    }

    // ==========================================
    // BOT√ìN ATR√ÅS
    // ==========================================
    document.querySelector(".back-link").addEventListener("click", function () {
        window.history.back();
    });

    // ==========================================
    // CARGAR DATOS DEL ESTUDIANTE
    // ==========================================
    (function(){
        function isReady(name) {
            try {
                return typeof eval(name) !== 'undefined';
            } catch(e) {
                return false;
            }
        }
        
        function waitFor(names, timeout) {
            timeout = timeout || 5000;
            return new Promise(function(resolve, reject) {
                const start = Date.now();
                (function poll() {
                    if (names.every(isReady)) return resolve();
                    if (Date.now() - start > timeout) return reject(new Error('Servicios no disponibles'));
                    setTimeout(poll, 50);
                })();
            });
        }
        
        async function loadGrupos() {
            try {
                const grupoSelect = document.getElementById('grupoSelect');
                if (!grupoSelect) return;
                
                grupoSelect.innerHTML = '<option value="">Cargando grupos...</option>';
                
                const grupos = await gruposService.getAll();
                const gruposArray = Array.isArray(grupos) ? grupos : (grupos ? [grupos] : []);
                
                grupoSelect.innerHTML = '<option value="">Seleccionar grupo</option>';
                gruposArray.forEach(function(g) {
                    const opt = document.createElement('option');
                    opt.value = g.idGrupo || g.id || '';
                    opt.textContent = (g.nombre || '') + ' (Grado ' + (g.grado || '') + ')';
                    grupoSelect.appendChild(opt);
                });
                
                console.log('‚úÖ Grupos cargados:', gruposArray.length);
            } catch (err) {
                console.error('‚ùå Error cargando grupos:', err);
                const grupoSelect = document.getElementById('grupoSelect');
                if (grupoSelect) grupoSelect.innerHTML = '<option value="">Error al cargar grupos</option>';
            }
        }
        
        waitFor(['usuariosService', 'gruposService', 'estudianteGrupoService']).then(async function() {
            console.log('‚úÖ Servicios cargados');
            
            // Cargar grupos primero
            await loadGrupos();
            
            const id = (new URLSearchParams(location.search)).get('id');
            if (!id) {
                console.log('‚ÑπÔ∏è Modo creaci√≥n (sin ID)');
                return;
            }
            
            try {
                console.log('üîç Cargando estudiante ID:', id);
                const response = await usuariosService.getById(Number(id));
                const u = response.data || response;
                
                if (!u) {
                    console.warn('‚ö†Ô∏è No se encontr√≥ el estudiante');
                    return;
                }
                
                console.log('‚úÖ Estudiante cargado:', u);
                
                // Llenar campos
                document.getElementById('nombre').value = u.nombre || '';
                document.getElementById('ape_p').value = u.ape_p || '';
                document.getElementById('ape_m').value = u.ape_m || '';
                document.getElementById('curp').value = u.curp || '';
                document.getElementById('sexo').value = u.sexo || '';
                document.getElementById('usuario').value = u.usuario || '';
                document.getElementById('password').value = u.password || '';
                
                // ‚úÖ CARGAR FECHA
                if (u.fecha_nacimiento) {
                    let fechaFormateada = '';
                    const fechaStr = String(u.fecha_nacimiento);
                    
                    if (fechaStr.indexOf('T') !== -1) {
                        fechaFormateada = fechaStr.split('T')[0];
                    } else if (fechaStr.indexOf('-') !== -1) {
                        fechaFormateada = fechaStr.split(' ')[0];
                    } else {
                        const fecha = new Date(u.fecha_nacimiento);
                        fechaFormateada = fecha.toISOString().split('T')[0];
                    }
                    
                    document.getElementById('fecha_nacimiento').value = fechaFormateada;
                    console.log('üìÖ Fecha cargada:', fechaFormateada);
                } else {
                    console.warn('‚ö†Ô∏è Este estudiante no tiene fecha de nacimiento registrada');
                }
                
                // Cargar grupo si existe
                try {
                    const inscripciones = await estudianteGrupoService.getByEstudiante(Number(id));
                    const grupoSelect = document.getElementById('grupoSelect');
                    
                    if (inscripciones && inscripciones.length > 0) {
                        const primerGrupo = inscripciones[0].grupo;
                        const grupoId = primerGrupo.idGrupo || primerGrupo.id;
                        if (grupoSelect && grupoId) {
                            grupoSelect.value = grupoId;
                            console.log('‚úÖ Grupo seleccionado:', grupoId);
                        }
                    }
                } catch (grupoErr) {
                    console.warn('‚ö†Ô∏è No se pudieron cargar los grupos del estudiante:', grupoErr);
                }
                
                console.log('‚úÖ Datos cargados exitosamente');
                
            } catch(e) {
                console.error('‚ùå Error cargando estudiante:', e);
                alert('Error al cargar datos del estudiante: ' + e.message);
            }
        }).catch(function(err) {
            console.error('‚ùå Error esperando servicios:', err);
        });
    })();
    </script>

    <script src="../../scripts/utils/logoutModal.js"></script>
    </main>
</body>
</html>